<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cr√©ateur d'overlay ‚Äî Akatsuki Orga</title>

  <style>
    :root{
      --bg: #07060a;

      --red: rgba(255, 60, 90, 1);
      --red2: rgba(255, 100, 140, 1);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);

      --menu: rgba(0,0,0,.22);
      --menu2: rgba(0,0,0,.12);
      --strokeRed: rgba(255, 60, 90, .40);

      --shadow: 0 18px 40px rgba(0,0,0,.45);
      --r: 22px;

      --cols: 5;
      --rows: 3;
      --gap: 26px;
      --cellSize: 150px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 500px at 70% 15%, rgba(255,60,90,.18), transparent 60%),
        radial-gradient(900px 500px at 20% 75%, rgba(255,255,255,.06), transparent 60%),
        var(--bg);
    }

    .app{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
      padding: 18px;
      max-width: 1500px;
      margin: 0 auto;
    }
    @media (max-width: 980px){ .app{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(180deg, var(--menu), var(--menu2));
      border: 1px solid var(--strokeRed);
      border-radius: 24px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sidebar{
      padding: 16px;
      position: sticky;
      top: 16px;
      height: fit-content;
    }

    .title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .title h1{
      font-size: 15px;
      line-height: 1.25;
      margin:0;
      letter-spacing:.2px;
    }
    .badge{
      font-size: 12px;
      color: rgba(255,255,255,.82);
      background: rgba(255,60,90,.12);
      border: 1px solid rgba(255,60,90,.35);
      padding: 6px 10px;
      border-radius: 999px;
      box-shadow: 0 0 0 3px rgba(255,60,90,.08);
      white-space:nowrap;
    }

    .section{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    .btn:hover{
      background: rgba(0,0,0,.28);
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(180deg, rgba(255,60,90,.22), rgba(255,60,90,.10));
      border-color: rgba(255,60,90,.38);
      box-shadow: 0 0 0 3px rgba(255,60,90,.10);
    }
    .btn.danger{
      background: rgba(255,60,90,.12);
      border-color: rgba(255,60,90,.30);
    }

    input[type="file"]{
      width: 100%;
      padding: 10px;
      background: rgba(0,0,0,.18);
      border: 1px dashed rgba(255,255,255,.20);
      border-radius: 14px;
      color: rgba(255,255,255,.70);
    }
    input[type="range"]{ width: 100%; }

    select{
      width: 100%;
      padding: 10px 12px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,60,90,.28);
      border-radius: 14px;
      color: var(--text);
      outline:none;
      box-shadow: 0 0 0 3px rgba(255,60,90,.08);
      font-weight: 800;
    }

    .hint{
      font-size: 12px;
      color: rgba(255,255,255,.72);
      line-height: 1.35;
      margin-top: 8px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New";
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,60,90,.30);
      background: rgba(255,60,90,.10);
      color: rgba(255,255,255,.88);
    }

    .giftPreview{
      margin-top: 10px;
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    .giftPreview .thumb{
      width: 54px;
      height: 54px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .giftPreview img{
      width: 70%;
      height: 70%;
      object-fit: contain;
      filter: drop-shadow(0 12px 14px rgba(0,0,0,.45));
    }
    .giftPreview .meta{ display:flex; flex-direction:column; gap: 2px; }
    .giftPreview .meta .name{ font-weight: 950; font-size: 13px; }
    .giftPreview .meta .sub{ font-size: 12px; color: rgba(255,255,255,.70); }

    .main{
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 14px;
      min-height: calc(100vh - 36px);
    }
    .stage-wrap{ display:flex; flex-direction:column; gap: 10px; }
    .stage-toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .footer-note{
      font-size: 12px;
      color: rgba(255,255,255,.75);
      opacity:.98;
    }

    .stage{
      position:relative;
      border-radius: 0px;
      border: 1px solid rgba(255,60,90,.24);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: rgba(0,0,0,.25);
      width: 100%;
      aspect-ratio: 16 / 9;
      min-height: 360px;
    }

    .bgLayer{
      position:absolute; inset:0;
      overflow:hidden;
    }
    .bgLayer img,
    .bgLayer video{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      filter: saturate(1.06) contrast(1.03);
    }

    .vignette{
      position:absolute; inset:0;
      background:
        radial-gradient(1200px 700px at 50% 35%, transparent 48%, rgba(0,0,0,.45) 100%),
        linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,.08));
      pointer-events:none;
    }

    /* ‚úÖ GRID */
    .grid{
      position:absolute;
      inset: 40px;
      display:grid;
      align-content:center;
      justify-content:center;
      gap: var(--gap);
      grid-template-columns: repeat(var(--cols), var(--cellSize));
    }
    @media (max-width: 980px){ .grid{ inset: 18px; } }

    .tile{
      width: var(--cellSize);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap: 10px;
      user-select:none;
    }

    /* ‚úÖ NEON PANEL (pas de blur CSS) */
    .cell{
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: var(--r);
      position:relative;
      overflow:hidden;
      cursor:pointer;

      background:
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.28));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow:
        0 18px 34px rgba(0,0,0,.45),
        0 0 0 1px rgba(255,60,90,.10) inset;
    }

    /* Halo / glow */
    .cell::before{
      content:"";
      position:absolute; inset:-18px;
      background: radial-gradient(120px 120px at 30% 25%, rgba(255,60,90,.18), transparent 65%),
                  radial-gradient(120px 120px at 70% 75%, rgba(255,255,255,.10), transparent 60%);
      opacity: .95;
      pointer-events:none;
      filter: blur(2px);
    }

    /* Motif diagonal tr√®s l√©ger */
    .cell::after{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(135deg,
          rgba(255,255,255,.06) 0px,
          rgba(255,255,255,.06) 4px,
          rgba(255,255,255,0) 4px,
          rgba(255,255,255,0) 14px);
      opacity: .35;
      pointer-events:none;
      mix-blend-mode: overlay;
    }

    /* Cadre n√©on via un overlay interne */
    .neonFrame{
      position:absolute; inset:0;
      border-radius: var(--r);
      pointer-events:none;
      box-shadow:
        inset 0 0 0 2px rgba(255,60,90,.28),
        inset 0 0 0 1px rgba(255,255,255,.12),
        0 0 18px rgba(255,60,90,.12);
    }

    /* Petite lumi√®re en haut */
    .topShine{
      position:absolute; left:-20%; top:-40%;
      width: 140%;
      height: 70%;
      background: radial-gradient(closest-side, rgba(255,255,255,.16), transparent 72%);
      transform: rotate(6deg);
      opacity: .65;
      pointer-events:none;
    }

    .cell:hover{
      border-color: rgba(255,60,90,.28);
      box-shadow:
        0 18px 34px rgba(0,0,0,.45),
        0 0 0 3px rgba(255,60,90,.10);
    }

    .cell .giftInCell{
      position:absolute; inset: 16%;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index: 3;
    }
    .cell .giftInCell img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 18px 18px rgba(0,0,0,.55));
    }

    .cell .empty{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      color: rgba(255,255,255,.65);
      pointer-events:none;
      text-align:center;
      padding: 10px;
      text-shadow: 0 6px 18px rgba(0,0,0,.65);
      z-index: 3;
    }

    /* Label */
    .cellLabel{
      width: 100%;
      text-align:center;
      font-weight: 1000;
      letter-spacing: .6px;
      line-height: 1.05;
      text-transform: uppercase;

      font-size: 16px;
      color: rgba(255,255,255,.96);
      text-shadow:
        0 4px 0 rgba(0,0,0,.60),
        0 10px 18px rgba(0,0,0,.55);

      -webkit-text-stroke: 3px rgba(0,0,0,.92);
      paint-order: stroke fill;

      min-height: 2.4em;
      display:flex;
      align-items:flex-start;
      justify-content:center;

      padding: 0 6px;
      word-break: break-word;
      position: relative;
    }
    .cellLabel.is-empty{
      color: transparent;
      -webkit-text-stroke: 0px transparent;
      text-shadow: none;
    }

    /* ‚úÖ AIDE D'√âDITION (visible √©cran / invisible export) */
    body:not(.exporting) .cellLabel::before{
      content:"";
      position:absolute;
      inset: -8px -10px;
      border-radius: 14px;
      border: 2px dashed rgba(255,255,255,.45);
      background: rgba(0,0,0,.28);
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
      pointer-events:none;
    }
    body:not(.exporting) .cellLabel.is-empty::after{
      content:"‚úçÔ∏è √âCRIRE ICI";
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      letter-spacing: .6px;
      color: rgba(255,255,255,.70);
      text-shadow: 0 2px 10px rgba(0,0,0,.55);
      -webkit-text-stroke: 0;
      pointer-events:none;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <div class="card sidebar">
      <div class="title">
        <h1>Cr√©ateur d'overlay ‚Äî Akatsuki Orga.</h1>
        <div class="badge">‚òÅÔ∏èü©∏ Akatsuki</div>
      </div>

      <div class="section">
        <label>üñºÔ∏è 1) Fond (image ou vid√©o)</label>
        <div class="row" style="width:100%">
          <div style="flex:1; min-width:160px;">
            <label style="margin-bottom:6px;">Image</label>
            <input id="bgImageInput" type="file" accept="image/*" />
          </div>
          <div style="flex:1; min-width:160px;">
            <label style="margin-bottom:6px;">Vid√©o</label>
            <input id="bgVideoInput" type="file" accept="video/*" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="clearBg">Retirer le fond</button>
          <button class="btn" id="toggleVideo">‚èØÔ∏è Vid√©o</button>
          <button class="btn" id="muteVideo">üîá</button>
        </div>

        <div class="hint">
          ‚úÖ Vid√©o OK (overlay dynamique). Export PNG = capture de la frame actuelle.
        </div>
      </div>

      <div class="section">
        <label>üéÅ 2) Choisir un cadeau</label>
        <select id="giftSelect"></select>

        <div class="giftPreview">
          <div class="thumb" id="giftThumb"></div>
          <div class="meta">
            <div class="name" id="giftName">Aucun cadeau s√©lectionn√©</div>
            <div class="sub">Clique une case ‚Ä¢ <span class="kbd">Double-clic</span> = retirer</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="deselect">D√©s√©lectionner</button>
        </div>
      </div>

      <div class="section">
        <label>‚öôÔ∏è 3) R√©glages</label>

        <label style="margin-top:8px;">Disposition</label>
        <select id="layout">
          <option value="3x2">3 √ó 2 (6)</option>
          <option value="5x2">5 √ó 2 (10)</option>
          <option value="5x3" selected>5 √ó 3 (15)</option>
          <option value="6x3">6 √ó 3 (18)</option>
        </select>

        <div style="margin-top:12px;">
          <label>‚≠ï Arrondi : <span id="roundVal">22</span>px</label>
          <input id="round" type="range" min="8" max="40" value="22" />
        </div>

        <div style="margin-top:12px;">
          <label>‚ÜîÔ∏è Gap : <span id="gapVal">26</span>px</label>
          <input id="gap" type="range" min="12" max="40" value="26" />
        </div>

        <div class="hint">
          ‚úçÔ∏è Texte : <span class="kbd">clic droit</span> (ou <span class="kbd">Ctrl</span>+clic) sur une case.
        </div>
      </div>

      <div class="section">
        <label>üñ®Ô∏è 4) Export</label>

        <label style="margin-top:8px;">R√©solution</label>
        <select id="exportRes">
          <option value="1920x1080" selected>1920√ó1080 (1080p)</option>
          <option value="2560x1440">2560√ó1440 (1440p)</option>
          <option value="3840x2160">3840√ó2160 (4K)</option>
        </select>

        <div class="row" style="margin-top:10px;">
          <button class="btn danger" id="resetGrid">Vider toutes les cases</button>
          <button class="btn primary" id="exportPng">Exporter en PNG</button>
        </div>

        <div class="hint">
          ‚úÖ Export propre (canvas renderer). Aucun html2canvas. Aucun bug de filtre.
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <div class="stage-wrap">
        <div class="stage-toolbar">
          <div class="footer-note">
            ‚òÅÔ∏èü©∏ Cadeau : clique une case ‚Ä¢ <span class="kbd">Double-clic</span> supprime ‚Ä¢
            ‚úçÔ∏è Texte : <span class="kbd">clic droit</span> (ou <span class="kbd">Ctrl</span>+clic)
          </div>
        </div>

        <div class="stage" id="stage">
          <div class="bgLayer">
            <img id="bgImg" alt="" style="display:none;">
            <video id="bgVid" style="display:none;" playsinline loop></video>
          </div>

          <div class="vignette"></div>
          <div class="grid" id="grid"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ‚úÖ LISTE COMPL√àTE (celle de ton message)
    const GIFTS = [
      { name: "9 queues ü™ô 1800", file: "9 queues.png" },
      { name: "2026 ü™ô 1", file: "2026.png" },
      { name: "je t'adore ü™ô 1", file: "adore.png" },
      { name: "Aile de papillon ü™ô 399", file: "Aile de papillon.png" },
      { name: "ailes f√©e ü™ô 1", file: "ailesfee.png" },
      { name: "Bo√Ætes de largage ü™ô 999 ", file: "Air drop.png" },
      { name: "Ami Fruit√©s ü™ô 299", file: "Ami Fruit√©s.png" },
      { name: "amour langue signe ü™ô 49", file: "amourlanguesigne.png" },
      { name: "Animaux en sc√®ne ü™ô 2500", file: "Animal Band.png" },
      { name: "Arbre √† diamants ü™ô 1088", file: "Arbre √† diamants.png" },
      { name: "arc amour ü™ô 99", file: "arcamour.png" },
      { name: "arc en ciel ü™ô 1", file: "arcenciel.png" },
      { name: "bagel ü™ô 35", file: "bagel.png" },
      { name: "Singe Encourageant ü™ô 349", file: "baking monkey.png" },
      { name: "Plong√©e Baleine ü™ô 2150", file: "Baleine.png" },
      { name: "ballon coeur ü™ô 150", file: "ballonamour.png" },
      { name: "Stand des Amoureux ü™ô 2199", file: "Bar √† citron.png" },
      { name: "basketball ü™ô 1", file: "basketball.png" },
      { name: "Batterie ü™ô 1000", file: "Batterie.png" },
      { name: "Ours Surfeur ü™ô 800", file: "Bear Blind Box.Png" },
      { name: "Devenir un Chaton ü™ô 349", file: "Become Kitten.png" },
      { name: "Benny B√©b√© Rhino ü™ô 4999", file: "Berry.png" },
      { name: "Bisous Loutre ü™ô 399", file: "Bisous Loutre.png" },
      { name: "bisous ü™ô 1", file: "bisous.png" },
      { name: "bubblegum ü™ô 99", file: "bubblegum.png" },
      { name: "calin de teddy ü™ô 399", file: "calin de teddy.png" },
      { name: "Camion de glace ü™ô 2988", file: "Camion de glace.png" },
      { name: "Capybara ü™ô 30", file: "capybara.png" },
      { name: "Carrousel ü™ô 1999", file: "Carrousel.png" },
      { name: "Carte de Voeux ü™ô 1500", file: "carte de voeux.png" },
      { name: "Casquette ü™ô 99", file: "Casquette.png" },
      { name: "Chaise Gaming ü™ô 1200", file: "Chaise Gaming.png" },
      { name: "chapeau moustache ü™ô 99", file: "chapeaumoustache.png" },
      { name: "G√©nial ü™ô 1", file: "chaton.png" },
      { name: "Chaos de la Chenille ü™ô 149", file: "chenilledodo.png" },
      { name: "Compagnon Citronn√©e ü™ô 199", file: "citronnade.png" },
      { name: "Clavier Gaming ü™ô 4000", file: "Clavier gamer.png" },
      { name: "Cochon Amoureux ü™ô 10", file: "cochonamoureux.Png" },

      { name: "Coeur ü™ô 199", file: "Coeur bisous.png" },
      { name: "Coeur Unis ü™ô 299", file: "Coeur Uni.png" },
      { name: "Coeur avec les mains ü™ô 100", file: "coeuraveclesmains.png" },
      { name: "Coeur dans les mains ü™ô 100", file: "Coeurdanslesmains.png" },
      { name: "coeur doigt ü™ô 5", file: "coeurdoigt.png" },
      { name: "coeur du jour ü™ô 1", file: "coeurdujour.png" },
      { name: "coeur en flammes ü™ô 1", file: "coeureenflammes.png" },
      { name: "coeur nuage ü™ô 1", file: "coeurnuage.png" },

      { name: "Collier amiti√© ü™ô 10", file: "collierami.png" },
      { name: "Saxophone de Rosie ü™ô 399 ", file: "Concert de Rosie.png" },
      { name: "Confettis ü™ô 100", file: "confetti.png" },
      { name: "Cool ü™ô 1", file: "Cool.png" },
      { name: "Cooper rentre en.. ü™ô 1999", file: "Cooper.png" },
      { name: "Coquillage ü™ô 100", file: "coquillage.png" },
      { name: "Corail ü™ô 499", file: "corail.png" },
      { name: "Corgi ü™ô 299", file: "corgi.png" },
      { name: "Cote √† C√¥te ü™ô 199", file: "Coteacote.png" },
      { name: "Couple puissant ü™ô 2000", file: "Couple puissant.png" },
      { name: "Couronnes Dragon ü™ô 500", file: "Couronnes Dragon.png" },
      { name: "Couronne TikTok ü™ô 299", file: "couronnes TikTok.png" },
      { name: "Crabe acclamant ü™ô 199", file: "crabe.png" },
      { name: "Crini√®re Lion ü™ô 500", file: "Crini√®re lion.png" },
      { name: "Cygne ü™ô 699", file: "cygne.png" },
      { name: "Ours Rythmique ü™ô 2999", file: "Dancing Bear.png" },
      { name: "Fusil √† Diamant ü™ô 5000", file: "Diamond gun.png" },
      { name: "Casquette Dino ü™ô 200", file: "dinocap.png" },
      { name: "Lunettes de DJ ü™ô 500", file: "Dj glasses.Png" },
      { name: "Donut ü™ô 30", file: "donuts.png" },
      { name: "Drift en voiture ü™ô 3000", file: "Drift.png" },
      { name: "eclair ü™ô 1", file: "eclair.png" },
      { name: "Elise l'√©l√©phante ü™ô 5000", file: "Elise l'√©l√©phant.Png" },
      { name: "Empreinte de Dino ü™ô 1", file: "empreintedino.png" },
      { name: "etoile √©tincelante ü™ô 199", file: "etoileetincelante.png" },
      { name: "Famille ü™ô 90", file: "famille.png" },
      { name: "Feu d'artifice ü™ô 1088", file: "Feu d'artifice.png" },
      { name: "Puissance Max ü™ô399", file: "Fire up.png" },
      { name: "Poing contre Poing ü™ô 90", file: "fistbump.png" },

      { name: " Bou√©e Flamant Rose ü™ô999", file: "flamant rose.Png" },
      { name: "fleur S ü™ô 20", file: "fleurenS.png" },
      { name: "Rencontre du Futur ü™ô 1500", file: "Futur.png" },
      { name: "Galaxie ü™ô 1000", file: "Galaxie.png" },
      { name: "Ours Gameur ü™ô 4088", file: "Gaming Bear.png" },
      { name: "Gant de Boxe ü™ô 299", file: "gantdeboxe.png" },
      { name: "Gant Dor√©e ü™ô 10", file: "gantdor√©e.png" },
      { name: "Part de Gateau D'anniversaire ü™ô 1", file: "gateauanniv.png" },
      { name: "Part de Gateau ü™ô 1", file: "gateaupart.png" },
      { name: "gg ü™ô 1", file: "gg.png" },
      { name: "Girafe ü™ô 1000", file: "Girafe.Png" },
      { name: "Glace ü™ô 5", file: "glace.png" },
      { name: "B√¢ton brillant ü™ô 1", file: "glow.png" },
      { name: "Grande Rose ü™ô 500", file: "Grande Roses.png" },
      { name: "Grue ü™ô 100", file: "grue.png" },
      { name: "Par√¥le d'amour ü™ô 1", file: "heartlytalyk.png" },
      { name: "ice-cream ü™ô 1", file: "ice-cream.png" },
      { name: "Jet volant ü™ô 5000 ", file: "Jet volant.png" },
      { name: "Je T'aime ü™ô 199", file: "jetaime.png" },
      { name: "Pass Aventure ü™ô 10", file: "journepass.png" },
      { name: "Sourire Juteux ü™ô 199", file: "juicysmile.png" },
      { name: "Eau De Coco ü™ô 199", file: "jusdecoco.png" },
      { name: "Leon le chaton ü™ô 4888", file: "Leon le chaton.png" },
      { name: "Loup d'arabie ü™ô 5500", file: "Loup D'arabie.png" },
      { name: "Peinture D'amour ü™ô 99", file: "lovepainting.png" },
      { name: "Lunettes de Soleil ü™ô 199", file: "lunettesdesoleil.png" },
      { name: "Magie du Caf√© ü™ô 199 ", file: "magieducafe.png" },
      { name: "Mama Mia ü™ô 1", file: "mamamia.png" },
      { name: "Manettes ü™ô 100", file: "Manettes.png" },
      { name: "Manifestation XXL ü™ô 1500", file: "Manifestation XXL.png" },
      { name: "Amour Astronaute ü™ô 349", file: "Marked With love.png" },
      { name: "Marque D'amour ü™ô 99", file: "marquedamour.png" },
      { name: "Masque Pharaon ü™ô 399", file: "masque pharaon.png" },
      { name: "masque ü™ô 149", file: "masque.png" },
      { name: "Un grand Bravo ü™ô 149", file: "megaphone.png" },
      { name: "Pistolet Billets ü™ô 500", file: "Money Gun.png" },
      { name: "Magnettes d'argent ü™ô 549", file: "Money Magnet.png" },
      { name: "Mongolfiere ü™ô 1000", file: "Mongolfiere.Png" },

      { name: "Fleur clair de Lune ü™ô 1400", file: "Moonlight Flower.png" },
      { name: "Moto ü™ô 2988", file: "Moto.png" },
      { name: "noeud papillon ü™ô 149", file: "noeudpapillon.png" },
      { name: "Oie D√©tendu ü™ô 399", file: "Oie d√©tendu.png" },
      { name: "Bisous Joyeux ü™ô 199", file: "oiseau.png" },
      { name: "Ours Dansant ü™ô 3000", file: "ours rythmic.png" },
      { name: "Ours de Rose ü™ô 214", file: "oursderose.png" },
      { name: "Ourson ü™ô 100", file: "ourson.png" },
      { name: "Panda Climb ü™ô 199", file: "pandaclimb.png" },
      { name: "Papillon ü™ô 88", file: "Papillon.png" },
      { name: "Parfum ü™ô 20", file: "parfum.png" },
      { name: "Bus Festif ü™ô 2999", file: "Party Bus.png" },
      { name: "Patate qui flotte ü™ô 1500", file: "Patate qui flottre.png" },
      { name: "P√™che ü™ô 5", file: "peche.png" },
      { name: "Petite couronne ü™ô 99", file: "petitecouronne.png" },
      { name: "Pingouin qui surf ü™ô 249", file: "pingouinsurf.png" },
      { name: "Pluie de m√©t√©ores ü™ô 3000", file: "Pluie de m√©t√©ore.png" },
      { name: "Pneu ü™ô 1", file: "pneu.png" },
      { name: "Polaris ü™ô 500", file: "Polaris.png" },
      { name: "Popcorn ü™ô 149", file: "popcorn.png" },
      { name: "Populaire ü™ô 1", file: "populaire.png" },
      { name: "Positivit√© ü™ô 199", file: "positivit√©.png" },
      { name: "Pouce vers le haut ü™ô 2", file: "pouceverslehaut.png" },
      { name: "Poulet espi√®gles ü™ô 299", file: "Poulet espi√®gles.png" },
      { name: "Poulpe ü™ô 199", file: "poulpe.png" },
      { name: "Poursuit tes r√™ves ü™ô 1500", file: "Poursuit tes reves.png" },
      { name: "Prince ü™ô 500", file: "Prince.png" },
      { name: "Jet Priv√© ü™ô 4888", file: "Private Jet.png" },
      { name: "Bisous Chiot ü™ô 299", file: "Puppy kiss.png" },
      { name: "Refuge de l'amour ü™ô 1200", file: "Refude de l'amour.png" },
      { name: "Rocky Rockeur ü™ô 399", file: "Rocky.png" },
      { name: "Rosa ü™ô 10", file: "rosa.png" },
      { name: "Rose √† jamais ü™ô 399", file: "Rose √† jamais.png" },
      { name: "Rose √† Main ü™ô 199", file: "Rose pour toi.png" },
      { name: "rose ü™ô 1", file: "rose.png" },
      { name: "rose blanche ü™ô 1", file: "roseblanche.png" },
      { name: "Sage Fut√© ü™ô 399", file: "sage intelligent.png" },
      { name: "slay ü™ô 1", file: "slay.png" },
      { name: "Sous contr√¥les ü™ô 1500", file: "Sous contr√¥les.Png" },

      { name: "Chat de L'espace ü™ô 1500", file: "Space Cat.png" },
      { name: "Chien de L'espace ü™ô 2500", file: "Space dog.png" },
      { name: "Steven Wingman ü™ô 1", file: "steven.png" },
      { name: "Super GG ü™ô 100", file: "supergg.png" },
      { name: "Super Populaire ü™ô 9", file: "superpopulaire.png" },
      { name: "Taureau ü™ô 3000", file: "taureau.Png" },
      { name: "Tcheck ü™ô 299", file: "tcheck.png" },
      { name: "tiktok ü™ô 1", file: "tiktok.png" },
      { name: "Tofu ü™ô 5", file: "tofu.png" },
      { name: "Tom la Tomate ü™ô 1", file: "tomtomate.png" },
      { name: "Ton concert ü™ô 4500", file: "ton concert.png" },
      { name: "Train ü™ô 899", file: "Train.png" },
      { name: "transfo patate ü™ô 150", file: "transfopatate.png" },
      { name: "Trompe D'√©l√©phant ü™ô 299", file: "trompe d'√©l√©phant.png" },
      { name: "Troph√©e Basket ü™ô 700", file: "Troph√©e Basket.png" },
      { name: "umake me so happy ü™ô 30", file: "umakemisohappy.png" },
      { name: "Vaisseau de Level ü™ô 1500", file: "Vaisseau de Level.png" },
      { name: "Vaisseau spatial ü™ô 4999", file: "Vaisseau spacial.png" },
      { name: "Voyage avec toi ü™ô 999", file: "Voyage avec toi.png" },
      { name: "Mercredi Gagnant ü™ô 99", file: "winningwednesday.png" },
      { name: "FLeurs XXXL ü™ô 500", file: "XXL flower.png" },
      { name: "you are my jam ü™ô 30", file: "youaremyjam.png" },
      { name: "you are on a roll ü™ô 30", file: "youaremyroll.png" }
    ];

    const state = {
      selectedGiftUrl: null,
      selectedGiftName: null,
      cells: [],
      labels: [],
      cols: 5,
      rows: 3,
      round: 22,
      gap: 26,

      bgType: "none", // none | image | video
      bgImage: null,
      bgVideo: null,
    };

    // Elements
    const stage = document.getElementById("stage");
    const grid = document.getElementById("grid");

    const bgImageInput = document.getElementById("bgImageInput");
    const bgVideoInput = document.getElementById("bgVideoInput");
    const clearBgBtn = document.getElementById("clearBg");
    const toggleVideoBtn = document.getElementById("toggleVideo");
    const muteVideoBtn = document.getElementById("muteVideo");

    const bgImgEl = document.getElementById("bgImg");
    const bgVidEl = document.getElementById("bgVid");

    const giftSelect = document.getElementById("giftSelect");
    const giftThumb = document.getElementById("giftThumb");
    const giftName = document.getElementById("giftName");
    const deselectBtn = document.getElementById("deselect");

    const layout = document.getElementById("layout");
    const roundRange = document.getElementById("round");
    const roundVal = document.getElementById("roundVal");
    const gapRange = document.getElementById("gap");
    const gapVal = document.getElementById("gapVal");

    const resetGridBtn = document.getElementById("resetGrid");
    const exportBtn = document.getElementById("exportPng");
    const exportRes = document.getElementById("exportRes");

    // -------------------------
    function setCSSVars(){
      document.documentElement.style.setProperty("--cols", state.cols);
      document.documentElement.style.setProperty("--rows", state.rows);
      document.documentElement.style.setProperty("--r", state.round + "px");
      document.documentElement.style.setProperty("--gap", state.gap + "px");
      roundVal.textContent = state.round;
      gapVal.textContent = state.gap;
    }

    function parseCoinsFromName(name){
      const m = name.match(/ü™ô\s*(\d+)/);
      return m ? Number(m[1]) : Number.POSITIVE_INFINITY;
    }

    function getSortedGiftIndexes(){
      return GIFTS
        .map((g, idx) => ({ idx, coins: parseCoinsFromName(g.name), name: g.name }))
        .sort((a, b) => (a.coins - b.coins) || a.name.localeCompare(b.name, "fr"))
        .map(x => x.idx);
    }

    function renderGiftSelect(){
      giftSelect.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "‚Äî Aucun (d√©s√©lectionn√©) ‚Äî";
      giftSelect.appendChild(opt0);

      const sortedIdx = getSortedGiftIndexes();
      sortedIdx.forEach((idx) => {
        const g = GIFTS[idx];
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = `üéÅ ${g.name}`;
        giftSelect.appendChild(opt);
      });
    }

    function renderGiftPreview(){
      giftThumb.innerHTML = "";
      if(!state.selectedGiftUrl){
        giftName.textContent = "Aucun cadeau s√©lectionn√©";
        return;
      }
      giftName.textContent = state.selectedGiftName || "Cadeau";
      const img = document.createElement("img");
      img.src = state.selectedGiftUrl;
      img.alt = state.selectedGiftName || "cadeau";
      giftThumb.appendChild(img);
    }

    function setSelectedGift(gift){
      if(!gift){
        state.selectedGiftUrl = null;
        state.selectedGiftName = null;
        renderGiftPreview();
        renderGrid();
        return;
      }
      state.selectedGiftUrl = `./${gift.file}`;
      state.selectedGiftName = gift.name;
      renderGiftPreview();
      renderGrid();
    }

    function ensureArraysSize(){
      const total = state.cols * state.rows;

      if(!Array.isArray(state.cells)) state.cells = [];
      if(!Array.isArray(state.labels)) state.labels = [];

      if(state.cells.length !== total){
        const old = state.cells.slice();
        state.cells = new Array(total).fill(null);
        for(let i=0; i<Math.min(old.length, total); i++) state.cells[i] = old[i];
      }

      if(state.labels.length !== total){
        const oldL = state.labels.slice();
        state.labels = new Array(total).fill("");
        for(let i=0; i<Math.min(oldL.length, total); i++) state.labels[i] = oldL[i] || "";
      }
    }

    function applySizingForLayout(){
      const inset = (window.innerWidth <= 980) ? 18 : 40;

      const stageW = stage.clientWidth;
      const stageH = stage.clientHeight;

      const availW = Math.max(200, stageW - inset * 2);
      const availH = Math.max(200, stageH - inset * 2);

      const labelSpace = 56;
      const rows = state.rows;
      const cols = state.cols;

      let gap = state.gap;

      const cellW = Math.floor((availW - (cols - 1) * gap) / cols);
      const cellH = Math.floor((availH - (rows - 1) * gap) / rows - labelSpace);

      let cell = Math.min(cellW, cellH);

      const minCell = (window.innerWidth <= 980) ? 92 : 110;
      const maxCell = 210;
      cell = Math.max(minCell, Math.min(maxCell, cell));

      document.documentElement.style.setProperty("--cellSize", cell + "px");
    }

    function setLayout(value){
      const [c, r] = value.split("x").map(Number);
      state.cols = c;
      state.rows = r;

      state.cells = new Array(c * r).fill(null);
      state.labels = new Array(c * r).fill("");

      setCSSVars();
      applySizingForLayout();
      renderGrid();
    }

    function editLabelAt(index){
      const current = (state.labels[index] || "").toString();
      const next = prompt("Texte sous la case (vide = supprimer) :", current);
      if(next === null) return;
      state.labels[index] = (next || "").trim();
      renderGrid();
    }

    function renderGrid(){
      ensureArraysSize();
      grid.innerHTML = "";

      const total = state.cols * state.rows;

      for(let i=0; i<total; i++){
        const tile = document.createElement("div");
        tile.className = "tile";

        const cell = document.createElement("div");
        cell.className = "cell";

        // deco overlays (neon + shine)
        const shine = document.createElement("div");
        shine.className = "topShine";
        const frame = document.createElement("div");
        frame.className = "neonFrame";
        cell.appendChild(shine);
        cell.appendChild(frame);

        const url = state.cells[i];

        if(url){
          const wrap = document.createElement("div");
          wrap.className = "giftInCell";

          const img = document.createElement("img");
          img.src = url;
          img.alt = "gift";

          wrap.appendChild(img);
          cell.appendChild(wrap);
        } else {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = state.selectedGiftUrl ? "Clique pour placer ‚òÅÔ∏è" : "Choisis un cadeau ü©∏";
          cell.appendChild(empty);
        }

        cell.addEventListener("click", (e) => {
          if(e.ctrlKey || e.metaKey){
            editLabelAt(i);
            return;
          }
          if(!state.selectedGiftUrl) return;
          state.cells[i] = state.selectedGiftUrl;
          renderGrid();
        });

        cell.addEventListener("dblclick", () => {
          state.cells[i] = null;
          renderGrid();
        });

        cell.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          editLabelAt(i);
        });

        const label = document.createElement("div");
        label.className = "cellLabel";
        const txt = (state.labels[i] || "").trim();

        if(!txt){
          label.classList.add("is-empty");
          label.textContent = "‚Äî";
        } else {
          label.textContent = txt;
        }

        label.addEventListener("dblclick", () => editLabelAt(i));

        tile.appendChild(cell);
        tile.appendChild(label);
        grid.appendChild(tile);
      }
    }

    // -------------------------
    // Background: image / video
    function clearBackground(){
      state.bgType = "none";
      bgImgEl.style.display = "none";
      bgVidEl.style.display = "none";
      bgImgEl.src = "";
      bgVidEl.src = "";
      bgImageInput.value = "";
      bgVideoInput.value = "";
      state.bgImage = null;
      state.bgVideo = null;
    }

    function setBackgroundImage(file){
      const url = URL.createObjectURL(file);
      state.bgType = "image";
      bgVidEl.pause();
      bgVidEl.style.display = "none";
      bgImgEl.style.display = "block";
      bgImgEl.onload = () => {
        state.bgImage = bgImgEl;
      };
      bgImgEl.src = url;
    }

    function setBackgroundVideo(file){
      const url = URL.createObjectURL(file);
      state.bgType = "video";
      bgImgEl.style.display = "none";
      bgVidEl.style.display = "block";
      bgVidEl.muted = true;
      bgVidEl.loop = true;
      bgVidEl.onloadeddata = () => {
        state.bgVideo = bgVidEl;
        bgVidEl.play().catch(()=>{});
      };
      bgVidEl.src = url;
    }

    bgImageInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      setBackgroundImage(file);
    });

    bgVideoInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      setBackgroundVideo(file);
    });

    clearBgBtn.addEventListener("click", clearBackground);

    toggleVideoBtn.addEventListener("click", () => {
      if(state.bgType !== "video") return;
      if(bgVidEl.paused) bgVidEl.play().catch(()=>{});
      else bgVidEl.pause();
    });

    muteVideoBtn.addEventListener("click", () => {
      if(state.bgType !== "video") return;
      bgVidEl.muted = !bgVidEl.muted;
      muteVideoBtn.textContent = bgVidEl.muted ? "üîá" : "üîä";
    });

    // -------------------------
    // Gift selection
    giftSelect.addEventListener("change", () => {
      const v = giftSelect.value;
      if(v === ""){
        setSelectedGift(null);
        return;
      }
      const idx = Number(v);
      setSelectedGift(GIFTS[idx]);
    });

    deselectBtn.addEventListener("click", () => {
      giftSelect.value = "";
      setSelectedGift(null);
    });

    // -------------------------
    // Controls
    layout.addEventListener("change", (e) => setLayout(e.target.value));

    roundRange.addEventListener("input", (e) => {
      state.round = Number(e.target.value);
      setCSSVars();
    });

    gapRange.addEventListener("input", (e) => {
      state.gap = Number(e.target.value);
      setCSSVars();
      applySizingForLayout();
    });

    resetGridBtn.addEventListener("click", () => {
      state.cells = new Array(state.cols * state.rows).fill(null);
      state.labels = new Array(state.cols * state.rows).fill("");
      renderGrid();
    });

    window.addEventListener("resize", () => {
      applySizingForLayout();
    });

    // -------------------------
    // Export PNG via Canvas renderer (propre, fid√®le)
    function roundRectPath(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    const giftCache = new Map();
    function loadImageCached(url){
      if(giftCache.has(url)) return giftCache.get(url);
      const p = new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = url;
      });
      giftCache.set(url, p);
      return p;
    }

    function getCoverDrawParams(srcW, srcH, dstW, dstH){
      const s = Math.max(dstW / srcW, dstH / srcH);
      const drawnW = srcW * s;
      const drawnH = srcH * s;
      const offsetX = (dstW - drawnW) / 2;
      const offsetY = (dstH - drawnH) / 2;
      return { s, drawnW, drawnH, offsetX, offsetY };
    }

    async function exportOverlayPNG(){
      exportBtn.disabled = true;
      exportBtn.textContent = "‚è≥ Export‚Ä¶";
      document.body.classList.add("exporting");

      try{
        const [W, H] = exportRes.value.split("x").map(Number);
        const canvas = document.createElement("canvas");
        canvas.width = W;
        canvas.height = H;
        const ctx = canvas.getContext("2d");

        // ---- Draw background (image or current video frame)
        ctx.clearRect(0,0,W,H);
        if(state.bgType === "image" && state.bgImage?.naturalWidth){
          const src = state.bgImage;
          const cover = getCoverDrawParams(src.naturalWidth, src.naturalHeight, W, H);
          ctx.drawImage(src, 0,0,src.naturalWidth,src.naturalHeight, cover.offsetX, cover.offsetY, cover.drawnW, cover.drawnH);
        } else if(state.bgType === "video" && state.bgVideo?.videoWidth){
          const src = state.bgVideo;
          const cover = getCoverDrawParams(src.videoWidth, src.videoHeight, W, H);
          ctx.drawImage(src, 0,0,src.videoWidth,src.videoHeight, cover.offsetX, cover.offsetY, cover.drawnW, cover.drawnH);
        } else {
          // fallback
          ctx.fillStyle = "rgba(10,8,14,1)";
          ctx.fillRect(0,0,W,H);
        }

        // vignette
        const vign = ctx.createRadialGradient(W*0.5, H*0.35, Math.min(W,H)*0.12, W*0.5, H*0.5, Math.max(W,H)*0.75);
        vign.addColorStop(0, "rgba(0,0,0,0)");
        vign.addColorStop(1, "rgba(0,0,0,0.48)");
        ctx.fillStyle = vign;
        ctx.fillRect(0,0,W,H);

        // ---- Grid layout (export)
        const inset = 40;
        const availW = W - inset*2;
        const availH = H - inset*2;

        const cols = state.cols;
        const rows = state.rows;
        const gap = state.gap;
        const labelSpace = 56;

        let cell = Math.min(
          Math.floor((availW - (cols-1)*gap)/cols),
          Math.floor((availH - (rows-1)*gap)/rows - labelSpace)
        );
        cell = Math.max(110, Math.min(220, cell));

        const gridW = cols*cell + (cols-1)*gap;
        const gridH = rows*cell + (rows-1)*gap + rows*labelSpace;

        const gridX = Math.round((W - gridW)/2);
        const gridY = Math.round((H - gridH)/2);

        // preload gifts
        const uniqueGiftUrls = Array.from(new Set(state.cells.filter(Boolean)));
        const imgs = await Promise.all(uniqueGiftUrls.map(loadImageCached));
        const giftMap = new Map();
        uniqueGiftUrls.forEach((u,i) => giftMap.set(u, imgs[i]));

        // label style
        ctx.textAlign = "center";
        ctx.textBaseline = "top";

        // helper: draw neon panel
        function drawNeonPanel(x,y,size,r){
          // shadow / base
          ctx.save();
          ctx.shadowColor = "rgba(0,0,0,0.55)";
          ctx.shadowBlur = 22;
          ctx.shadowOffsetY = 14;

          roundRectPath(ctx, x, y, size, size, r);
          ctx.fillStyle = "rgba(0,0,0,0.22)";
          ctx.fill();
          ctx.restore();

          // diagonal subtle pattern
          ctx.save();
          roundRectPath(ctx, x, y, size, size, r);
          ctx.clip();

          ctx.globalAlpha = 0.16;
          ctx.strokeStyle = "rgba(255,255,255,0.7)";
          ctx.lineWidth = 3;

          const step = 18;
          for(let i=-size; i<size*2; i+=step){
            ctx.beginPath();
            ctx.moveTo(x+i, y);
            ctx.lineTo(x+i+size, y+size);
            ctx.stroke();
          }

          ctx.globalAlpha = 1;

          // top shine
          const g = ctx.createRadialGradient(x+size*0.40, y+size*0.10, size*0.08, x+size*0.40, y+size*0.10, size*0.70);
          g.addColorStop(0, "rgba(255,255,255,0.20)");
          g.addColorStop(1, "rgba(255,255,255,0)");
          ctx.fillStyle = g;
          ctx.fillRect(x, y, size, size);

          ctx.restore();

          // neon border
          ctx.save();
          // outer glow
          ctx.shadowColor = "rgba(255,60,90,0.30)";
          ctx.shadowBlur = 18;
          roundRectPath(ctx, x, y, size, size, r);
          ctx.strokeStyle = "rgba(255,60,90,0.35)";
          ctx.lineWidth = 6;
          ctx.stroke();
          ctx.restore();

          // inner crisp stroke
          ctx.save();
          roundRectPath(ctx, x, y, size, size, r);
          const grad = ctx.createLinearGradient(x, y, x+size, y+size);
          grad.addColorStop(0, "rgba(255,60,90,0.55)");
          grad.addColorStop(0.5, "rgba(255,255,255,0.16)");
          grad.addColorStop(1, "rgba(255,60,90,0.38)");
          ctx.strokeStyle = grad;
          ctx.lineWidth = 2;
          ctx.stroke();

          // tiny highlight line
          roundRectPath(ctx, x+1, y+1, size-2, size-2, Math.max(0,r-1));
          ctx.strokeStyle = "rgba(255,255,255,0.10)";
          ctx.lineWidth = 1;
          ctx.stroke();
          ctx.restore();
        }

        // draw tiles
        for(let row=0; row<rows; row++){
          for(let col=0; col<cols; col++){
            const i = row*cols + col;
            const x = gridX + col*(cell+gap);
            const y = gridY + row*(cell+gap+labelSpace);

            drawNeonPanel(x,y,cell,state.round);

            // gift
            const url = state.cells[i];
            if(url){
              const img = giftMap.get(url);
              if(img){
                const pad = cell * 0.16;
                const gx = x + pad;
                const gy = y + pad;
                const gw = cell - pad*2;
                const gh = cell - pad*2;

                ctx.save();
                ctx.shadowColor = "rgba(0,0,0,0.60)";
                ctx.shadowBlur = 18;
                ctx.shadowOffsetY = 12;
                ctx.drawImage(img, gx, gy, gw, gh);
                ctx.restore();
              }
            }

            // label (stroke-like fake)
            const label = (state.labels[i] || "").trim();
            if(label){
              const ly = y + cell + 8;
              const fontSize = 28; // OK for 1080p; will scale naturally via render size
              ctx.font = `900 ${fontSize}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial`;
              const maxW = cell;
              const lines = wrapText(ctx, label.toUpperCase(), maxW, 2);

              // "stroke"
              ctx.lineWidth = 10;
              ctx.strokeStyle = "rgba(0,0,0,0.92)";
              ctx.fillStyle = "rgba(255,255,255,0.96)";

              let yy = ly;
              for(const line of lines){
                ctx.strokeText(line, x + cell/2, yy);
                ctx.fillText(line, x + cell/2, yy);
                yy += fontSize * 1.05;
              }
            }
          }
        }

        // download
        const dataUrl = canvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = `overlay-akatsuki-${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();

      } catch(err){
        console.error(err);
        alert("Export impossible. V√©rifie que les images cadeaux existent bien en racine.");
      } finally {
        document.body.classList.remove("exporting");
        exportBtn.disabled = false;
        exportBtn.textContent = "Exporter en PNG";
      }
    }

    function wrapText(ctx, text, maxWidth, maxLines){
      const words = text.split(/\s+/).filter(Boolean);
      const lines = [];
      let line = "";
      for(const w of words){
        const test = line ? (line + " " + w) : w;
        const width = ctx.measureText(test).width;
        if(width <= maxWidth){
          line = test;
        } else {
          if(line) lines.push(line);
          line = w;
          if(lines.length >= maxLines-1) break;
        }
      }
      if(line && lines.length < maxLines) lines.push(line);
      return lines;
    }

    exportBtn.addEventListener("click", exportOverlayPNG);

    // -------------------------
    // Init
    renderGiftSelect();

    state.round = Number(roundRange.value);
    state.gap = Number(gapRange.value);
    setCSSVars();

    setLayout(layout.value);
    renderGiftPreview();
    renderGrid();
    applySizingForLayout();

  </script>
</body>
</html>
