<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cr√©ateur d'overlay ‚Äî Akatsuki Orga (DINGUERIE)</title>

  <style>
    :root{
      --bg: #07060a;

      --red: rgba(255, 60, 90, 1);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);

      --menu: rgba(0,0,0,.22);
      --menu2: rgba(0,0,0,.12);
      --strokeRed: rgba(255, 60, 90, .40);
      --shadow: 0 18px 40px rgba(0,0,0,.45);

      --cols: 5;
      --rows: 3;
      --gap: 26px;
      --cellSize: 150px;
      --r: 22px;

      /* panel controls */
      --panelColor: 255, 60, 90; /* rgb only */
      --panelAlpha: .22;         /* density */
      --hudAlpha: .85;

      /* bounce controls */
      --bounceAmp: 8px;
      --bounceSpeed: 1.3;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 500px at 70% 15%, rgba(255,60,90,.18), transparent 60%),
        radial-gradient(900px 500px at 20% 75%, rgba(255,255,255,.06), transparent 60%),
        var(--bg);
    }

    .app{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
      padding: 18px;
      max-width: 1550px;
      margin: 0 auto;
    }
    @media (max-width: 980px){ .app{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(180deg, var(--menu), var(--menu2));
      border: 1px solid var(--strokeRed);
      border-radius: 24px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sidebar{
      padding: 16px;
      position: sticky;
      top: 16px;
      height: fit-content;
    }

    .title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .title h1{
      font-size: 15px;
      line-height: 1.25;
      margin:0;
      letter-spacing:.2px;
    }
    .badge{
      font-size: 12px;
      color: rgba(255,255,255,.82);
      background: rgba(255,60,90,.12);
      border: 1px solid rgba(255,60,90,.35);
      padding: 6px 10px;
      border-radius: 999px;
      box-shadow: 0 0 0 3px rgba(255,60,90,.08);
      white-space:nowrap;
    }

    .section{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    .btn:hover{
      background: rgba(0,0,0,.28);
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(180deg, rgba(255,60,90,.22), rgba(255,60,90,.10));
      border-color: rgba(255,60,90,.38);
      box-shadow: 0 0 0 3px rgba(255,60,90,.10);
    }
    .btn.danger{
      background: rgba(255,60,90,.12);
      border-color: rgba(255,60,90,.30);
    }
    .btn.record{
      background: linear-gradient(180deg, rgba(50,255,160,.18), rgba(50,255,160,.08));
      border-color: rgba(50,255,160,.35);
      box-shadow: 0 0 0 3px rgba(50,255,160,.10);
    }
    .btn.record.is-on{
      background: linear-gradient(180deg, rgba(255,80,80,.20), rgba(255,80,80,.08));
      border-color: rgba(255,80,80,.45);
      box-shadow: 0 0 0 3px rgba(255,80,80,.12);
    }

    input[type="file"]{
      width: 100%;
      padding: 10px;
      background: rgba(0,0,0,.18);
      border: 1px dashed rgba(255,255,255,.20);
      border-radius: 14px;
      color: rgba(255,255,255,.70);
    }
    input[type="range"]{ width: 100%; }

    /* ‚úÖ DROPDOWNS PLUS VISIBLES (fond noir, fl√®che custom) */
    select{
      width: 100%;
      padding: 11px 42px 11px 12px;
      background: rgba(0,0,0,.78);
      border: 1px solid rgba(255,60,90,.48);
      border-radius: 14px;
      color: rgba(255,255,255,.96);
      outline:none;
      box-shadow: 0 0 0 3px rgba(255,60,90,.10);
      font-weight: 900;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.85) 50%),
        linear-gradient(135deg, rgba(255,255,255,.85) 50%, transparent 50%),
        linear-gradient(to right, rgba(255,60,90,.18), rgba(255,60,90,.06));
      background-position:
        calc(100% - 18px) 18px,
        calc(100% - 12px) 18px,
        100% 0;
      background-size:
        6px 6px,
        6px 6px,
        52px 100%;
      background-repeat: no-repeat;
    }
    select:focus{
      border-color: rgba(255,60,90,.70);
      box-shadow: 0 0 0 4px rgba(255,60,90,.16);
    }
    select option{
      background: #0b0a10;
      color: rgba(255,255,255,.95);
    }

    .hint{
      font-size: 12px;
      color: rgba(255,255,255,.72);
      line-height: 1.35;
      margin-top: 8px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New";
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,60,90,.30);
      background: rgba(255,60,90,.10);
      color: rgba(255,255,255,.88);
    }

    .giftPreview{
      margin-top: 10px;
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    .giftPreview .thumb{
      width: 54px;
      height: 54px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .giftPreview img{
      width: 70%;
      height: 70%;
      object-fit: contain;
      filter: drop-shadow(0 12px 14px rgba(0,0,0,.45));
    }
    .giftPreview .meta{ display:flex; flex-direction:column; gap: 2px; }
    .giftPreview .meta .name{ font-weight: 950; font-size: 13px; }
    .giftPreview .meta .sub{ font-size: 12px; color: rgba(255,255,255,.70); }

    .main{
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 14px;
      min-height: calc(100vh - 36px);
    }

    .stage-wrap{ display:flex; flex-direction:column; gap: 10px; }
    .stage-toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .footer-note{
      font-size: 12px;
      color: rgba(255,255,255,.75);
      opacity:.98;
    }

    .stage{
      position:relative;
      border-radius: 0px;
      border: 1px solid rgba(255,60,90,.24);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: rgba(0,0,0,.25);
      width: 100%;
      aspect-ratio: 16 / 9;
      min-height: 360px;
    }

    .bgLayer{
      position:absolute; inset:0;
      overflow:hidden;
    }
    .bgLayer img,
    .bgLayer video{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      filter: saturate(1.06) contrast(1.03);
    }

    .vignette{
      position:absolute; inset:0;
      background:
        radial-gradient(1200px 700px at 50% 35%, transparent 48%, rgba(0,0,0,.48) 100%),
        linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.06));
      pointer-events:none;
    }
    .grain{
      position:absolute; inset:0;
      opacity: .08;
      pointer-events:none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
    }

    .grid{
      position:absolute;
      inset: 40px;
      display:grid;
      align-content:center;
      justify-content:center;
      gap: var(--gap);
      grid-template-columns: repeat(var(--cols), var(--cellSize));
    }
    @media (max-width: 980px){ .grid{ inset: 18px; } }

    .tile{
      width: var(--cellSize);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap: 10px;
      user-select:none;
    }

    .cell{
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: var(--r);
      position:relative;
      overflow:hidden;
      cursor:pointer;

      background:
        radial-gradient(120px 120px at 28% 22%, rgba(var(--panelColor), calc(var(--panelAlpha) * .55)), transparent 65%),
        radial-gradient(160px 160px at 70% 78%, rgba(255,255,255, calc(var(--panelAlpha) * .22)), transparent 70%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.32));

      border: 1px solid rgba(255,255,255,.10);
      box-shadow:
        0 20px 38px rgba(0,0,0,.48),
        0 0 0 1px rgba(var(--panelColor), .10) inset;
    }

    /* CSS micro pattern (screen only) */
    .cell::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(135deg,
          rgba(255,255,255,.06) 0px,
          rgba(255,255,255,.06) 3px,
          rgba(255,255,255,0) 3px,
          rgba(255,255,255,0) 14px);
      opacity: calc(var(--panelAlpha) * .9);
      mix-blend-mode: overlay;
      pointer-events:none;
    }

    .scanline{
      position:absolute;
      left:-40%;
      top:-30%;
      width: 180%;
      height: 42%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.14), transparent);
      opacity: calc(var(--hudAlpha) * .55);
      transform: rotate(12deg);
      animation: scan 2.8s linear infinite;
      pointer-events:none;
    }
    @keyframes scan{
      0%{ transform: translateY(-60%) rotate(12deg); opacity: 0; }
      15%{ opacity: .55; }
      55%{ opacity: .38; }
      100%{ transform: translateY(170%) rotate(12deg); opacity: 0; }
    }

    .neonFrame{
      position:absolute; inset:0;
      border-radius: var(--r);
      pointer-events:none;
      box-shadow:
        inset 0 0 0 2px rgba(var(--panelColor), .34),
        inset 0 0 0 1px rgba(255,255,255,.10),
        0 0 22px rgba(var(--panelColor), .14);
      animation: pulse 1.9s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{
        box-shadow:
          inset 0 0 0 2px rgba(var(--panelColor), .30),
          inset 0 0 0 1px rgba(255,255,255,.10),
          0 0 18px rgba(var(--panelColor), .12);
      }
      50%{
        box-shadow:
          inset 0 0 0 2px rgba(var(--panelColor), .48),
          inset 0 0 0 1px rgba(255,255,255,.14),
          0 0 34px rgba(var(--panelColor), .22);
      }
    }

    .ticks{
      position:absolute; inset:0;
      pointer-events:none;
      opacity: calc(var(--hudAlpha) * .85);
    }
    .ticks::before, .ticks::after{
      content:"";
      position:absolute;
      width: 18px; height: 18px;
      border: 2px solid rgba(var(--panelColor), .55);
      border-right: none; border-bottom:none;
      top: 10px; left: 10px;
      filter: drop-shadow(0 0 10px rgba(var(--panelColor), .25));
    }
    .ticks::after{
      top:auto; left:auto;
      bottom: 10px; right: 10px;
      transform: rotate(180deg);
    }

    .glitch{
      position:absolute;
      left:0; right:0;
      height: 10px;
      top: 18%;
      background: linear-gradient(90deg, transparent, rgba(var(--panelColor), .22), transparent);
      opacity: 0;
      pointer-events:none;
      animation: glitch 3.7s infinite;
    }
    @keyframes glitch{
      0%, 74%{ opacity: 0; transform: translateX(-30%); }
      76%{ opacity: .65; transform: translateX(10%); }
      78%{ opacity: .25; transform: translateX(-10%); }
      80%{ opacity: .55; transform: translateX(25%); }
      82%,100%{ opacity: 0; transform: translateX(0); }
    }

    .cell:hover{
      border-color: rgba(var(--panelColor), .28);
      box-shadow:
        0 20px 38px rgba(0,0,0,.48),
        0 0 0 3px rgba(var(--panelColor), .10);
    }

    .cell .giftInCell{
      position:absolute; inset: 16%;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index: 4;
    }
    .cell .giftInCell img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 18px 18px rgba(0,0,0,.58));
      transform: translateY(0);
      will-change: transform;
    }

    /* ‚úÖ Rebond (screen) */
    body.bounce-on .cell .giftInCell img{
      animation: bounceGift calc(1s / var(--bounceSpeed)) ease-in-out infinite;
    }
    @keyframes bounceGift{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(calc(-1 * var(--bounceAmp))); }
    }

    .cell .empty{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      color: rgba(255,255,255,.65);
      pointer-events:none;
      text-align:center;
      padding: 10px;
      text-shadow: 0 6px 18px rgba(0,0,0,.65);
      z-index: 4;
    }

    .cellLabel{
      width: 100%;
      text-align:center;
      font-weight: 1000;
      letter-spacing: .6px;
      line-height: 1.05;
      text-transform: uppercase;

      font-size: 16px;
      color: rgba(255,255,255,.96);
      text-shadow:
        0 4px 0 rgba(0,0,0,.60),
        0 10px 18px rgba(0,0,0,.55);

      -webkit-text-stroke: 3px rgba(0,0,0,.92);
      paint-order: stroke fill;

      min-height: 2.4em;
      display:flex;
      align-items:flex-start;
      justify-content:center;

      padding: 0 6px;
      word-break: break-word;
      position: relative;
    }
    .cellLabel.is-empty{
      color: transparent;
      -webkit-text-stroke: 0px transparent;
      text-shadow: none;
    }

    body:not(.exporting) .cellLabel::before{
      content:"";
      position:absolute;
      inset: -8px -10px;
      border-radius: 14px;
      border: 2px dashed rgba(255,255,255,.45);
      background: rgba(0,0,0,.28);
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
      pointer-events:none;
    }
    body:not(.exporting) .cellLabel.is-empty::after{
      content:"‚úçÔ∏è √âCRIRE ICI";
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      letter-spacing: .6px;
      color: rgba(255,255,255,.70);
      text-shadow: 0 2px 10px rgba(0,0,0,.55);
      -webkit-text-stroke: 0;
      pointer-events:none;
    }

    .mini{
      display:flex; gap:10px; width:100%;
    }
    .mini > div{
      flex:1;
      min-width: 150px;
    }

    input[type="color"]{
      width: 100%;
      height: 42px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      padding: 6px;
    }

    .switchRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
    }
    .switchRow .left{
      display:flex; flex-direction:column; gap: 2px;
    }
    .switchRow .left .big{
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,.88);
    }
    .switchRow .left .small{
      font-size: 12px;
      color: rgba(255,255,255,.66);
    }
    .toggle{
      width: 44px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      position:relative;
      cursor:pointer;
      flex: 0 0 auto;
      box-shadow: 0 0 0 3px rgba(255,60,90,.06);
    }
    .toggle::after{
      content:"";
      position:absolute;
      top: 3px; left: 3px;
      width: 20px; height: 20px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 8px 16px rgba(0,0,0,.35);
      transition: transform .18s ease;
    }
    .toggle.is-on{
      border-color: rgba(255,60,90,.55);
      background: rgba(255,60,90,.18);
    }
    .toggle.is-on::after{
      transform: translateX(18px);
      background: rgba(255,255,255,.98);
    }

    .status{
      font-size: 12px;
      color: rgba(255,255,255,.78);
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      display:none;
      margin-top: 10px;
      line-height: 1.35;
    }
    .status.show{ display:block; }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <div class="card sidebar">
      <div class="title">
        <h1>Cr√©ateur d'overlay ‚Äî Akatsuki Orga (DINGUERIE)</h1>
        <div class="badge">‚òÅÔ∏èü©∏ Akatsuki</div>
      </div>

      <div class="section">
        <label>üñºÔ∏è 1) Fond (image ou vid√©o)</label>
        <div class="row" style="width:100%">
          <div style="flex:1; min-width:160px;">
            <label style="margin-bottom:6px;">Image</label>
            <input id="bgImageInput" type="file" accept="image/*" />
          </div>
          <div style="flex:1; min-width:160px;">
            <label style="margin-bottom:6px;">Vid√©o</label>
            <input id="bgVideoInput" type="file" accept="video/*" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="clearBg">Retirer le fond</button>
          <button class="btn" id="toggleVideo">‚èØÔ∏è Vid√©o</button>
          <button class="btn" id="muteVideo">üîá</button>
        </div>

        <div class="hint">
          ‚úÖ Vid√©o OK. Export vid√©o = WEBM (capture canvas).<br/>
          ‚ÑπÔ∏è Certains navigateurs refusent l‚Äôaudio ‚Üí mute par d√©faut.
        </div>
      </div>

      <div class="section">
        <label>üéÅ 2) Choisir un cadeau</label>
        <select id="giftSelect"></select>

        <div class="giftPreview">
          <div class="thumb" id="giftThumb"></div>
          <div class="meta">
            <div class="name" id="giftName">Aucun cadeau s√©lectionn√©</div>
            <div class="sub">Clique une case ‚Ä¢ <span class="kbd">Double-clic</span> = retirer</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="deselect">D√©s√©lectionner</button>
        </div>
      </div>

      <div class="section">
        <label>üß™ 3) Style des cases (dinguerie)</label>

        <div class="mini">
          <div>
            <label>üé® Couleur</label>
            <input id="panelColor" type="color" value="#ff3c5a" />
          </div>
          <div>
            <label>üß± Densit√© (opacity) : <span id="densityVal">0.22</span></label>
            <input id="density" type="range" min="0" max="0.6" step="0.01" value="0.22" />
          </div>
        </div>

        <div style="margin-top:12px;">
          <label>üí° HUD (intensit√©) : <span id="hudVal">0.85</span></label>
          <input id="hud" type="range" min="0" max="1" step="0.01" value="0.85" />
        </div>
      </div>

      <div class="section">
        <label>üåÄ 3bis) Effet cadeaux (rebond)</label>

        <div class="switchRow">
          <div class="left">
            <div class="big">Rebond en boucle</div>
            <div class="small">Visible √† l‚Äô√©cran + sur la vid√©o/PNG</div>
          </div>
          <div class="toggle" id="bounceToggle" role="switch" aria-checked="false" tabindex="0"></div>
        </div>

        <div style="margin-top:12px;">
          <label>‚¨ÜÔ∏è Amplitude : <span id="bounceAmpVal">8</span>px</label>
          <input id="bounceAmp" type="range" min="0" max="24" step="1" value="8" />
        </div>

        <div style="margin-top:12px;">
          <label>‚è±Ô∏è Vitesse : <span id="bounceSpeedVal">1.30</span></label>
          <input id="bounceSpeed" type="range" min="0.5" max="3" step="0.05" value="1.3" />
        </div>
      </div>

      <div class="section">
        <label>‚öôÔ∏è 4) R√©glages</label>

        <label style="margin-top:8px;">Disposition</label>
        <select id="layout">
          <option value="3x2">3 √ó 2 (6)</option>
          <option value="5x2">5 √ó 2 (10)</option>
          <option value="5x3" selected>5 √ó 3 (15)</option>
          <option value="6x3">6 √ó 3 (18)</option>
        </select>

        <div style="margin-top:12px;">
          <label>‚≠ï Arrondi : <span id="roundVal">22</span>px</label>
          <input id="round" type="range" min="8" max="40" value="22" />
        </div>

        <div style="margin-top:12px;">
          <label>‚ÜîÔ∏è Gap : <span id="gapVal">26</span>px</label>
          <input id="gap" type="range" min="12" max="40" value="26" />
        </div>

        <div class="hint">
          ‚úçÔ∏è Texte : <span class="kbd">clic droit</span> (ou <span class="kbd">Ctrl</span>+clic) sur une case.
        </div>
      </div>

      <div class="section">
        <label>üñ®Ô∏è 5) Export</label>

        <label style="margin-top:8px;">R√©solution</label>
        <select id="exportRes">
          <option value="1920x1080" selected>1920√ó1080 (1080p)</option>
          <option value="2560x1440">2560√ó1440 (1440p)</option>
          <option value="3840x2160">3840√ó2160 (4K)</option>
        </select>

        <div class="row" style="margin-top:10px;">
          <button class="btn danger" id="resetGrid">Vider toutes les cases</button>
          <button class="btn primary" id="exportPng">Exporter en PNG</button>
          <button class="btn record" id="recordBtn">‚è∫Ô∏è Enregistrer vid√©o</button>
        </div>

        <div class="status" id="statusBox"></div>

        <div class="hint">
          ‚úÖ PNG : export propre.<br/>
          ‚úÖ Vid√©o : WEBM (Start/Stop) ‚Üí t√©l√©chargement auto au stop.<br/>
          ‚ÑπÔ∏è Si rien ne se passe : essaie Chrome/Edge et ouvre la page via un serveur (pas en file://).
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <div class="stage-wrap">
        <div class="stage-toolbar">
          <div class="footer-note">
            ‚òÅÔ∏èü©∏ Cadeau : clique une case ‚Ä¢ <span class="kbd">Double-clic</span> supprime ‚Ä¢
            ‚úçÔ∏è Texte : <span class="kbd">clic droit</span> (ou <span class="kbd">Ctrl</span>+clic)
          </div>
        </div>

        <div class="stage" id="stage">
          <div class="bgLayer">
            <img id="bgImg" alt="" style="display:none;">
            <video id="bgVid" style="display:none;" playsinline loop></video>
          </div>

          <div class="vignette"></div>
          <div class="grain"></div>
          <div class="grid" id="grid"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ‚úÖ LISTE COMPL√àTE (la tienne)
    const GIFTS = [
      { name: "9 queues ü™ô 1800", file: "9 queues.png" },
      { name: "2026 ü™ô 1", file: "2026.png" },
      { name: "je t'adore ü™ô 1", file: "adore.png" },
      { name: "Aile de papillon ü™ô 399", file: "Aile de papillon.png" },
      { name: "ailes f√©e ü™ô 1", file: "ailesfee.png" },
      { name: "Bo√Ætes de largage ü™ô 999 ", file: "Air drop.png" },
      { name: "Ami Fruit√©s ü™ô 299", file: "Ami Fruit√©s.png" },
      { name: "amour langue signe ü™ô 49", file: "amourlanguesigne.png" },
      { name: "Animaux en sc√®ne ü™ô 2500", file: "Animal Band.png" },
      { name: "Arbre √† diamants ü™ô 1088", file: "Arbre √† diamants.png" },
      { name: "arc amour ü™ô 99", file: "arcamour.png" },
      { name: "arc en ciel ü™ô 1", file: "arcenciel.png" },
      { name: "bagel ü™ô 35", file: "bagel.png" },
      { name: "Singe Encourageant ü™ô 349", file: "baking monkey.png" },
      { name: "Plong√©e Baleine ü™ô 2150", file: "Baleine.png" },
      { name: "ballon coeur ü™ô 150", file: "ballonamour.png" },
      { name: "Stand des Amoureux ü™ô 2199", file: "Bar √† citron.png" },
      { name: "basketball ü™ô 1", file: "basketball.png" },
      { name: "Batterie ü™ô 1000", file: "Batterie.png" },
      { name: "Ours Surfeur ü™ô 800", file: "Bear Blind Box.Png" },
      { name: "Devenir un Chaton ü™ô 349", file: "Become Kitten.png" },
      { name: "Benny B√©b√© Rhino ü™ô 4999", file: "Berry.png" },
      { name: "Bisous Loutre ü™ô 399", file: "Bisous Loutre.png" },
      { name: "bisous ü™ô 1", file: "bisous.png" },
      { name: "bubblegum ü™ô 99", file: "bubblegum.png" },
      { name: "calin de teddy ü™ô 399", file: "calin de teddy.png" },
      { name: "Camion de glace ü™ô 2988", file: "Camion de glace.png" },
      { name: "Capybara ü™ô 30", file: "capybara.png" },
      { name: "Carrousel ü™ô 1999", file: "Carrousel.png" },
      { name: "Carte de Voeux ü™ô 1500", file: "carte de voeux.png" },
      { name: "Casquette ü™ô 99", file: "Casquette.png" },
      { name: "Chaise Gaming ü™ô 1200", file: "Chaise Gaming.png" },
      { name: "chapeau moustache ü™ô 99", file: "chapeaumoustache.png" },
      { name: "G√©nial ü™ô 1", file: "chaton.png" },
      { name: "Chaos de la Chenille ü™ô 149", file: "chenilledodo.png" },
      { name: "Compagnon Citronn√©e ü™ô 199", file: "citronnade.png" },
      { name: "Clavier Gaming ü™ô 4000", file: "Clavier gamer.png" },
      { name: "Cochon Amoureux ü™ô 10", file: "cochonamoureux.Png" },

      { name: "Coeur ü™ô 199", file: "Coeur bisous.png" },
      { name: "Coeur Unis ü™ô 299", file: "Coeur Uni.png" },
      { name: "Coeur avec les mains ü™ô 100", file: "coeuraveclesmains.png" },
      { name: "Coeur dans les mains ü™ô 100", file: "Coeurdanslesmains.png" },
      { name: "coeur doigt ü™ô 5", file: "coeurdoigt.png" },
      { name: "coeur du jour ü™ô 1", file: "coeurdujour.png" },
      { name: "coeur en flammes ü™ô 1", file: "coeureenflammes.png" },
      { name: "coeur nuage ü™ô 1", file: "coeurnuage.png" },

      { name: "Collier amiti√© ü™ô 10", file: "collierami.png" },
      { name: "Saxophone de Rosie ü™ô 399 ", file: "Concert de Rosie.png" },
      { name: "Confettis ü™ô 100", file: "confetti.png" },
      { name: "Cool ü™ô 1", file: "Cool.png" },
      { name: "Cooper rentre en.. ü™ô 1999", file: "Cooper.png" },
      { name: "Coquillage ü™ô 100", file: "coquillage.png" },
      { name: "Corail ü™ô 499", file: "corail.png" },
      { name: "Corgi ü™ô 299", file: "corgi.png" },
      { name: "Cote √† C√¥te ü™ô 199", file: "Coteacote.png" },
      { name: "Couple puissant ü™ô 2000", file: "Couple puissant.png" },
      { name: "Couronnes Dragon ü™ô 500", file: "Couronnes Dragon.png" },
      { name: "Couronne TikTok ü™ô 299", file: "couronnes TikTok.png" },
      { name: "Crabe acclamant ü™ô 199", file: "crabe.png" },
      { name: "Crini√®re Lion ü™ô 500", file: "Crini√®re lion.png" },
      { name: "Cygne ü™ô 699", file: "cygne.png" },
      { name: "Ours Rythmique ü™ô 2999", file: "Dancing Bear.png" },
      { name: "Fusil √† Diamant ü™ô 5000", file: "Diamond gun.png" },
      { name: "Casquette Dino ü™ô 200", file: "dinocap.png" },
      { name: "Lunettes de DJ ü™ô 500", file: "Dj glasses.Png" },
      { name: "Donut ü™ô 30", file: "donuts.png" },
      { name: "Drift en voiture ü™ô 3000", file: "Drift.png" },
      { name: "eclair ü™ô 1", file: "eclair.png" },
      { name: "Elise l'√©l√©phante ü™ô 5000", file: "Elise l'√©l√©phant.Png" },
      { name: "Empreinte de Dino ü™ô 1", file: "empreintedino.png" },
      { name: "etoile √©tincelante ü™ô 199", file: "etoileetincelante.png" },
      { name: "Famille ü™ô 90", file: "famille.png" },
      { name: "Feu d'artifice ü™ô 1088", file: "Feu d'artifice.png" },
      { name: "Puissance Max ü™ô399", file: "Fire up.png" },
      { name: "Poing contre Poing ü™ô 90", file: "fistbump.png" },

      { name: " Bou√©e Flamant Rose ü™ô999", file: "flamant rose.Png" },
      { name: "fleur S ü™ô 20", file: "fleurenS.png" },
      { name: "Rencontre du Futur ü™ô 1500", file: "Futur.png" },
      { name: "Galaxie ü™ô 1000", file: "Galaxie.png" },
      { name: "Ours Gameur ü™ô 4088", file: "Gaming Bear.png" },
      { name: "Gant de Boxe ü™ô 299", file: "gantdeboxe.png" },
      { name: "Gant Dor√©e ü™ô 10", file: "gantdor√©e.png" },
      { name: "Part de Gateau D'anniversaire ü™ô 1", file: "gateauanniv.png" },
      { name: "Part de Gateau ü™ô 1", file: "gateaupart.png" },
      { name: "gg ü™ô 1", file: "gg.png" },
      { name: "Girafe ü™ô 1000", file: "Girafe.Png" },
      { name: "Glace ü™ô 5", file: "glace.png" },
      { name: "B√¢ton brillant ü™ô 1", file: "glow.png" },
      { name: "Grande Rose ü™ô 500", file: "Grande Roses.png" },
      { name: "Grue ü™ô 100", file: "grue.png" },
      { name: "Par√¥le d'amour ü™ô 1", file: "heartlytalyk.png" },
      { name: "ice-cream ü™ô 1", file: "ice-cream.png" },
      { name: "Jet volant ü™ô 5000 ", file: "Jet volant.png" },
      { name: "Je T'aime ü™ô 199", file: "jetaime.png" },
      { name: "Pass Aventure ü™ô 10", file: "journepass.png" },
      { name: "Sourire Juteux ü™ô 199", file: "juicysmile.png" },
      { name: "Eau De Coco ü™ô 199", file: "jusdecoco.png" },
      { name: "Leon le chaton ü™ô 4888", file: "Leon le chaton.png" },
      { name: "Loup d'arabie ü™ô 5500", file: "Loup D'arabie.png" },
      { name: "Peinture D'amour ü™ô 99", file: "lovepainting.png" },
      { name: "Lunettes de Soleil ü™ô 199", file: "lunettesdesoleil.png" },
      { name: "Magie du Caf√© ü™ô 199 ", file: "magieducafe.png" },
      { name: "Mama Mia ü™ô 1", file: "mamamia.png" },
      { name: "Manettes ü™ô 100", file: "Manettes.png" },
      { name: "Manifestation XXL ü™ô 1500", file: "Manifestation XXL.png" },
      { name: "Amour Astronaute ü™ô 349", file: "Marked With love.png" },
      { name: "Marque D'amour ü™ô 99", file: "marquedamour.png" },
      { name: "Masque Pharaon ü™ô 399", file: "masque pharaon.png" },
      { name: "masque ü™ô 149", file: "masque.png" },
      { name: "Un grand Bravo ü™ô 149", file: "megaphone.png" },
      { name: "Pistolet Billets ü™ô 500", file: "Money Gun.png" },
      { name: "Magnettes d'argent ü™ô 549", file: "Money Magnet.png" },
      { name: "Mongolfiere ü™ô 1000", file: "Mongolfiere.Png" },

      { name: "Fleur clair de Lune ü™ô 1400", file: "Moonlight Flower.png" },
      { name: "Moto ü™ô 2988", file: "Moto.png" },
      { name: "noeud papillon ü™ô 149", file: "noeudpapillon.png" },
      { name: "Oie D√©tendu ü™ô 399", file: "Oie d√©tendu.png" },
      { name: "Bisous Joyeux ü™ô 199", file: "oiseau.png" },
      { name: "Ours Dansant ü™ô 3000", file: "ours rythmic.png" },
      { name: "Ours de Rose ü™ô 214", file: "oursderose.png" },
      { name: "Ourson ü™ô 100", file: "ourson.png" },
      { name: "Panda Climb ü™ô 199", file: "pandaclimb.png" },
      { name: "Papillon ü™ô 88", file: "Papillon.png" },
      { name: "Parfum ü™ô 20", file: "parfum.png" },
      { name: "Bus Festif ü™ô 2999", file: "Party Bus.png" },
      { name: "Patate qui flotte ü™ô 1500", file: "Patate qui flottre.png" },
      { name: "P√™che ü™ô 5", file: "peche.png" },
      { name: "Petite couronne ü™ô 99", file: "petitecouronne.png" },
      { name: "Pingouin qui surf ü™ô 249", file: "pingouinsurf.png" },
      { name: "Pluie de m√©t√©ores ü™ô 3000", file: "Pluie de m√©t√©ore.png" },
      { name: "Pneu ü™ô 1", file: "pneu.png" },
      { name: "Polaris ü™ô 500", file: "Polaris.png" },
      { name: "Popcorn ü™ô 149", file: "popcorn.png" },
      { name: "Populaire ü™ô 1", file: "populaire.png" },
      { name: "Positivit√© ü™ô 199", file: "positivit√©.png" },
      { name: "Pouce vers le haut ü™ô 2", file: "pouceverslehaut.png" },
      { name: "Poulet espi√®gles ü™ô 299", file: "Poulet espi√®gles.png" },
      { name: "Poulpe ü™ô 199", file: "poulpe.png" },
      { name: "Poursuit tes r√™ves ü™ô 1500", file: "Poursuit tes reves.png" },
      { name: "Prince ü™ô 500", file: "Prince.png" },
      { name: "Jet Priv√© ü™ô 4888", file: "Private Jet.png" },
      { name: "Bisous Chiot ü™ô 299", file: "Puppy kiss.png" },
      { name: "Refuge de l'amour ü™ô 1200", file: "Refude de l'amour.png" },
      { name: "Rocky Rockeur ü™ô 399", file: "Rocky.png" },
      { name: "Rosa ü™ô 10", file: "rosa.png" },
      { name: "Rose √† jamais ü™ô 399", file: "Rose √† jamais.png" },
      { name: "Rose √† Main ü™ô 199", file: "Rose pour toi.png" },
      { name: "rose ü™ô 1", file: "rose.png" },
      { name: "rose blanche ü™ô 1", file: "roseblanche.png" },
      { name: "Sage Fut√© ü™ô 399", file: "sage intelligent.png" },
      { name: "slay ü™ô 1", file: "slay.png" },
      { name: "Sous contr√¥les ü™ô 1500", file: "Sous contr√¥les.Png" },

      { name: "Chat de L'espace ü™ô 1500", file: "Space Cat.png" },
      { name: "Chien de L'espace ü™ô 2500", file: "Space dog.png" },
      { name: "Steven Wingman ü™ô 1", file: "steven.png" },
      { name: "Super GG ü™ô 100", file: "supergg.png" },
      { name: "Super Populaire ü™ô 9", file: "superpopulaire.png" },
      { name: "Taureau ü™ô 3000", file: "taureau.Png" },
      { name: "Tcheck ü™ô 299", file: "tcheck.png" },
      { name: "tiktok ü™ô 1", file: "tiktok.png" },
      { name: "Tofu ü™ô 5", file: "tofu.png" },
      { name: "Tom la Tomate ü™ô 1", file: "tomtomate.png" },
      { name: "Ton concert ü™ô 4500", file: "ton concert.png" },
      { name: "Train ü™ô 899", file: "Train.png" },
      { name: "transfo patate ü™ô 150", file: "transfopatate.png" },
      { name: "Trompe D'√©l√©phant ü™ô 299", file: "trompe d'√©l√©phant.png" },
      { name: "Troph√©e Basket ü™ô 700", file: "Troph√©e Basket.png" },
      { name: "umake me so happy ü™ô 30", file: "umakemisohappy.png" },
      { name: "Vaisseau de Level ü™ô 1500", file: "Vaisseau de Level.png" },
      { name: "Vaisseau spatial ü™ô 4999", file: "Vaisseau spacial.png" },
      { name: "Voyage avec toi ü™ô 999", file: "Voyage avec toi.png" },
      { name: "Mercredi Gagnant ü™ô 99", file: "winningwednesday.png" },
      { name: "FLeurs XXXL ü™ô 500", file: "XXL flower.png" },
      { name: "you are my jam ü™ô 30", file: "youaremyjam.png" },
      { name: "you are on a roll ü™ô 30", file: "youaremyroll.png" }
    ];

    const state = {
      selectedGiftUrl: null,
      selectedGiftName: null,
      cells: [],
      labels: [],
      cols: 5,
      rows: 3,
      round: 22,
      gap: 26,

      bgType: "none", // none | image | video
      bgImage: null,
      bgVideo: null,

      panelRgb: [255, 60, 90],
      panelAlpha: 0.22,
      hudAlpha: 0.85,

      bounceEnabled: false,
      bounceAmp: 8,
      bounceSpeed: 1.3
    };

    // DOM
    const stage = document.getElementById("stage");
    const grid = document.getElementById("grid");

    const bgImageInput = document.getElementById("bgImageInput");
    const bgVideoInput = document.getElementById("bgVideoInput");
    const clearBgBtn = document.getElementById("clearBg");
    const toggleVideoBtn = document.getElementById("toggleVideo");
    const muteVideoBtn = document.getElementById("muteVideo");

    const bgImgEl = document.getElementById("bgImg");
    const bgVidEl = document.getElementById("bgVid");

    const giftSelect = document.getElementById("giftSelect");
    const giftThumb = document.getElementById("giftThumb");
    const giftName = document.getElementById("giftName");
    const deselectBtn = document.getElementById("deselect");

    const layout = document.getElementById("layout");
    const roundRange = document.getElementById("round");
    const roundVal = document.getElementById("roundVal");
    const gapRange = document.getElementById("gap");
    const gapVal = document.getElementById("gapVal");

    const panelColor = document.getElementById("panelColor");
    const density = document.getElementById("density");
    const densityVal = document.getElementById("densityVal");
    const hud = document.getElementById("hud");
    const hudVal = document.getElementById("hudVal");

    const bounceToggle = document.getElementById("bounceToggle");
    const bounceAmp = document.getElementById("bounceAmp");
    const bounceAmpVal = document.getElementById("bounceAmpVal");
    const bounceSpeed = document.getElementById("bounceSpeed");
    const bounceSpeedVal = document.getElementById("bounceSpeedVal");

    const resetGridBtn = document.getElementById("resetGrid");
    const exportBtn = document.getElementById("exportPng");
    const exportRes = document.getElementById("exportRes");
    const recordBtn = document.getElementById("recordBtn");
    const statusBox = document.getElementById("statusBox");

    // renderer resources
    const giftCache = new Map();

    function showStatus(msg){
      statusBox.textContent = msg;
      statusBox.classList.add("show");
    }
    function hideStatus(){
      statusBox.classList.remove("show");
      statusBox.textContent = "";
    }

    function setCSSVars(){
      document.documentElement.style.setProperty("--cols", state.cols);
      document.documentElement.style.setProperty("--rows", state.rows);
      document.documentElement.style.setProperty("--r", state.round + "px");
      document.documentElement.style.setProperty("--gap", state.gap + "px");
      document.documentElement.style.setProperty("--panelAlpha", String(state.panelAlpha));
      document.documentElement.style.setProperty("--hudAlpha", String(state.hudAlpha));
      document.documentElement.style.setProperty("--panelColor", `${state.panelRgb[0]}, ${state.panelRgb[1]}, ${state.panelRgb[2]}`);

      document.documentElement.style.setProperty("--bounceAmp", state.bounceAmp + "px");
      document.documentElement.style.setProperty("--bounceSpeed", String(state.bounceSpeed));

      document.body.classList.toggle("bounce-on", !!state.bounceEnabled);
      bounceToggle.classList.toggle("is-on", !!state.bounceEnabled);
      bounceToggle.setAttribute("aria-checked", String(!!state.bounceEnabled));

      roundVal.textContent = state.round;
      gapVal.textContent = state.gap;
      densityVal.textContent = state.panelAlpha.toFixed(2);
      hudVal.textContent = state.hudAlpha.toFixed(2);

      bounceAmpVal.textContent = state.bounceAmp;
      bounceSpeedVal.textContent = state.bounceSpeed.toFixed(2);
    }

    function parseCoinsFromName(name){
      const m = name.match(/ü™ô\s*(\d+)/);
      return m ? Number(m[1]) : Number.POSITIVE_INFINITY;
    }

    function getSortedGiftIndexes(){
      return GIFTS
        .map((g, idx) => ({ idx, coins: parseCoinsFromName(g.name), name: g.name }))
        .sort((a, b) => (a.coins - b.coins) || a.name.localeCompare(b.name, "fr"))
        .map(x => x.idx);
    }

    function renderGiftSelect(){
      giftSelect.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "‚Äî Aucun (d√©s√©lectionn√©) ‚Äî";
      giftSelect.appendChild(opt0);

      const sortedIdx = getSortedGiftIndexes();
      sortedIdx.forEach((idx) => {
        const g = GIFTS[idx];
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = `üéÅ ${g.name}`;
        giftSelect.appendChild(opt);
      });
    }

    function renderGiftPreview(){
      giftThumb.innerHTML = "";
      if(!state.selectedGiftUrl){
        giftName.textContent = "Aucun cadeau s√©lectionn√©";
        return;
      }
      giftName.textContent = state.selectedGiftName || "Cadeau";
      const img = document.createElement("img");
      img.src = state.selectedGiftUrl;
      img.alt = state.selectedGiftName || "cadeau";
      giftThumb.appendChild(img);
    }

    function setSelectedGift(gift){
      if(!gift){
        state.selectedGiftUrl = null;
        state.selectedGiftName = null;
        renderGiftPreview();
        renderGrid();
        return;
      }
      state.selectedGiftUrl = `./${gift.file}`;
      state.selectedGiftName = gift.name;
      renderGiftPreview();
      renderGrid();
    }

    function ensureArraysSize(){
      const total = state.cols * state.rows;
      if(!Array.isArray(state.cells)) state.cells = [];
      if(!Array.isArray(state.labels)) state.labels = [];

      if(state.cells.length !== total){
        const old = state.cells.slice();
        state.cells = new Array(total).fill(null);
        for(let i=0; i<Math.min(old.length, total); i++) state.cells[i] = old[i];
      }
      if(state.labels.length !== total){
        const oldL = state.labels.slice();
        state.labels = new Array(total).fill("");
        for(let i=0; i<Math.min(oldL.length, total); i++) state.labels[i] = oldL[i] || "";
      }
    }

    function applySizingForLayout(){
      const inset = (window.innerWidth <= 980) ? 18 : 40;

      const stageW = stage.clientWidth;
      const stageH = stage.clientHeight;

      const availW = Math.max(200, stageW - inset * 2);
      const availH = Math.max(200, stageH - inset * 2);

      const labelSpace = 56;
      const rows = state.rows;
      const cols = state.cols;
      const gap = state.gap;

      const cellW = Math.floor((availW - (cols - 1) * gap) / cols);
      const cellH = Math.floor((availH - (rows - 1) * gap) / rows - labelSpace);

      let cell = Math.min(cellW, cellH);

      const minCell = (window.innerWidth <= 980) ? 92 : 110;
      const maxCell = 210;
      cell = Math.max(minCell, Math.min(maxCell, cell));

      document.documentElement.style.setProperty("--cellSize", cell + "px");
    }

    function setLayout(value){
      const [c, r] = value.split("x").map(Number);
      state.cols = c;
      state.rows = r;
      state.cells = new Array(c * r).fill(null);
      state.labels = new Array(c * r).fill("");
      setCSSVars();
      applySizingForLayout();
      renderGrid();
    }

    function editLabelAt(index){
      const current = (state.labels[index] || "").toString();
      const next = prompt("Texte sous la case (vide = supprimer) :", current);
      if(next === null) return;
      state.labels[index] = (next || "").trim();
      renderGrid();
    }

    function renderGrid(){
      ensureArraysSize();
      grid.innerHTML = "";

      const total = state.cols * state.rows;

      for(let i=0; i<total; i++){
        const tile = document.createElement("div");
        tile.className = "tile";

        const cell = document.createElement("div");
        cell.className = "cell";

        const scan = document.createElement("div");
        scan.className = "scanline";
        const frame = document.createElement("div");
        frame.className = "neonFrame";
        const ticks = document.createElement("div");
        ticks.className = "ticks";
        const glitch = document.createElement("div");
        glitch.className = "glitch";

        cell.appendChild(scan);
        cell.appendChild(frame);
        cell.appendChild(ticks);
        cell.appendChild(glitch);

        const url = state.cells[i];

        if(url){
          const wrap = document.createElement("div");
          wrap.className = "giftInCell";
          const img = document.createElement("img");
          img.src = url;
          img.alt = "gift";
          wrap.appendChild(img);
          cell.appendChild(wrap);
        } else {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = state.selectedGiftUrl ? "Clique pour placer ‚òÅÔ∏è" : "Choisis un cadeau ü©∏";
          cell.appendChild(empty);
        }

        cell.addEventListener("click", (e) => {
          if(e.ctrlKey || e.metaKey){
            editLabelAt(i);
            return;
          }
          if(!state.selectedGiftUrl) return;
          state.cells[i] = state.selectedGiftUrl;
          renderGrid();
        });

        cell.addEventListener("dblclick", () => {
          state.cells[i] = null;
          renderGrid();
        });

        cell.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          editLabelAt(i);
        });

        const label = document.createElement("div");
        label.className = "cellLabel";
        const txt = (state.labels[i] || "").trim();
        if(!txt){
          label.classList.add("is-empty");
          label.textContent = "‚Äî";
        } else {
          label.textContent = txt;
        }
        label.addEventListener("dblclick", () => editLabelAt(i));

        tile.appendChild(cell);
        tile.appendChild(label);
        grid.appendChild(tile);
      }
    }

    // Background
    function clearBackground(){
      state.bgType = "none";
      bgImgEl.style.display = "none";
      bgVidEl.style.display = "none";
      bgImgEl.src = "";
      bgVidEl.src = "";
      bgImageInput.value = "";
      bgVideoInput.value = "";
      state.bgImage = null;
      state.bgVideo = null;
    }

    function setBackgroundImage(file){
      const url = URL.createObjectURL(file);
      state.bgType = "image";
      bgVidEl.pause();
      bgVidEl.style.display = "none";
      bgImgEl.style.display = "block";
      bgImgEl.onload = () => { state.bgImage = bgImgEl; };
      bgImgEl.src = url;
    }

    function setBackgroundVideo(file){
      const url = URL.createObjectURL(file);
      state.bgType = "video";
      bgImgEl.style.display = "none";
      bgVidEl.style.display = "block";
      bgVidEl.muted = true;
      bgVidEl.loop = true;
      bgVidEl.onloadeddata = () => {
        state.bgVideo = bgVidEl;
        bgVidEl.play().catch(()=>{});
      };
      bgVidEl.src = url;
    }

    // Export helpers
    function roundRectPath(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    function getCoverDrawParams(srcW, srcH, dstW, dstH){
      const s = Math.max(dstW / srcW, dstH / srcH);
      const drawnW = srcW * s;
      const drawnH = srcH * s;
      const offsetX = (dstW - drawnW) / 2;
      const offsetY = (dstH - drawnH) / 2;
      return { s, drawnW, drawnH, offsetX, offsetY };
    }

    function loadImageCached(url){
      if(giftCache.has(url)) return giftCache.get(url);
      const p = new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = url;
      });
      giftCache.set(url, p);
      return p;
    }

    function wrapText(ctx, text, maxWidth, maxLines){
      const words = text.split(/\s+/).filter(Boolean);
      const lines = [];
      let line = "";
      for(const w of words){
        const test = line ? (line + " " + w) : w;
        const width = ctx.measureText(test).width;
        if(width <= maxWidth){
          line = test;
        } else {
          if(line) lines.push(line);
          line = w;
          if(lines.length >= maxLines-1) break;
        }
      }
      if(line && lines.length < maxLines) lines.push(line);
      return lines;
    }

    // ‚úÖ Pattern "CSS-like" pour √©viter le quadrillage bizarre en export
    let DIAG_PATTERN = null;
    function getDiagPattern(ctx){
      if (DIAG_PATTERN) return DIAG_PATTERN;

      // Tile 14px (3px bande + 11px vide) -> on fait une tile un peu plus grande pour lisser
      const tile = document.createElement("canvas");
      tile.width = 28;
      tile.height = 28;
      const p = tile.getContext("2d");

      p.clearRect(0,0,tile.width,tile.height);
      p.strokeStyle = "rgba(255,255,255,0.10)";
      p.lineWidth = 3;

      // diagonales 135¬∞ (comme repeating-linear-gradient(135deg,...))
      p.beginPath();
      p.moveTo(-10, 14);
      p.lineTo(38, -34);
      p.stroke();

      p.beginPath();
      p.moveTo(-10, 42);
      p.lineTo(38, -6);
      p.stroke();

      DIAG_PATTERN = ctx.createPattern(tile, "repeat");
      return DIAG_PATTERN;
    }

    // ---- Canvas renderer (PNG + video)
    function drawNeonPanel(ctx, x, y, size, r, rgb, alpha, hudAlpha, t){
      const [R,G,B] = rgb;

      // base panel (clipped)
      ctx.save();
      roundRectPath(ctx, x, y, size, size, r);
      ctx.clip();

      // colored glow radial
      const g1 = ctx.createRadialGradient(x+size*0.30, y+size*0.22, size*0.08, x+size*0.30, y+size*0.22, size*0.75);
      g1.addColorStop(0, `rgba(${R},${G},${B},${alpha*0.55})`);
      g1.addColorStop(1, `rgba(${R},${G},${B},0)`);
      ctx.fillStyle = g1;
      ctx.fillRect(x,y,size,size);

      // white highlight radial
      const g2 = ctx.createRadialGradient(x+size*0.75, y+size*0.78, size*0.10, x+size*0.75, y+size*0.78, size*0.85);
      g2.addColorStop(0, `rgba(255,255,255,${alpha*0.22})`);
      g2.addColorStop(1, `rgba(255,255,255,0)`);
      ctx.fillStyle = g2;
      ctx.fillRect(x,y,size,size);

      // dark base
      const lg = ctx.createLinearGradient(x,y,x,y+size);
      lg.addColorStop(0, `rgba(0,0,0,0.16)`);
      lg.addColorStop(1, `rgba(0,0,0,0.34)`);
      ctx.fillStyle = lg;
      ctx.fillRect(x,y,size,size);

      // ‚úÖ micro pattern via pattern + overlay (match CSS, pas de moir√©)
      ctx.save();
      ctx.globalAlpha = Math.min(1, alpha*0.9);
      const oldComp = ctx.globalCompositeOperation;
      ctx.globalCompositeOperation = "overlay"; // si pas support√©, √ßa reste "source-over" (ok)
      ctx.fillStyle = getDiagPattern(ctx);
      ctx.fillRect(x, y, size, size);
      ctx.globalCompositeOperation = oldComp;
      ctx.globalAlpha = 1;
      ctx.restore();

      // scanline (animated)
      const scanY = ( (t*0.35) % 1 ) * (size*1.7) - size*0.6;
      ctx.save();
      ctx.globalAlpha = hudAlpha * 0.40;
      ctx.translate(x, y);
      ctx.rotate(12 * Math.PI/180);
      const scanGrad = ctx.createLinearGradient(-size*0.2, scanY, size*1.2, scanY);
      scanGrad.addColorStop(0, "rgba(255,255,255,0)");
      scanGrad.addColorStop(0.5, "rgba(255,255,255,0.14)");
      scanGrad.addColorStop(1, "rgba(255,255,255,0)");
      ctx.fillStyle = scanGrad;
      ctx.fillRect(-size*0.6, scanY, size*2.2, size*0.22);
      ctx.restore();

      // tiny glitch strip occasionally
      const glitchOn = (Math.sin(t*2.1 + (x+y)*0.001) > 0.985);
      if(glitchOn){
        ctx.globalAlpha = hudAlpha * 0.55;
        ctx.fillStyle = `rgba(${R},${G},${B},0.22)`;
        ctx.fillRect(x, y + size*0.18, size, Math.max(2, size*0.03));
        ctx.globalAlpha = 1;
      }

      ctx.restore();

      // border pulse
      const pulse = 0.5 + 0.5*Math.sin(t*2.7 + (x+y)*0.003);
      const glowA = (0.12 + pulse*0.12) * hudAlpha;
      const strokeA = (0.30 + pulse*0.22) * hudAlpha;

      // glow outer
      ctx.save();
      ctx.shadowColor = `rgba(${R},${G},${B},${glowA})`;
      ctx.shadowBlur = 18 + pulse*10;
      roundRectPath(ctx, x, y, size, size, r);
      ctx.strokeStyle = `rgba(${R},${G},${B},${strokeA})`;
      ctx.lineWidth = 6;
      ctx.stroke();
      ctx.restore();

      // crisp inner stroke + corner ticks
      ctx.save();
      roundRectPath(ctx, x, y, size, size, r);
      const grad = ctx.createLinearGradient(x, y, x+size, y+size);
      grad.addColorStop(0, `rgba(${R},${G},${B},${0.55*hudAlpha})`);
      grad.addColorStop(0.5, `rgba(255,255,255,${0.14*hudAlpha})`);
      grad.addColorStop(1, `rgba(${R},${G},${B},${0.38*hudAlpha})`);
      ctx.strokeStyle = grad;
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.strokeStyle = `rgba(${R},${G},${B},${0.55*hudAlpha})`;
      ctx.lineWidth = 2;
      const tick = Math.max(12, size*0.10);
      // top-left
      ctx.beginPath();
      ctx.moveTo(x+10, y+10+tick);
      ctx.lineTo(x+10, y+10);
      ctx.lineTo(x+10+tick, y+10);
      ctx.stroke();
      // bottom-right
      ctx.beginPath();
      ctx.moveTo(x+size-10, y+size-10-tick);
      ctx.lineTo(x+size-10, y+size-10);
      ctx.lineTo(x+size-10-tick, y+size-10);
      ctx.stroke();

      ctx.restore();
    }

    async function buildGiftMap(){
      const uniqueGiftUrls = Array.from(new Set(state.cells.filter(Boolean)));
      const imgs = await Promise.all(uniqueGiftUrls.map(loadImageCached));
      const map = new Map();
      uniqueGiftUrls.forEach((u,i) => map.set(u, imgs[i]));
      return map;
    }

    function computeGridLayout(W, H){
      const inset = 40;
      const availW = W - inset*2;
      const availH = H - inset*2;

      const cols = state.cols;
      const rows = state.rows;
      const gap = state.gap;
      const labelSpace = 56;

      let cell = Math.min(
        Math.floor((availW - (cols-1)*gap)/cols),
        Math.floor((availH - (rows-1)*gap)/rows - labelSpace)
      );
      cell = Math.max(110, Math.min(220, cell));

      const gridW = cols*cell + (cols-1)*gap;
      const gridH = rows*cell + (rows-1)*gap + rows*labelSpace;

      const gridX = Math.round((W - gridW)/2);
      const gridY = Math.round((H - gridH)/2);

      return { cols, rows, gap, cell, labelSpace, gridX, gridY };
    }

    function drawBackground(ctx, W, H){
      ctx.clearRect(0,0,W,H);

      if(state.bgType === "image" && state.bgImage?.naturalWidth){
        const src = state.bgImage;
        const cover = getCoverDrawParams(src.naturalWidth, src.naturalHeight, W, H);
        ctx.drawImage(src, 0,0,src.naturalWidth,src.naturalHeight, cover.offsetX, cover.offsetY, cover.drawnW, cover.drawnH);
      } else if(state.bgType === "video" && state.bgVideo?.videoWidth){
        const src = state.bgVideo;
        const cover = getCoverDrawParams(src.videoWidth, src.videoHeight, W, H);
        ctx.drawImage(src, 0,0,src.videoWidth,src.videoHeight, cover.offsetX, cover.offsetY, cover.drawnW, cover.drawnH);
      } else {
        ctx.fillStyle = "rgba(10,8,14,1)";
        ctx.fillRect(0,0,W,H);
      }

      const vign = ctx.createRadialGradient(W*0.5, H*0.35, Math.min(W,H)*0.12, W*0.5, H*0.5, Math.max(W,H)*0.75);
      vign.addColorStop(0, "rgba(0,0,0,0)");
      vign.addColorStop(1, "rgba(0,0,0,0.50)");
      ctx.fillStyle = vign;
      ctx.fillRect(0,0,W,H);
    }

    function drawLabels(ctx, x, y, cell, labelSpace, label){
      const txt = (label || "").trim();
      if(!txt) return;

      const ly = y + cell + 8;
      const fontSize = Math.round(cell * 0.17);
      ctx.font = `900 ${fontSize}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial`;

      const maxW = cell;
      const lines = wrapText(ctx, txt.toUpperCase(), maxW, 2);

      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      ctx.lineWidth = Math.max(6, fontSize * 0.32);
      ctx.strokeStyle = "rgba(0,0,0,0.92)";
      ctx.fillStyle = "rgba(255,255,255,0.96)";

      let yy = ly;
      for(const line of lines){
        ctx.strokeText(line, x + cell/2, yy);
        ctx.fillText(line, x + cell/2, yy);
        yy += fontSize * 1.05;
      }
    }

    function bounceOffsetPx(tSec, i){
      if(!state.bounceEnabled) return 0;
      const phase = (i * 0.55) % (Math.PI * 2);
      const s = Math.sin((tSec * 2 * Math.PI * state.bounceSpeed) + phase);
      return -Math.max(0, s) * state.bounceAmp;
    }

    async function renderToCanvas(canvas, tSec){
      const ctx = canvas.getContext("2d");
      const W = canvas.width;
      const H = canvas.height;

      drawBackground(ctx, W, H);

      const layout = computeGridLayout(W, H);
      const giftMap = await buildGiftMap();

      for(let row=0; row<layout.rows; row++){
        for(let col=0; col<layout.cols; col++){
          const i = row*layout.cols + col;
          const x = layout.gridX + col*(layout.cell+layout.gap);
          const y = layout.gridY + row*(layout.cell+layout.gap+layout.labelSpace);

          drawNeonPanel(ctx, x, y, layout.cell, state.round, state.panelRgb, state.panelAlpha, state.hudAlpha, tSec);

          const url = state.cells[i];
          if(url){
            const img = giftMap.get(url);
            if(img){
              const pad = layout.cell * 0.16;
              const gx = x + pad;
              const gy = y + pad;
              const gw = layout.cell - pad*2;
              const gh = layout.cell - pad*2;

              const by = bounceOffsetPx(tSec, i);

              ctx.save();
              ctx.shadowColor = "rgba(0,0,0,0.62)";
              ctx.shadowBlur = 18;
              ctx.shadowOffsetY = 12;
              ctx.drawImage(img, gx, gy + by, gw, gh);
              ctx.restore();
            }
          }

          drawLabels(ctx, x, y, layout.cell, layout.labelSpace, state.labels[i]);
        }
      }
    }

    async function exportPNG(){
      exportBtn.disabled = true;
      exportBtn.textContent = "‚è≥ Export‚Ä¶";
      document.body.classList.add("exporting");
      hideStatus();

      try{
        const [W, H] = exportRes.value.split("x").map(Number);
        const canvas = document.createElement("canvas");
        canvas.width = W;
        canvas.height = H;

        await renderToCanvas(canvas, performance.now()/1000);

        const dataUrl = canvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = `overlay-akatsuki-${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch(err){
        console.error(err);
        alert("Export PNG impossible. V√©rifie les noms de fichiers cadeaux.");
      } finally {
        document.body.classList.remove("exporting");
        exportBtn.disabled = false;
        exportBtn.textContent = "Exporter en PNG";
      }
    }

    // ---- VIDEO RECORDING (WEBM) - t√©l√©chargement garanti au stop
    let recorder = null;
    let recordStream = null;
    let recordChunks = [];
    let recordCanvas = null;
    let recording = false;
    let rafId = null;

    function pickSupportedMime(){
      const candidates = [
        "video/webm;codecs=vp9",
        "video/webm;codecs=vp8",
        "video/webm"
      ];
      return candidates.find(t => window.MediaRecorder && MediaRecorder.isTypeSupported(t)) || "";
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 7000);
    }

    async function startRecording(){
      if(recording) return;
      hideStatus();

      if(!window.MediaRecorder){
        alert("MediaRecorder non support√©. Essaie Chrome/Edge.");
        return;
      }
      if(!HTMLCanvasElement.prototype.captureStream){
        alert("captureStream non support√©. Essaie Chrome/Edge.");
        return;
      }

      const [W, H] = exportRes.value.split("x").map(Number);
      recordCanvas = document.createElement("canvas");
      recordCanvas.width = W;
      recordCanvas.height = H;

      const fps = 60;
      recordStream = recordCanvas.captureStream(fps);

      const mime = pickSupportedMime();
      try{
        recorder = new MediaRecorder(
          recordStream,
          mime ? { mimeType: mime, videoBitsPerSecond: 8_000_000 } : { videoBitsPerSecond: 8_000_000 }
        );
      } catch(e){
        console.error(e);
        alert("Enregistrement vid√©o non support√© (MediaRecorder). Essaie Chrome/Edge.");
        return;
      }

      recordChunks = [];
      recorder.ondataavailable = (e) => { if(e.data && e.data.size) recordChunks.push(e.data); };

      recorder.onerror = (e) => {
        console.error("Recorder error", e);
        showStatus("‚ùå Erreur MediaRecorder. Essaie Chrome/Edge et ouvre via un serveur (pas file://).");
      };

      recorder.onstop = () => {
        try{
          const type = recorder?.mimeType || "video/webm";
          const blob = new Blob(recordChunks, { type });
          if(!blob.size){
            showStatus("‚ùå Vid√©o vide. Essaie Chrome/Edge et ouvre via un serveur (http://).");
            return;
          }
          downloadBlob(blob, `overlay-akatsuki-${Date.now()}.webm`);
          showStatus("‚úÖ Vid√©o t√©l√©charg√©e !");
        } catch(err){
          console.error(err);
          showStatus("‚ùå Impossible de finaliser la vid√©o.");
        }
      };

      recording = true;
      recordBtn.classList.add("is-on");
      recordBtn.textContent = "‚èπÔ∏è Stop vid√©o";
      showStatus("‚è∫Ô∏è Enregistrement en cours‚Ä¶ (clique Stop pour t√©l√©charger)");

      try{
        recorder.start(200);
      } catch(e){
        console.error(e);
        showStatus("‚ùå D√©marrage enregistrement impossible.");
        recording = false;
        recordBtn.classList.remove("is-on");
        recordBtn.textContent = "‚è∫Ô∏è Enregistrer vid√©o";
        return;
      }

      const loop = async () => {
        if(!recording) return;
        await renderToCanvas(recordCanvas, performance.now()/1000);
        rafId = requestAnimationFrame(loop);
      };
      loop();
    }

    function stopRecording(){
      if(!recording) return;

      recording = false;
      recordBtn.classList.remove("is-on");
      recordBtn.textContent = "‚è∫Ô∏è Enregistrer vid√©o";
      showStatus("‚è≥ Finalisation‚Ä¶ t√©l√©chargement imminent");

      if(rafId) cancelAnimationFrame(rafId);
      rafId = null;

      try{
        if(recorder && recorder.state !== "inactive"){
          recorder.stop();
        }
      } catch(e){
        console.error(e);
        showStatus("‚ùå Stop impossible. Essaie de relancer la page.");
      } finally {
        recorder = null;
        recordStream = null;
        recordCanvas = null;
      }
    }

    // Controls wiring
    bgImageInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      setBackgroundImage(file);
    });
    bgVideoInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      setBackgroundVideo(file);
    });
    clearBgBtn.addEventListener("click", clearBackground);

    toggleVideoBtn.addEventListener("click", () => {
      if(state.bgType !== "video") return;
      if(bgVidEl.paused) bgVidEl.play().catch(()=>{});
      else bgVidEl.pause();
    });

    muteVideoBtn.addEventListener("click", () => {
      if(state.bgType !== "video") return;
      bgVidEl.muted = !bgVidEl.muted;
      muteVideoBtn.textContent = bgVidEl.muted ? "üîá" : "üîä";
    });

    giftSelect.addEventListener("change", () => {
      const v = giftSelect.value;
      if(v === ""){
        setSelectedGift(null);
        return;
      }
      const idx = Number(v);
      setSelectedGift(GIFTS[idx]);
    });

    deselectBtn.addEventListener("click", () => {
      giftSelect.value = "";
      setSelectedGift(null);
    });

    layout.addEventListener("change", (e) => setLayout(e.target.value));

    roundRange.addEventListener("input", (e) => {
      state.round = Number(e.target.value);
      setCSSVars();
    });

    gapRange.addEventListener("input", (e) => {
      state.gap = Number(e.target.value);
      setCSSVars();
      applySizingForLayout();
    });

    panelColor.addEventListener("input", (e) => {
      const hex = e.target.value;
      const r = parseInt(hex.slice(1,3), 16);
      const g = parseInt(hex.slice(3,5), 16);
      const b = parseInt(hex.slice(5,7), 16);
      state.panelRgb = [r,g,b];
      setCSSVars();
    });

    density.addEventListener("input", (e) => {
      state.panelAlpha = Number(e.target.value);
      setCSSVars();
    });

    hud.addEventListener("input", (e) => {
      state.hudAlpha = Number(e.target.value);
      setCSSVars();
    });

    // bounce controls
    function toggleBounce(){
      state.bounceEnabled = !state.bounceEnabled;
      setCSSVars();
    }
    bounceToggle.addEventListener("click", toggleBounce);
    bounceToggle.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        toggleBounce();
      }
    });

    bounceAmp.addEventListener("input", (e) => {
      state.bounceAmp = Number(e.target.value);
      setCSSVars();
    });

    bounceSpeed.addEventListener("input", (e) => {
      state.bounceSpeed = Number(e.target.value);
      setCSSVars();
    });

    resetGridBtn.addEventListener("click", () => {
      state.cells = new Array(state.cols * state.rows).fill(null);
      state.labels = new Array(state.cols * state.rows).fill("");
      renderGrid();
    });

    exportBtn.addEventListener("click", exportPNG);

    recordBtn.addEventListener("click", () => {
      if(!recording) startRecording();
      else stopRecording();
    });

    window.addEventListener("resize", () => applySizingForLayout());

    // Init
    renderGiftSelect();
    setCSSVars();
    setLayout(layout.value);
    renderGiftPreview();
    renderGrid();
    applySizingForLayout();
  </script>
</body>
</html>
