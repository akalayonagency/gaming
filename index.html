<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cr√©ateur d'overlay By Akatsuki Orga.</title>

  <!-- Export PNG -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg: #07060a;

      /* Akatsuki palette */
      --red: rgba(255, 60, 90, 1);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);

      /* Transparent menu */
      --menu: rgba(0,0,0,.18);
      --menu2: rgba(0,0,0,.10);

      --strokeRed: rgba(255, 60, 90, .35);

      --shadow: 0 18px 40px rgba(0,0,0,.45);
      --inner: inset 0 1px 0 rgba(255,255,255,.16), inset 0 -18px 40px rgba(0,0,0,.35);
      --r: 22px;

      /* grid vars */
      --cols: 5;
      --blur: 16px;
      --gap: 26px;

      /* default sizing for most layouts */
      --cellMin: 110px;
      --cellMax: 1fr;

      /* special: 3x2 auto-fit */
      --cellSize: 160px;

      /* label sizing */
      --labelGap: 10px;
      --labelMinH: 2.4em; /* ~2 lignes */
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      min-height:100vh;

      background:
        radial-gradient(900px 500px at 70% 15%, rgba(255,60,90,.18), transparent 60%),
        radial-gradient(900px 500px at 20% 75%, rgba(255,255,255,.06), transparent 60%),
        var(--bg);
    }

    .app{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
      padding: 18px;
      max-width: 1400px;
      margin: 0 auto;
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
    }

    /* MENU TRANSPARENT (glass) */
    .card{
      background: linear-gradient(180deg, var(--menu), var(--menu2));
      border: 1px solid var(--strokeRed);
      border-radius: 24px;
      box-shadow: var(--shadow);
      overflow:hidden;

      backdrop-filter: blur(14px) saturate(1.15);
      -webkit-backdrop-filter: blur(14px) saturate(1.15);
    }

    .sidebar{
      padding: 16px;
      position: sticky;
      top: 16px;
      height: fit-content;
    }

    .title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .title h1{
      font-size: 15px;
      line-height: 1.25;
      margin:0;
      letter-spacing:.2px;
    }
    .badge{
      font-size: 12px;
      color: rgba(255,255,255,.82);
      background: rgba(255,60,90,.12);
      border: 1px solid rgba(255,60,90,.35);
      padding: 6px 10px;
      border-radius: 999px;
      box-shadow: 0 0 0 3px rgba(255,60,90,.08);
      white-space:nowrap;
    }

    .section{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,.10);
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 800;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;

      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .btn:hover{
      background: rgba(0,0,0,.28);
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(180deg, rgba(255,60,90,.20), rgba(255,60,90,.10));
      border-color: rgba(255,60,90,.38);
      box-shadow: 0 0 0 3px rgba(255,60,90,.10);
    }
    .btn.primary:hover{ box-shadow: 0 0 0 3px rgba(255,60,90,.16); }

    .btn.danger{
      background: rgba(255,60,90,.12);
      border-color: rgba(255,60,90,.30);
    }

    input[type="file"]{
      width: 100%;
      padding: 10px;
      background: rgba(0,0,0,.18);
      border: 1px dashed rgba(255,255,255,.20);
      border-radius: 14px;
      color: rgba(255,255,255,.70);
    }
    input[type="range"]{ width: 100%; }

    select{
      width: 100%;
      padding: 10px 12px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,60,90,.28);
      border-radius: 14px;
      color: var(--text);
      outline:none;
      box-shadow: 0 0 0 3px rgba(255,60,90,.08);
    }

    /* ‚úÖ Mode "menu cadeau plus visible" (toggle) */
    body.high-contrast-select select{
      background: rgba(0,0,0,.55);
      border-color: rgba(255,60,90,.65);
      box-shadow:
        0 0 0 3px rgba(255,60,90,.20),
        0 10px 24px rgba(0,0,0,.35);
      font-weight: 900;
    }
    body.high-contrast-select select:focus{
      outline: none;
      box-shadow:
        0 0 0 4px rgba(255,60,90,.28),
        0 12px 30px rgba(0,0,0,.45);
    }

    .hint{
      font-size: 12px;
      color: rgba(255,255,255,.72);
      line-height: 1.35;
      margin-top: 8px;
    }

    .giftPreview{
      margin-top: 10px;
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    .giftPreview .thumb{
      width: 54px;
      height: 54px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .giftPreview img{
      width: 70%;
      height: 70%;
      object-fit: contain;
      filter: drop-shadow(0 12px 14px rgba(0,0,0,.45));
    }
    .giftPreview .meta{ display:flex; flex-direction:column; gap: 2px; }
    .giftPreview .meta .name{ font-weight: 900; font-size: 13px; }
    .giftPreview .meta .sub{ font-size: 12px; color: rgba(255,255,255,.70); }

    .main{
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 14px;
      min-height: calc(100vh - 36px);
    }

    .stage-wrap{ display:flex; flex-direction:column; gap: 10px; }
    .stage-toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }

    .footer-note{
      font-size: 12px;
      color: rgba(255,255,255,.75);
      opacity:.98;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New";
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,60,90,.30);
      background: rgba(255,60,90,.10);
      color: rgba(255,255,255,.88);
    }

    /* ‚úÖ STAGE = rectangle parfait */
    .stage{
      position:relative;
      border-radius: 0px; /* ‚úÖ plus arrondi */
      border: 1px solid rgba(255,60,90,.24);
      overflow:hidden;
      min-height: 560px;
      box-shadow: var(--shadow);
      background: rgba(0,0,0,.25);
    }

    /* ‚úÖ IMPORTANT : plus de scale sinon l'effet glace se d√©cale */
    .bg{
      position:absolute; inset:0;
      background-size: cover;
      background-position:center;
      filter: saturate(1.1) contrast(1.02);
      transform: none; /* ‚úÖ */
    }

    .vignette{
      position:absolute; inset:0;
      background: radial-gradient(1200px 700px at 50% 35%, transparent 40%, rgba(0,0,0,.40) 100%);
      pointer-events:none;
    }

    .grid{
      position:absolute; inset: 40px;
      display:grid;
      gap: var(--gap);
      align-content:center;
      justify-content:center;
      grid-template-columns: repeat(var(--cols), minmax(var(--cellMin), var(--cellMax)));
    }
    @media (max-width: 980px){
      .grid{ inset: 18px; }
    }

    /* ‚úÖ layout 3x2: taille auto-fit (via --cellSize) */
    .grid.is-3x2{
      grid-template-columns: repeat(3, var(--cellSize));
    }

    /* ‚úÖ Chaque item = une "tuile" (case + label en dessous) */
    .tile{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap: var(--labelGap);
      user-select:none;
    }

    /* ‚úÖ La case garde EXACTEMENT son style */
    .cell{
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: var(--r);
      position:relative;
      overflow:hidden;
      cursor:pointer;

      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 30px rgba(0,0,0,.42), var(--inner);

      /* IMPORTANT: on ne d√©pend plus de backdrop-filter (export stable) */
      background: rgba(255,255,255,.10);
    }

    /* ‚úÖ Faux glass blur capturable par html2canvas */
    .cell .glass-bg{
      position:absolute;
      inset: -18px; /* marge pour √©viter les bords du blur */
      background-repeat: no-repeat;
      transform: scale(1.08);
      filter: blur(var(--blur)) saturate(1.15);
      opacity: .92;

      /* ‚úÖ fallback anti "carr√© vide" si bg pas pr√™t */
      background-color: rgba(255,255,255,.08);
    }

    /* texture ‚Äúverre‚Äù par-dessus */
    .cell .glass-tint{
      position:absolute;
      inset:0;
      border-radius: var(--r);
      background: linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
      pointer-events:none;
    }

    /* reflet en coin */
    .cell .glass-shine{
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(220px 220px at 15% 10%, rgba(255,255,255,.28), transparent 55%),
        linear-gradient(135deg, rgba(255,255,255,.18), transparent 40%);
      opacity: .55;
      pointer-events:none;
    }

    /* highlight bord */
    .cell .glass-edge{
      position:absolute; inset:0;
      border-radius: var(--r);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.22);
      pointer-events:none;
    }

    .cell:hover{
      border-color: rgba(255,60,90,.35);
      box-shadow: 0 14px 30px rgba(0,0,0,.42), var(--inner), 0 0 0 3px rgba(255,60,90,.10);
    }

    .cell .giftInCell{
      position:absolute; inset: 16%;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .cell .giftInCell img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 16px 18px rgba(0,0,0,.50));
    }

    .cell .empty{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      color: rgba(255,255,255,.58);
      pointer-events:none;
      text-align:center;
      padding: 10px;
    }

    /* ‚úÖ Label sous chaque case (style ‚Äúoverlay‚Äù : blanc + contour noir) */
    .cellLabel{
      width: 100%;
      text-align:center;
      font-weight: 1000;
      letter-spacing: .6px;
      line-height: 1.05;
      text-transform: uppercase;

      /* look proche overlay */
      font-size: 16px;
      color: rgba(255,255,255,.96);
      text-shadow:
        0 4px 0 rgba(0,0,0,.60),
        0 10px 18px rgba(0,0,0,.55);

      -webkit-text-stroke: 3px rgba(0,0,0,.92);
      paint-order: stroke fill;

      /* 2 lignes max */
      min-height: var(--labelMinH);
      display:flex;
      align-items:flex-start;
      justify-content:center;

      /* coupe propre */
      overflow:hidden;
      padding: 0 6px;
      word-break: break-word;

      position: relative; /* ‚úÖ pour les aides d'√©dition */
    }

    /* si label vide => on garde la place sans afficher */
    .cellLabel.is-empty{
      color: transparent;
      -webkit-text-stroke: 0px transparent;
      text-shadow: none;
    }

    /* ‚úÖ AIDE D'√âDITION : zone d'√©criture visible √† l'√©cran, invisible √† l'export */
    body:not(.exporting) .cellLabel::before{
      content:"";
      position:absolute;
      inset: -8px -10px;
      border-radius: 14px;
      border: 2px dashed rgba(255,255,255,.45);
      background: rgba(0,0,0,.28);
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
      pointer-events:none;
    }

    body:not(.exporting) .cellLabel.is-empty::after{
      content:"‚úçÔ∏è √âCRIRE ICI";
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      letter-spacing: .6px;
      color: rgba(255,255,255,.70);
      text-shadow: 0 2px 10px rgba(0,0,0,.55);
      -webkit-text-stroke: 0;
      pointer-events:none;
    }

    body.exporting .cellLabel::before,
    body.exporting .cellLabel.is-empty::after{
      display:none !important;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <div class="card sidebar">
      <div class="title">
        <h1>Cr√©ateur d'overlay By Akatsuki Orga.</h1>
        <div class="badge">‚òÅÔ∏èü©∏ Akatsuki</div>
      </div>

      <div class="section">
        <label>üñºÔ∏è 1) Image de fond</label>
        <input id="bgInput" type="file" accept="image/*" />
        <div class="row" style="margin-top:10px;">
          <a class="btn primary" href="https://chatgpt.com" target="_blank" rel="noopener">
            ‚ú® Cr√©er mon fond sur chatgpt.com
          </a>
          <button class="btn" id="clearBg">Retirer le fond</button>
        </div>
        <div class="hint">‚òÅÔ∏èü©∏ Conseil : 1920√ó1080 (ou +) pour un rendu net.</div>
      </div>

      <div class="section">
        <label>üéÅ 2) Choisir un cadeau</label>
        <select id="giftSelect"></select>

        <!-- ‚úÖ Toggle visibilit√© du menu cadeau -->
        <div class="row" style="margin-top:10px;">
          <label style="display:flex;align-items:center;gap:10px;margin:0;color:rgba(255,255,255,.82);">
            <input type="checkbox" id="visibleGiftMenu" />
            üîÜ Menu cadeau plus visible
          </label>
        </div>

        <div class="giftPreview">
          <div class="thumb" id="giftThumb"></div>
          <div class="meta">
            <div class="name" id="giftName">Aucun cadeau s√©lectionn√©</div>
            <div class="sub">Clique une case ‚Ä¢ <span class="kbd">Double-clic</span> = retirer</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="deselect">D√©s√©lectionner</button>
        </div>

        <div class="hint">
          ‚úÖ PNG en racine (m√™me dossier que <b>index.html</b>) : <span class="kbd">./rose.png</span> etc.
        </div>
      </div>

      <div class="section">
        <label>üßä 3) R√©glages des cases ‚Äúverre‚Äù</label>

        <div class="row" style="width:100%;">
          <div style="flex:1; min-width: 150px;">
            <label style="margin-bottom:6px;">Disposition</label>
            <select id="layout">
              <option value="3x2">3 colonnes √ó 2 lignes (6)</option>
              <option value="5x2">5 colonnes √ó 2 lignes (10)</option>
              <option value="5x3" selected>5 colonnes √ó 3 lignes (15)</option>
              <option value="6x3">6 colonnes √ó 3 lignes (18)</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label>üå´Ô∏è Flou : <span id="blurVal">16</span>px</label>
          <input id="blur" type="range" min="0" max="30" value="16" />
        </div>

        <div style="margin-top:12px;">
          <label>‚≠ï Arrondi : <span id="roundVal">22</span>px</label>
          <input id="round" type="range" min="8" max="40" value="22" />
        </div>

        <div class="hint">
          ü©∏ Choisis un cadeau ‚Üí clique une case.<br/>
          ‚úçÔ∏è Pour √©crire sous une case : <span class="kbd">clic droit</span> sur la case (ou <span class="kbd">Ctrl</span>+clic).
        </div>
      </div>

      <div class="section">
        <label>üßπ 4) Actions</label>
        <div class="row">
          <button class="btn danger" id="resetGrid">Vider toutes les cases</button>
          <button class="btn primary" id="exportPng">Exporter en PNG</button>
        </div>
        <div class="hint">
          ‚úÖ Export fid√®le : m√™me rendu que l‚Äô√©cran (blur stable).
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <div class="stage-wrap">
        <div class="stage-toolbar">
          <div class="footer-note">
            ‚òÅÔ∏èü©∏ Cadeau : clique une case ‚Ä¢ <span class="kbd">Double-clic</span> pour supprimer ‚Ä¢
            ‚úçÔ∏è Texte : <span class="kbd">clic droit</span> (ou <span class="kbd">Ctrl</span>+clic)
          </div>
        </div>

        <div class="stage" id="stage">
          <div class="bg" id="bg"></div>
          <div class="vignette"></div>
          <div class="grid" id="grid"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * ‚úÖ Tes fichiers en RACINE (m√™me niveau que index.html)
     */
    const GIFTS = [
      { name: "9 queues ü™ô 1800", file: "9 queues.png" },
      { name: "2026 ü™ô 1", file: "2026.png" },
      { name: "je t'adore ü™ô 1", file: "adore.png" },
      { name: "Aile de papillon ü™ô 399", file: "Aile de papillon.png" },
      { name: "ailes f√©e ü™ô 1", file: "ailesfee.png" },
      { name: "Bo√Ætes de largage ü™ô 999 ", file: "Air drop.png" },
      { name: "Ami Fruit√©s ü™ô 299", file: "Ami Fruit√©s.png" },
      { name: "amour langue signe ü™ô 49", file: "amourlanguesigne.png" },
      { name: "Animaux en sc√®ne ü™ô 2500", file: "Animal Band.png" },
      { name: "Arbre √† diamants ü™ô 1088", file: "Arbre √† diamants.png" },
      { name: "arc amour ü™ô 99", file: "arcamour.png" },
      { name: "arc en ciel ü™ô 1", file: "arcenciel.png" },
      { name: "bagel ü™ô 35", file: "bagel.png" },
      { name: "Singe Encourageant ü™ô 349", file: "baking monkey.png" },
      { name: "Plong√©e Baleine ü™ô 2150", file: "Baleine.png" },
      { name: "ballon coeur ü™ô 150", file: "ballonamour.png" },
      { name: "Stand des Amoureux ü™ô 2199", file: "Bar √† citron.png" },
      { name: "basketball ü™ô 1", file: "basketball.png" },
      { name: "Batterie ü™ô 1000", file: "Batterie.png" },
      { name: "Ours Surfeur ü™ô 800", file: "Bear Blind Box.Png" },
      { name: "Devenir un Chaton ü™ô 349", file: "Become Kitten.png" },
      { name: "Benny B√©b√© Rhino ü™ô 4999", file: "Berry.png" },
      { name: "Bisous Loutre ü™ô 399", file: "Bisous Loutre.png" },
      { name: "bisous ü™ô 1", file: "bisous.png" },
      { name: "bubblegum ü™ô 99", file: "bubblegum.png" },
      { name: "calin de teddy ü™ô 399", file: "calin de teddy.png" },
      { name: "Camion de glace ü™ô 2988", file: "Camion de glace.png" },
      { name: "Capybara ü™ô 30", file: "capybara.png" },
      { name: "Carrousel ü™ô 1999", file: "Carrousel.png" },
      { name: "Carte de Voeux ü™ô 1500", file: "carte de voeux.png" },
      { name: "Casquette ü™ô 99", file: "Casquette.png" },
      { name: "Chaise Gaming ü™ô 1200", file: "Chaise Gaming.png" },
      { name: "chapeau moustache ü™ô 99", file: "chapeaumoustache.png" },
      { name: "G√©nial ü™ô 1", file: "chaton.png" },
      { name: "Chaos de la Chenille ü™ô 149", file: "chenilledodo.png" },
      { name: "Compagnon Citronn√©e ü™ô 199", file: "citronnade.png" },
      { name: "Clavier Gaming ü™ô 4000", file: "Clavier gamer.png" },
      { name: "Cochon Amoureux ü™ô 10", file: "cochonamoureux.Png" },

      { name: "Coeur ü™ô 199", file: "Coeur bisous.png" },
      { name: "Coeur Unis ü™ô 299", file: "Coeur Uni.png" },
      { name: "Coeur avec les mains ü™ô 100", file: "coeuraveclesmains.png" },
      { name: "Coeur dans les mains ü™ô 100", file: "Coeurdanslesmains.png" },
      { name: "coeur doigt ü™ô 5", file: "coeurdoigt.png" },
      { name: "coeur du jour ü™ô 1", file: "coeurdujour.png" },
      { name: "coeur en flammes ü™ô 1", file: "coeureenflammes.png" },
      { name: "coeur nuage ü™ô 1", file: "coeurnuage.png" },

      { name: "Collier amiti√© ü™ô 10", file: "collierami.png" },
      { name: "Saxophone de Rosie ü™ô 399 ", file: "Concert de Rosie.png" },
      { name: "Confettis ü™ô 100", file: "confetti.png" },
      { name: "Cool ü™ô 1", file: "Cool.png" },
      { name: "Cooper rentre en.. ü™ô 1999", file: "Cooper.png" },
      { name: "Coquillage ü™ô 100", file: "coquillage.png" },
      { name: "Corail ü™ô 499", file: "corail.png" },
      { name: "Corgi ü™ô 299", file: "corgi.png" },
      { name: "Cote √† C√¥te ü™ô 199", file: "Coteacote.png" },
      { name: "Couple puissant ü™ô 2000", file: "Couple puissant.png" },
      { name: "Couronnes Dragon ü™ô 500", file: "Couronnes Dragon.png" },
      { name: "Couronne TikTok ü™ô 299", file: "couronnes TikTok.png" },
      { name: "Crabe acclamant ü™ô 199", file: "crabe.png" },
      { name: "Crini√®re Lion ü™ô 500", file: "Crini√®re lion.png" },
      { name: "Cygne ü™ô 699", file: "cygne.png" },
      { name: "Ours Rythmique ü™ô 2999", file: "Dancing Bear.png" },
      { name: "Fusil √† Diamant ü™ô 5000", file: "Diamond gun.png" },
      { name: "Casquette Dino ü™ô 200", file: "dinocap.png" },
      { name: "Lunettes de DJ ü™ô 500", file: "Dj glasses.Png" },
      { name: "Donut ü™ô 30", file: "donuts.png" },
      { name: "Drift en voiture ü™ô 3000", file: "Drift.png" },
      { name: "eclair ü™ô 1", file: "eclair.png" },
      { name: "Elise l'√©l√©phante ü™ô 5000", file: "Elise l'√©l√©phant.Png" },
      { name: "Empreinte de Dino ü™ô 1", file: "empreintedino.png" },
      { name: "etoile √©tincelante ü™ô 199", file: "etoileetincelante.png" },
      { name: "Famille ü™ô 90", file: "famille.png" },
      { name: "Feu d'artifice ü™ô 1088", file: "Feu d'artifice.png" },
      { name: "Puissance Max ü™ô399", file: "Fire up.png" },
      { name: "Poing contre Poing ü™ô 90", file: "fistbump.png" },

      { name: " Bou√©e Flamant Rose ü™ô999", file: "flamant rose.Png" },
      { name: "fleur S ü™ô 20", file: "fleurenS.png" },
      { name: "Rencontre du Futur ü™ô 1500", file: "Futur.png" },
      { name: "Galaxie ü™ô 1000", file: "Galaxie.png" },
      { name: "Ours Gameur ü™ô 4088", file: "Gaming Bear.png" },
      { name: "Gant de Boxe ü™ô 299", file: "gantdeboxe.png" },
      { name: "Gant Dor√©e ü™ô 10", file: "gantdor√©e.png" },
      { name: "Part de Gateau D'anniversaire ü™ô 1", file: "gateauanniv.png" },
      { name: "Part de Gateau ü™ô 1", file: "gateaupart.png" },
      { name: "gg ü™ô 1", file: "gg.png" },
      { name: "Girafe ü™ô 1000", file: "Girafe.Png" },
      { name: "Glace ü™ô 5", file: "glace.png" },
      { name: "B√¢ton brillant ü™ô 1", file: "glow.png" },
      { name: "Grande Rose ü™ô 500", file: "Grande Roses.png" },
      { name: "Grue ü™ô 100", file: "grue.png" },
      { name: "Par√¥le d'amour ü™ô 1", file: "heartlytalyk.png" },
      { name: "ice-cream ü™ô 1", file: "ice-cream.png" },
      { name: "Jet volant ü™ô 5000 ", file: "Jet volant.png" },
      { name: "Je T'aime ü™ô 199", file: "jetaime.png" },
      { name: "Pass Aventure ü™ô 10", file: "journepass.png" },
      { name: "Sourire Juteux ü™ô 199", file: "juicysmile.png" },
      { name: "Eau De Coco ü™ô 199", file: "jusdecoco.png" },
      { name: "Leon le chaton ü™ô 4888", file: "Leon le chaton.png" },
      { name: "Loup d'arabie ü™ô 5500", file: "Loup D'arabie.png" },
      { name: "Peinture D'amour ü™ô 99", file: "lovepainting.png" },
      { name: "Lunettes de Soleil ü™ô 199", file: "lunettesdesoleil.png" },
      { name: "Magie du Caf√© ü™ô 199 ", file: "magieducafe.png" },
      { name: "Mama Mia ü™ô 1", file: "mamamia.png" },
      { name: "Manettes ü™ô 100", file: "Manettes.png" },
      { name: "Manifestation XXL ü™ô 1500", file: "Manifestation XXL.png" },
      { name: "Amour Astronaute ü™ô 349", file: "Marked With love.png" },
      { name: "Marque D'amour ü™ô 99", file: "marquedamour.png" },
      { name: "Masque Pharaon ü™ô 399", file: "masque pharaon.png" },
      { name: "masque ü™ô 149", file: "masque.png" },
      { name: "Un grand Bravo ü™ô 149", file: "megaphone.png" },
      { name: "Pistolet Billets ü™ô 500", file: "Money Gun.png" },
      { name: "Magnettes d'argent ü™ô 549", file: "Money Magnet.png" },
      { name: "Mongolfiere ü™ô 1000", file: "Mongolfiere.Png" },

      { name: "Fleur clair de Lune ü™ô 1400", file: "Moonlight Flower.png" },
      { name: "Moto ü™ô 2988", file: "Moto.png" },
      { name: "noeud papillon ü™ô 149", file: "noeudpapillon.png" },
      { name: "Oie D√©tendu ü™ô 399", file: "Oie d√©tendu.png" },
      { name: "Bisous Joyeux ü™ô 199", file: "oiseau.png" },
      { name: "Ours Dansant ü™ô 3000", file: "ours rythmic.png" },
      { name: "Ours de Rose ü™ô 214", file: "oursderose.png" },
      { name: "Ourson ü™ô 100", file: "ourson.png" },
      { name: "Panda Climb ü™ô 199", file: "pandaclimb.png" },
      { name: "Papillon ü™ô 88", file: "Papillon.png" },
      { name: "Parfum ü™ô 20", file: "parfum.png" },
      { name: "Bus Festif ü™ô 2999", file: "Party Bus.png" },
      { name: "Patate qui flotte ü™ô 1500", file: "Patate qui flottre.png" },
      { name: "P√™che ü™ô 5", file: "peche.png" },
      { name: "Petite couronne ü™ô 99", file: "petitecouronne.png" },
      { name: "Pingouin qui surf ü™ô 249", file: "pingouinsurf.png" },
      { name: "Pluie de m√©t√©ores ü™ô 3000", file: "Pluie de m√©t√©ore.png" },
      { name: "Pneu ü™ô 1", file: "pneu.png" },
      { name: "Polaris ü™ô 500", file: "Polaris.png" },
      { name: "Popcorn ü™ô 149", file: "popcorn.png" },
      { name: "Populaire ü™ô 1", file: "populaire.png" },
      { name: "Positivit√© ü™ô 199", file: "positivit√©.png" },
      { name: "Pouce vers le haut ü™ô 2", file: "pouceverslehaut.png" },
      { name: "Poulet espi√®gles ü™ô 299", file: "Poulet espi√®gles.png" },
      { name: "Poulpe ü™ô 199", file: "poulpe.png" },
      { name: "Poursuit tes r√™ves ü™ô 1500", file: "Poursuit tes reves.png" },
      { name: "Prince ü™ô 500", file: "Prince.png" },
      { name: "Jet Priv√© ü™ô 4888", file: "Private Jet.png" },
      { name: "Bisous Chiot ü™ô 299", file: "Puppy kiss.png" },
      { name: "Refuge de l'amour ü™ô 1200", file: "Refude de l'amour.png" },
      { name: "Rocky Rockeur ü™ô 399", file: "Rocky.png" },
      { name: "Rosa ü™ô 10", file: "rosa.png" },
      { name: "Rose √† jamais ü™ô 399", file: "Rose √† jamais.png" },
      { name: "Rose √† Main ü™ô 199", file: "Rose pour toi.png" },
      { name: "rose ü™ô 1", file: "rose.png" },
      { name: "rose blanche ü™ô 1", file: "roseblanche.png" },
      { name: "Sage Fut√© ü™ô 399", file: "sage intelligent.png" },
      { name: "slay ü™ô 1", file: "slay.png" },
      { name: "Sous contr√¥les ü™ô 1500", file: "Sous contr√¥les.Png" },

      { name: "Chat de L'espace ü™ô 1500", file: "Space Cat.png" },
      { name: "Chien de L'espace ü™ô 2500", file: "Space dog.png" },
      { name: "Steven Wingman ü™ô 1", file: "steven.png" },
      { name: "Super GG ü™ô 100", file: "supergg.png" },
      { name: "Super Populaire ü™ô 9", file: "superpopulaire.png" },
      { name: "Taureau ü™ô 3000", file: "taureau.Png" },
      { name: "Tcheck ü™ô 299", file: "tcheck.png" },
      { name: "tiktok ü™ô 1", file: "tiktok.png" },
      { name: "Tofu ü™ô 5", file: "tofu.png" },
      { name: "Tom la Tomate ü™ô 1", file: "tomtomate.png" },
      { name: "Ton concert ü™ô 4500", file: "ton concert.png" },
      { name: "Train ü™ô 899", file: "Train.png" },
      { name: "transfo patate ü™ô 150", file: "transfopatate.png" },
      { name: "Trompe D'√©l√©phant ü™ô 299", file: "trompe d'√©l√©phant.png" },
      { name: "Troph√©e Basket ü™ô 700", file: "Troph√©e Basket.png" },
      { name: "umake me so happy ü™ô 30", file: "umakemisohappy.png" },
      { name: "Vaisseau de Level ü™ô 1500", file: "Vaisseau de Level.png" },
      { name: "Vaisseau spatial ü™ô 4999", file: "Vaisseau spacial.png" },
      { name: "Voyage avec toi ü™ô 999", file: "Voyage avec toi.png" },
      { name: "Mercredi Gagnant ü™ô 99", file: "winningwednesday.png" },
      { name: "FLeurs XXXL ü™ô 500", file: "XXL flower.png" },
      { name: "you are my jam ü™ô 30", file: "youaremyjam.png" },
      { name: "you are on a roll ü™ô 30", file: "youaremyroll.png" }
    ];

    const state = {
      selectedGiftUrl: null,
      selectedGiftName: null,

      // contenu des cases (image)
      cells: [],

      // texte sous les cases
      labels: [],

      cols: 5,
      rows: 3,
      blur: 16,
      round: 22,
      gap: 26,

      // background (for accurate faux blur alignment)
      bgUrl: null,
      bgNaturalW: 0,
      bgNaturalH: 0
    };

    // Elements
    const stage = document.getElementById('stage');
    const bg = document.getElementById('bg');
    const grid = document.getElementById('grid');

    const bgInput = document.getElementById('bgInput');
    const clearBgBtn = document.getElementById('clearBg');

    const giftSelect = document.getElementById('giftSelect');
    const giftThumb = document.getElementById('giftThumb');
    const giftName = document.getElementById('giftName');
    const deselectBtn = document.getElementById('deselect');

    const visibleGiftMenu = document.getElementById('visibleGiftMenu');

    const layout = document.getElementById('layout');

    const blurRange = document.getElementById('blur');
    const blurVal = document.getElementById('blurVal');

    const roundRange = document.getElementById('round');
    const roundVal = document.getElementById('roundVal');

    const resetGridBtn = document.getElementById('resetGrid');
    const exportBtn = document.getElementById('exportPng');

    // --------- Utilities
    function setCSSVars(){
      document.documentElement.style.setProperty('--cols', state.cols);
      document.documentElement.style.setProperty('--blur', state.blur + 'px');
      document.documentElement.style.setProperty('--r', state.round + 'px');
      document.documentElement.style.setProperty('--gap', state.gap + 'px');

      blurVal.textContent = state.blur;
      roundVal.textContent = state.round;
    }

    function setSelectedGift(gift){
      if(!gift){
        state.selectedGiftUrl = null;
        state.selectedGiftName = null;
        renderGiftPreview();
        renderGrid();
        return;
      }
      state.selectedGiftUrl = `./${gift.file}`; // RACINE
      state.selectedGiftName = gift.name;
      renderGiftPreview();
      renderGrid();
    }

    function parseCoinsFromName(name){
      const m = name.match(/ü™ô\s*(\d+)/);
      return m ? Number(m[1]) : Number.POSITIVE_INFINITY;
    }

    function getSortedGiftIndexes(){
      return GIFTS
        .map((g, idx) => ({ idx, coins: parseCoinsFromName(g.name), name: g.name }))
        .sort((a, b) => (a.coins - b.coins) || a.name.localeCompare(b.name, 'fr'))
        .map(x => x.idx);
    }

    function renderGiftSelect(){
      giftSelect.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '‚Äî Aucun (d√©s√©lectionn√©) ‚Äî';
      giftSelect.appendChild(opt0);

      const sortedIdx = getSortedGiftIndexes();
      sortedIdx.forEach((idx) => {
        const g = GIFTS[idx];
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = `üéÅ ${g.name}`;
        giftSelect.appendChild(opt);
      });
    }

    function renderGiftPreview(){
      giftThumb.innerHTML = '';
      if(!state.selectedGiftUrl){
        giftName.textContent = "Aucun cadeau s√©lectionn√©";
        return;
      }
      giftName.textContent = state.selectedGiftName || "Cadeau";
      const img = document.createElement('img');
      img.src = state.selectedGiftUrl;
      img.alt = state.selectedGiftName || "cadeau";
      giftThumb.appendChild(img);
    }

    // --------- Layout sizing
    function apply3x2Sizing(){
      const inset = (window.innerWidth <= 980) ? 18 : 40;
      const stageW = stage.clientWidth;
      const stageH = stage.clientHeight;

      const availW = Math.max(200, stageW - inset * 2);
      const availH = Math.max(200, stageH - inset * 2);

      let cell = Math.floor(Math.min(availW / 3, availH / 2));
      cell = Math.min(cell, 210);
      cell = Math.max(cell, 120);

      const gap = Math.floor(cell * 0.16);

      document.documentElement.style.setProperty('--cellSize', cell + 'px');
      state.gap = gap;
      setCSSVars();
    }

    function ensureArraysSize(){
      const total = state.cols * state.rows;

      if(!Array.isArray(state.cells)) state.cells = [];
      if(!Array.isArray(state.labels)) state.labels = [];

      if(state.cells.length !== total){
        const old = state.cells.slice();
        state.cells = new Array(total).fill(null);
        for(let i=0; i<Math.min(old.length, total); i++) state.cells[i] = old[i];
      }

      if(state.labels.length !== total){
        const oldL = state.labels.slice();
        state.labels = new Array(total).fill('');
        for(let i=0; i<Math.min(oldL.length, total); i++) state.labels[i] = oldL[i] || '';
      }
    }

    function setLayout(value){
      const [c, r] = value.split('x').map(Number);
      state.cols = c;
      state.rows = r;

      grid.classList.toggle('is-3x2', (c === 3 && r === 2));

      state.gap = 26;

      state.cells = new Array(c * r).fill(null);
      state.labels = new Array(c * r).fill('');

      setCSSVars();

      if(c === 3 && r === 2){
        apply3x2Sizing();
      }

      renderGrid();
      requestAnimationFrame(updateGlassAlignment);
    }

    // --------- Faux blur alignment
    function computeCoverParams(){
      if(!state.bgUrl || !state.bgNaturalW || !state.bgNaturalH){
        return null;
      }
      const stageW = stage.clientWidth;
      const stageH = stage.clientHeight;

      const s = Math.max(stageW / state.bgNaturalW, stageH / state.bgNaturalH);
      const drawnW = state.bgNaturalW * s;
      const drawnH = state.bgNaturalH * s;

      const offsetX = (stageW - drawnW) / 2;
      const offsetY = (stageH - drawnH) / 2;

      return { drawnW, drawnH, offsetX, offsetY };
    }

    function updateGlassAlignment(){
      const params = computeCoverParams();
      const cells = grid.querySelectorAll('.cell');

      if(!params){
        cells.forEach(cell => {
          const gb = cell.querySelector('.glass-bg');
          if(!gb) return;
          gb.style.backgroundImage = '';
          gb.style.background = 'linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.04))';
        });
        return;
      }

      const stageRect = stage.getBoundingClientRect();

      cells.forEach(cell => {
        const gb = cell.querySelector('.glass-bg');
        if(!gb) return;

        const rect = cell.getBoundingClientRect();
        const left = rect.left - stageRect.left;
        const top  = rect.top  - stageRect.top;

        gb.style.background = 'none';
        gb.style.backgroundImage = `url("${state.bgUrl}")`;
        gb.style.backgroundSize = `${params.drawnW}px ${params.drawnH}px`;
        gb.style.backgroundPosition = `${params.offsetX - left}px ${params.offsetY - top}px`;
      });
    }

    // --------- Label helper
    function editLabelAt(index){
      const current = (state.labels[index] || '').toString();
      const next = prompt("Texte sous la case (vide = supprimer) :", current);
      if(next === null) return; // annuler
      state.labels[index] = (next || '').trim();
      renderGrid();
      requestAnimationFrame(updateGlassAlignment);
    }

    // --------- Grid render (case + label dessous)
    function renderGrid(){
      ensureArraysSize();
      grid.innerHTML = '';

      const total = state.cols * state.rows;

      for(let i=0; i<total; i++){
        const tile = document.createElement('div');
        tile.className = 'tile';

        const cell = document.createElement('div');
        cell.className = 'cell';

        // glass layers
        const glassBg = document.createElement('div');
        glassBg.className = 'glass-bg';

        const glassTint = document.createElement('div');
        glassTint.className = 'glass-tint';

        const glassShine = document.createElement('div');
        glassShine.className = 'glass-shine';

        const glassEdge = document.createElement('div');
        glassEdge.className = 'glass-edge';

        cell.appendChild(glassBg);
        cell.appendChild(glassTint);
        cell.appendChild(glassShine);
        cell.appendChild(glassEdge);

        const url = state.cells[i];

        if(url){
          const wrap = document.createElement('div');
          wrap.className = 'giftInCell';

          const img = document.createElement('img');
          img.src = url;
          img.alt = 'gift';

          wrap.appendChild(img);
          cell.appendChild(wrap);
        } else {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = state.selectedGiftUrl ? 'Clique pour placer ‚òÅÔ∏è' : 'Choisis un cadeau ü©∏';
          cell.appendChild(empty);
        }

        // interactions
        cell.addEventListener('click', (e) => {
          // Ctrl+clic / ‚åò => √©diter le texte
          if(e.ctrlKey || e.metaKey){
            editLabelAt(i);
            return;
          }

          if(!state.selectedGiftUrl) return;
          state.cells[i] = state.selectedGiftUrl;
          renderGrid();
          requestAnimationFrame(updateGlassAlignment);
        });

        cell.addEventListener('dblclick', () => {
          state.cells[i] = null;
          renderGrid();
          requestAnimationFrame(updateGlassAlignment);
        });

        // clic droit = √©diter le label
        cell.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          editLabelAt(i);
        });

        // Label sous la case
        const label = document.createElement('div');
        label.className = 'cellLabel';
        const txt = (state.labels[i] || '').trim();

        if(!txt){
          label.classList.add('is-empty');
          label.textContent = '‚Äî';
        } else {
          label.textContent = txt;
        }

        // double-clic sur le label = √©diter
        label.addEventListener('dblclick', () => editLabelAt(i));

        tile.appendChild(cell);
        tile.appendChild(label);
        grid.appendChild(tile);
      }

      requestAnimationFrame(updateGlassAlignment);
    }

    // --------- Background upload
    async function setBackgroundFromUrl(url){
      state.bgUrl = url;

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        state.bgNaturalW = img.naturalWidth;
        state.bgNaturalH = img.naturalHeight;

        bg.style.backgroundImage = `url("${url}")`;
        requestAnimationFrame(updateGlassAlignment);
      };
      img.onerror = () => {
        bg.style.backgroundImage = `url("${url}")`;
        state.bgNaturalW = 0;
        state.bgNaturalH = 0;
        requestAnimationFrame(updateGlassAlignment);
      };
      img.src = url;
    }

    bgInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      setBackgroundFromUrl(url);
    });

    clearBgBtn.addEventListener('click', () => {
      bg.style.backgroundImage = '';
      bgInput.value = '';
      state.bgUrl = null;
      state.bgNaturalW = 0;
      state.bgNaturalH = 0;
      requestAnimationFrame(updateGlassAlignment);
    });

    // --------- Gift selection
    giftSelect.addEventListener('change', () => {
      const v = giftSelect.value;
      if(v === ''){
        setSelectedGift(null);
        return;
      }
      const idx = Number(v);
      setSelectedGift(GIFTS[idx]);
    });

    deselectBtn.addEventListener('click', () => {
      giftSelect.value = '';
      setSelectedGift(null);
    });

    // --------- Toggle "menu plus visible"
    visibleGiftMenu.addEventListener('change', () => {
      document.body.classList.toggle('high-contrast-select', visibleGiftMenu.checked);
    });

    // --------- Controls
    layout.addEventListener('change', (e) => setLayout(e.target.value));

    blurRange.addEventListener('input', (e) => {
      state.blur = Number(e.target.value);
      setCSSVars();
      requestAnimationFrame(updateGlassAlignment);
    });

    roundRange.addEventListener('input', (e) => {
      state.round = Number(e.target.value);
      setCSSVars();
    });

    resetGridBtn.addEventListener('click', () => {
      state.cells = new Array(state.cols * state.rows).fill(null);
      state.labels = new Array(state.cols * state.rows).fill('');
      renderGrid();
    });

    // resize: keep faux blur aligned + 3x2 sizing responsive
    window.addEventListener('resize', () => {
      if(state.cols === 3 && state.rows === 2){
        apply3x2Sizing();
      }
      requestAnimationFrame(updateGlassAlignment);
    });

    // --------- Export PNG (aides invisibles)
    async function waitForImages(root){
      const imgs = Array.from(root.querySelectorAll('img'));
      await Promise.all(imgs.map(img => {
        if(img.complete && img.naturalWidth > 0) return Promise.resolve();
        return new Promise(res => {
          img.addEventListener('load', res, { once:true });
          img.addEventListener('error', res, { once:true });
        });
      }));
    }

    exportBtn.addEventListener('click', async () => {
      try{
        exportBtn.disabled = true;
        exportBtn.textContent = "‚è≥ Export en cours...";

        // ‚úÖ cache les aides d‚Äô√©dition (zone d'√©criture)
        document.body.classList.add('exporting');

        updateGlassAlignment();
        await waitForImages(stage);

        const canvas = await html2canvas(stage, {
          backgroundColor: null,
          useCORS: true,
          scale: 2
        });

        const dataUrl = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = `overlay-akatsuki-${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();

      } catch(err){
        alert("Export impossible (v√©rifie que GitHub Pages sert bien les images).");
        console.error(err);
      } finally {
        document.body.classList.remove('exporting');
        exportBtn.disabled = false;
        exportBtn.textContent = "Exporter en PNG";
      }
    });

    // --------- Init
    renderGiftSelect();
    setLayout(layout.value);

    state.blur = Number(blurRange.value);
    state.round = Number(roundRange.value);
    setCSSVars();

    renderGiftPreview();
    renderGrid();
  </script>
</body>
</html>
