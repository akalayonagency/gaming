<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cr√©ateur d'overlay By Akatsuki Orga.</title>

  <!-- Export PNG -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg: #07060a;

      /* Akatsuki palette */
      --red: rgba(255, 60, 90, 1);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);

      /* Transparent menu */
      --menu: rgba(0,0,0,.18);
      --menu2: rgba(0,0,0,.10);

      --strokeRed: rgba(255, 60, 90, .35);

      --shadow: 0 18px 40px rgba(0,0,0,.45);
      --inner: inset 0 1px 0 rgba(255,255,255,.16), inset 0 -18px 40px rgba(0,0,0,.35);

      --r: 22px;

      /* grid vars */
      --cols: 5;
      --gap: 26px;
      --cellSize: 150px;

      /* label */
      --labelGap: 10px;
      --labelMinH: 2.4em;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      min-height:100vh;

      background:
        radial-gradient(900px 500px at 70% 15%, rgba(255,60,90,.18), transparent 60%),
        radial-gradient(900px 500px at 20% 75%, rgba(255,255,255,.06), transparent 60%),
        var(--bg);
    }

    .app{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
      padding: 18px;
      max-width: 1400px;
      margin: 0 auto;
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
    }

    /* MENU TRANSPARENT (glass) */
    .card{
      background: linear-gradient(180deg, var(--menu), var(--menu2));
      border: 1px solid var(--strokeRed);
      border-radius: 24px;
      box-shadow: var(--shadow);
      overflow:hidden;

      backdrop-filter: blur(14px) saturate(1.15);
      -webkit-backdrop-filter: blur(14px) saturate(1.15);
    }

    .sidebar{
      padding: 16px;
      position: sticky;
      top: 16px;
      height: fit-content;
    }

    .title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .title h1{
      font-size: 15px;
      line-height: 1.25;
      margin:0;
      letter-spacing:.2px;
    }
    .badge{
      font-size: 12px;
      color: rgba(255,255,255,.82);
      background: rgba(255,60,90,.12);
      border: 1px solid rgba(255,60,90,.35);
      padding: 6px 10px;
      border-radius: 999px;
      box-shadow: 0 0 0 3px rgba(255,60,90,.08);
      white-space:nowrap;
    }

    .section{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,.10);
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 800;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;

      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .btn:hover{
      background: rgba(0,0,0,.28);
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(180deg, rgba(255,60,90,.20), rgba(255,60,90,.10));
      border-color: rgba(255,60,90,.38);
      box-shadow: 0 0 0 3px rgba(255,60,90,.10);
    }
    .btn.primary:hover{ box-shadow: 0 0 0 3px rgba(255,60,90,.16); }

    .btn.danger{
      background: rgba(255,60,90,.12);
      border-color: rgba(255,60,90,.30);
    }

    input[type="file"]{
      width: 100%;
      padding: 10px;
      background: rgba(0,0,0,.18);
      border: 1px dashed rgba(255,255,255,.20);
      border-radius: 14px;
      color: rgba(255,255,255,.70);
    }
    input[type="range"]{ width: 100%; }

    select{
      width: 100%;
      padding: 10px 12px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,60,90,.28);
      border-radius: 14px;
      color: var(--text);
      outline:none;
      box-shadow: 0 0 0 3px rgba(255,60,90,.08);
    }

    body.high-contrast-select select{
      background: rgba(0,0,0,.55);
      border-color: rgba(255,60,90,.65);
      box-shadow:
        0 0 0 3px rgba(255,60,90,.20),
        0 10px 24px rgba(0,0,0,.35);
      font-weight: 900;
    }
    body.high-contrast-select select:focus{
      outline: none;
      box-shadow:
        0 0 0 4px rgba(255,60,90,.28),
        0 12px 30px rgba(0,0,0,.45);
    }

    .hint{
      font-size: 12px;
      color: rgba(255,255,255,.72);
      line-height: 1.35;
      margin-top: 8px;
    }

    .giftPreview{
      margin-top: 10px;
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    .giftPreview .thumb{
      width: 54px;
      height: 54px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .giftPreview img{
      width: 70%;
      height: 70%;
      object-fit: contain;
      filter: drop-shadow(0 12px 14px rgba(0,0,0,.45));
    }
    .giftPreview .meta{ display:flex; flex-direction:column; gap: 2px; }
    .giftPreview .meta .name{ font-weight: 900; font-size: 13px; }
    .giftPreview .meta .sub{ font-size: 12px; color: rgba(255,255,255,.70); }

    .main{
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 14px;
      min-height: calc(100vh - 36px);
    }

    .stage-wrap{ display:flex; flex-direction:column; gap: 10px; }
    .stage-toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }

    .footer-note{
      font-size: 12px;
      color: rgba(255,255,255,.75);
      opacity:.98;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New";
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,60,90,.30);
      background: rgba(255,60,90,.10);
      color: rgba(255,255,255,.88);
    }

    /* ‚úÖ STAGE rectangle */
    .stage{
      position:relative;
      border-radius: 0px;
      border: 1px solid rgba(255,60,90,.24);
      overflow:hidden;
      min-height: 560px;
      box-shadow: var(--shadow);
      background: rgba(0,0,0,.25);
    }

    .bg{
      position:absolute; inset:0;
      background-size: cover;
      background-position:center;
      filter: saturate(1.1) contrast(1.02);
      transform: none;
    }

    .vignette{
      position:absolute; inset:0;
      background: radial-gradient(1200px 700px at 50% 35%, transparent 40%, rgba(0,0,0,.40) 100%);
      pointer-events:none;
    }

    /* ‚úÖ GRID : taille calcul√©e -> plus de 5x3 trop grand */
    .grid{
      position:absolute; inset: 40px;
      display:grid;
      gap: var(--gap);
      align-content:center;
      justify-content:center;
      grid-template-columns: repeat(var(--cols), var(--cellSize));
    }
    @media (max-width: 980px){
      .grid{ inset: 18px; }
    }

    .tile{
      width: var(--cellSize);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap: var(--labelGap);
      user-select:none;
    }

    .cell{
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: var(--r);
      position:relative;
      overflow:hidden;
      cursor:pointer;

      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 30px rgba(0,0,0,.42), var(--inner);
      background: rgba(255,255,255,.10);
    }

    /* ‚úÖ ICI : la "glace" est une IMAGE (pr√©-rendue au canvas) */
    .glass-bg{
      position:absolute;
      inset:-24px; /* padding pour le flou aux bords */
      opacity:.95;
      pointer-events:none;
    }
    .glass-bg img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .glass-tint{
      position:absolute;
      inset:0;
      border-radius: var(--r);
      background:
        linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.06)),
        radial-gradient(240px 240px at 18% 12%, rgba(255,255,255,.20), transparent 58%);
      pointer-events:none;
    }

    .glass-shine{
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(220px 220px at 15% 10%, rgba(255,255,255,.28), transparent 55%),
        linear-gradient(135deg, rgba(255,255,255,.18), transparent 40%);
      opacity: .55;
      pointer-events:none;
    }

    .glass-edge{
      position:absolute; inset:0;
      border-radius: var(--r);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.22);
      pointer-events:none;
    }

    .cell:hover{
      border-color: rgba(255,60,90,.35);
      box-shadow: 0 14px 30px rgba(0,0,0,.42), var(--inner), 0 0 0 3px rgba(255,60,90,.10);
    }

    .giftInCell{
      position:absolute; inset: 16%;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index: 2;
    }
    .giftInCell img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 16px 18px rgba(0,0,0,.50));
    }

    .empty{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      color: rgba(255,255,255,.58);
      pointer-events:none;
      text-align:center;
      padding: 10px;
      z-index: 2;
    }

    .cellLabel{
      width: 100%;
      text-align:center;
      font-weight: 1000;
      letter-spacing: .6px;
      line-height: 1.05;
      text-transform: uppercase;

      font-size: 16px;
      color: rgba(255,255,255,.96);
      text-shadow:
        0 4px 0 rgba(0,0,0,.60),
        0 10px 18px rgba(0,0,0,.55);

      -webkit-text-stroke: 3px rgba(0,0,0,.92);
      paint-order: stroke fill;

      min-height: var(--labelMinH);
      display:flex;
      align-items:flex-start;
      justify-content:center;

      overflow:hidden;
      padding: 0 6px;
      word-break: break-word;

      position: relative;
      z-index: 3;
    }

    .cellLabel.is-empty{
      color: transparent;
      -webkit-text-stroke: 0px transparent;
      text-shadow: none;
    }

    /* ‚úÖ AIDE D'√âDITION (visible √©cran / invisible export) */
    body:not(.exporting) .cellLabel::before{
      content:"";
      position:absolute;
      inset: -8px -10px;
      border-radius: 14px;
      border: 2px dashed rgba(255,255,255,.45);
      background: rgba(0,0,0,.28);
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
      pointer-events:none;
    }
    body:not(.exporting) .cellLabel.is-empty::after{
      content:"‚úçÔ∏è √âCRIRE ICI";
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      letter-spacing: .6px;
      color: rgba(255,255,255,.70);
      text-shadow: 0 2px 10px rgba(0,0,0,.55);
      -webkit-text-stroke: 0;
      pointer-events:none;
    }
    body.exporting .cellLabel::before,
    body.exporting .cellLabel.is-empty::after{
      display:none !important;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <div class="card sidebar">
      <div class="title">
        <h1>Cr√©ateur d'overlay By Akatsuki Orga.</h1>
        <div class="badge">‚òÅÔ∏èü©∏ Akatsuki</div>
      </div>

      <div class="section">
        <label>üñºÔ∏è 1) Image de fond</label>
        <input id="bgInput" type="file" accept="image/*" />
        <div class="row" style="margin-top:10px;">
          <a class="btn primary" href="https://chatgpt.com" target="_blank" rel="noopener">
            ‚ú® Cr√©er mon fond sur chatgpt.com
          </a>
          <button class="btn" id="clearBg">Retirer le fond</button>
        </div>
        <div class="hint">‚òÅÔ∏èü©∏ Conseil : 1920√ó1080 (ou +) pour un rendu net.</div>
      </div>

      <div class="section">
        <label>üéÅ 2) Choisir un cadeau</label>
        <select id="giftSelect"></select>

        <div class="row" style="margin-top:10px;">
          <label style="display:flex;align-items:center;gap:10px;margin:0;color:rgba(255,255,255,.82);">
            <input type="checkbox" id="visibleGiftMenu" />
            üîÜ Menu cadeau plus visible
          </label>
        </div>

        <div class="giftPreview">
          <div class="thumb" id="giftThumb"></div>
          <div class="meta">
            <div class="name" id="giftName">Aucun cadeau s√©lectionn√©</div>
            <div class="sub">Clique une case ‚Ä¢ <span class="kbd">Double-clic</span> = retirer</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="deselect">D√©s√©lectionner</button>
        </div>

        <div class="hint">
          ‚úÖ PNG en racine (m√™me dossier que <b>index.html</b>) : <span class="kbd">./rose.png</span> etc.
        </div>
      </div>

      <div class="section">
        <label>üßä 3) R√©glages des cases ‚Äúverre‚Äù</label>

        <div class="row" style="width:100%;">
          <div style="flex:1; min-width: 150px;">
            <label style="margin-bottom:6px;">Disposition</label>
            <select id="layout">
              <option value="3x2">3 colonnes √ó 2 lignes (6)</option>
              <option value="5x2">5 colonnes √ó 2 lignes (10)</option>
              <option value="5x3" selected>5 colonnes √ó 3 lignes (15)</option>
              <option value="6x3">6 colonnes √ó 3 lignes (18)</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label>üå´Ô∏è Flou : <span id="blurVal">16</span>px</label>
          <input id="blur" type="range" min="0" max="30" value="16" />
        </div>

        <div style="margin-top:12px;">
          <label>‚≠ï Arrondi : <span id="roundVal">22</span>px</label>
          <input id="round" type="range" min="8" max="40" value="22" />
        </div>

        <div class="hint">
          ü©∏ Choisis un cadeau ‚Üí clique une case.<br/>
          ‚úçÔ∏è Pour √©crire sous une case : <span class="kbd">clic droit</span> sur la case (ou <span class="kbd">Ctrl</span>+clic).
        </div>
      </div>

      <div class="section">
        <label>üßπ 4) Actions</label>
        <div class="row">
          <button class="btn danger" id="resetGrid">Vider toutes les cases</button>
          <button class="btn primary" id="exportPng">Exporter en PNG</button>
        </div>
        <div class="hint">
          ‚úÖ Export stable : l‚Äôeffet glace est pr√©-rendu (canvas) donc identique au PNG.
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <div class="stage-wrap">
        <div class="stage-toolbar">
          <div class="footer-note">
            ‚òÅÔ∏èü©∏ Cadeau : clique une case ‚Ä¢ <span class="kbd">Double-clic</span> pour supprimer ‚Ä¢
            ‚úçÔ∏è Texte : <span class="kbd">clic droit</span> (ou <span class="kbd">Ctrl</span>+clic)
          </div>
        </div>

        <div class="stage" id="stage">
          <div class="bg" id="bg"></div>
          <div class="vignette"></div>
          <div class="grid" id="grid"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * ‚úÖ Tes fichiers en RACINE (m√™me niveau que index.html)
     * (j‚Äôai gard√© le principe : tu peux remettre ta liste compl√®te si besoin)
     */
    const GIFTS = [
      { name: "rose ü™ô 1", file: "rose.png" },
      { name: "basketball ü™ô 1", file: "basketball.png" },
      { name: "coeur nuage ü™ô 1", file: "coeurnuage.png" },
      { name: "Super GG ü™ô 100", file: "supergg.png" },
      { name: "Pluie de m√©t√©ores ü™ô 3000", file: "Pluie de m√©t√©ore.png" },
      // üîÅ Remets ici ta liste compl√®te (inchang√©e) si tu veux tout
    ];

    const state = {
      selectedGiftUrl: null,
      selectedGiftName: null,

      cells: [],
      labels: [],

      cols: 5,
      rows: 3,
      blur: 16,
      round: 22,
      gap: 26,

      bgUrl: null,
      bgImg: null,        // Image() charg√©e
      bgNaturalW: 0,
      bgNaturalH: 0
    };

    // Elements
    const stage = document.getElementById('stage');
    const bg = document.getElementById('bg');
    const grid = document.getElementById('grid');

    const bgInput = document.getElementById('bgInput');
    const clearBgBtn = document.getElementById('clearBg');

    const giftSelect = document.getElementById('giftSelect');
    const giftThumb = document.getElementById('giftThumb');
    const giftName = document.getElementById('giftName');
    const deselectBtn = document.getElementById('deselect');

    const visibleGiftMenu = document.getElementById('visibleGiftMenu');
    const layout = document.getElementById('layout');

    const blurRange = document.getElementById('blur');
    const blurVal = document.getElementById('blurVal');

    const roundRange = document.getElementById('round');
    const roundVal = document.getElementById('roundVal');

    const resetGridBtn = document.getElementById('resetGrid');
    const exportBtn = document.getElementById('exportPng');

    // ---------- Utils
    function setCSSVars(){
      document.documentElement.style.setProperty('--cols', state.cols);
      document.documentElement.style.setProperty('--gap', state.gap + 'px');
      document.documentElement.style.setProperty('--r', state.round + 'px');
      blurVal.textContent = state.blur;
      roundVal.textContent = state.round;
    }

    function parseCoinsFromName(name){
      const m = name.match(/ü™ô\s*(\d+)/);
      return m ? Number(m[1]) : Number.POSITIVE_INFINITY;
    }

    function getSortedGiftIndexes(){
      return GIFTS
        .map((g, idx) => ({ idx, coins: parseCoinsFromName(g.name), name: g.name }))
        .sort((a, b) => (a.coins - b.coins) || a.name.localeCompare(b.name, 'fr'))
        .map(x => x.idx);
    }

    function renderGiftSelect(){
      giftSelect.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '‚Äî Aucun (d√©s√©lectionn√©) ‚Äî';
      giftSelect.appendChild(opt0);

      const sortedIdx = getSortedGiftIndexes();
      sortedIdx.forEach((idx) => {
        const g = GIFTS[idx];
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = `üéÅ ${g.name}`;
        giftSelect.appendChild(opt);
      });
    }

    function renderGiftPreview(){
      giftThumb.innerHTML = '';
      if(!state.selectedGiftUrl){
        giftName.textContent = "Aucun cadeau s√©lectionn√©";
        return;
      }
      giftName.textContent = state.selectedGiftName || "Cadeau";
      const img = document.createElement('img');
      img.src = state.selectedGiftUrl;
      img.alt = state.selectedGiftName || "cadeau";
      giftThumb.appendChild(img);
    }

    function setSelectedGift(gift){
      if(!gift){
        state.selectedGiftUrl = null;
        state.selectedGiftName = null;
        renderGiftPreview();
        renderGrid();
        return;
      }
      state.selectedGiftUrl = `./${gift.file}`;
      state.selectedGiftName = gift.name;
      renderGiftPreview();
      renderGrid();
    }

    function ensureArraysSize(){
      const total = state.cols * state.rows;

      if(state.cells.length !== total){
        const old = state.cells.slice();
        state.cells = new Array(total).fill(null);
        for(let i=0; i<Math.min(old.length, total); i++) state.cells[i] = old[i];
      }

      if(state.labels.length !== total){
        const old = state.labels.slice();
        state.labels = new Array(total).fill('');
        for(let i=0; i<Math.min(old.length, total); i++) state.labels[i] = old[i] || '';
      }
    }

    // ---------- Sizing (fix 5x3 trop grand)
    function applySizing(){
      const inset = (window.innerWidth <= 980) ? 18 : 40;
      const stageW = stage.clientWidth;
      const stageH = stage.clientHeight;

      const availW = Math.max(200, stageW - inset * 2);
      const availH = Math.max(200, stageH - inset * 2);

      const cols = state.cols;
      const rows = state.rows;

      // place du label sous chaque case
      const labelSpace = 56;

      // on choisit un gap de d√©part, puis on ajuste
      let gap = 22;

      const cellW = Math.floor((availW - (cols - 1) * gap) / cols);
      const cellH = Math.floor(((availH - (rows - 1) * gap) / rows) - labelSpace);
      let cell = Math.min(cellW, cellH);

      const minCell = (window.innerWidth <= 980) ? 92 : 110;
      const maxCell = 190;
      cell = Math.max(minCell, Math.min(maxCell, cell));

      gap = Math.round(Math.max(14, Math.min(34, cell * 0.14)));

      document.documentElement.style.setProperty('--cellSize', cell + 'px');
      state.gap = gap;

      setCSSVars();
    }

    function setLayout(value){
      const [c, r] = value.split('x').map(Number);
      state.cols = c;
      state.rows = r;
      state.cells = new Array(c * r).fill(null);
      state.labels = new Array(c * r).fill('');
      applySizing();
      renderGrid();
      requestAnimationFrame(renderAllGlassTiles);
    }

    // ---------- Background cover params
    function computeCoverParams(){
      if(!state.bgImg || !state.bgNaturalW || !state.bgNaturalH) return null;

      const stageW = stage.clientWidth;
      const stageH = stage.clientHeight;

      const s = Math.max(stageW / state.bgNaturalW, stageH / state.bgNaturalH);
      const drawnW = state.bgNaturalW * s;
      const drawnH = state.bgNaturalH * s;

      const offsetX = (stageW - drawnW) / 2;
      const offsetY = (stageH - drawnH) / 2;

      return { drawnW, drawnH, offsetX, offsetY };
    }

    // ---------- ‚úÖ GLASS RENDER (canvas -> image)
    async function renderAllGlassTiles(){
      const cells = Array.from(grid.querySelectorAll('.cell'));
      if(cells.length === 0) return;

      // si pas de bg: met un fallback doux (toujours exportable)
      if(!state.bgImg){
        cells.forEach(cell => {
          const img = cell.querySelector('.glass-bg img');
          if(img){
            img.src = makeFallbackGlassDataURL(cell.clientWidth + 48, cell.clientHeight + 48);
          }
        });
        return;
      }

      const params = computeCoverParams();
      if(!params) return;

      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1)); // limite pour perf + stabilit√©
      const stageW = stage.clientWidth;
      const stageH = stage.clientHeight;

      // canvas global du fond (cover)
      const stageCanvas = document.createElement('canvas');
      stageCanvas.width = Math.floor(stageW * dpr);
      stageCanvas.height = Math.floor(stageH * dpr);
      const sctx = stageCanvas.getContext('2d', { alpha: true });

      sctx.setTransform(dpr,0,0,dpr,0,0);
      // draw cover
      sctx.drawImage(
        state.bgImg,
        params.offsetX, params.offsetY,
        params.drawnW, params.drawnH
      );

      const stageRect = stage.getBoundingClientRect();
      const pad = 24; // doit matcher .glass-bg inset

      for(const cell of cells){
        const gbImg = cell.querySelector('.glass-bg img');
        if(!gbImg) continue;

        const rect = cell.getBoundingClientRect();
        const left = rect.left - stageRect.left;
        const top  = rect.top  - stageRect.top;

        const w = rect.width;
        const h = rect.height;

        const outW = Math.max(1, Math.floor((w + pad*2) * dpr));
        const outH = Math.max(1, Math.floor((h + pad*2) * dpr));

        const tile = document.createElement('canvas');
        tile.width = outW;
        tile.height = outH;
        const tctx = tile.getContext('2d', { alpha: true });

        // blur en pixels (adapter dpr)
        tctx.filter = `blur(${Math.max(0, state.blur) * dpr}px)`;
        // on pr√©l√®ve un morceau du stageCanvas
        const sx = Math.floor((left - pad) * dpr);
        const sy = Math.floor((top  - pad) * dpr);

        // clamp source
        const csx = Math.max(0, sx);
        const csy = Math.max(0, sy);
        const csw = Math.min(stageCanvas.width - csx, outW - Math.max(0, csx - sx));
        const csh = Math.min(stageCanvas.height - csy, outH - Math.max(0, csy - sy));

        // destination offset si clamp
        const dx = Math.max(0, csx - sx);
        const dy = Math.max(0, csy - sy);

        if(csw > 0 && csh > 0){
          tctx.drawImage(stageCanvas, csx, csy, csw, csh, dx, dy, csw, csh);
        }

        // petit boost de lumi√®re (verre)
        tctx.filter = 'none';
        tctx.globalAlpha = 0.22;
        const g = tctx.createLinearGradient(0,0,outW,outH);
        g.addColorStop(0, 'rgba(255,255,255,.55)');
        g.addColorStop(1, 'rgba(255,255,255,0)');
        tctx.fillStyle = g;
        tctx.fillRect(0,0,outW,outH);
        tctx.globalAlpha = 1;

        gbImg.src = tile.toDataURL('image/png');
      }
    }

    function makeFallbackGlassDataURL(w, h){
      const c = document.createElement('canvas');
      c.width = Math.max(1, Math.floor(w));
      c.height = Math.max(1, Math.floor(h));
      const ctx = c.getContext('2d');

      const g = ctx.createLinearGradient(0,0,c.width,c.height);
      g.addColorStop(0, 'rgba(255,255,255,.20)');
      g.addColorStop(1, 'rgba(255,255,255,.05)');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,c.width,c.height);

      // micro texture
      ctx.globalAlpha = 0.10;
      for(let i=0;i<120;i++){
        ctx.fillStyle = 'rgba(255,255,255,.25)';
        ctx.fillRect(Math.random()*c.width, Math.random()*c.height, 1, 1);
      }
      ctx.globalAlpha = 1;

      return c.toDataURL('image/png');
    }

    // ---------- Labels
    function editLabelAt(index){
      const current = (state.labels[index] || '').toString();
      const next = prompt("Texte sous la case (vide = supprimer) :", current);
      if(next === null) return;
      state.labels[index] = (next || '').trim();
      renderGrid();
      requestAnimationFrame(renderAllGlassTiles);
    }

    // ---------- Grid
    function renderGrid(){
      ensureArraysSize();
      grid.innerHTML = '';

      const total = state.cols * state.rows;

      for(let i=0; i<total; i++){
        const tile = document.createElement('div');
        tile.className = 'tile';

        const cell = document.createElement('div');
        cell.className = 'cell';

        // glass bg image (pre-render)
        const glassBg = document.createElement('div');
        glassBg.className = 'glass-bg';
        const gbImg = document.createElement('img');
        gbImg.alt = 'glass';
        gbImg.src = makeFallbackGlassDataURL(220,220);
        glassBg.appendChild(gbImg);

        const glassTint = document.createElement('div');
        glassTint.className = 'glass-tint';

        const glassShine = document.createElement('div');
        glassShine.className = 'glass-shine';

        const glassEdge = document.createElement('div');
        glassEdge.className = 'glass-edge';

        cell.appendChild(glassBg);
        cell.appendChild(glassTint);
        cell.appendChild(glassShine);
        cell.appendChild(glassEdge);

        const url = state.cells[i];

        if(url){
          const wrap = document.createElement('div');
          wrap.className = 'giftInCell';
          const img = document.createElement('img');
          img.src = url;
          img.alt = 'gift';
          wrap.appendChild(img);
          cell.appendChild(wrap);
        } else {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = state.selectedGiftUrl ? 'Clique pour placer ‚òÅÔ∏è' : 'Choisis un cadeau ü©∏';
          cell.appendChild(empty);
        }

        cell.addEventListener('click', (e) => {
          if(e.ctrlKey || e.metaKey){
            editLabelAt(i);
            return;
          }
          if(!state.selectedGiftUrl) return;
          state.cells[i] = state.selectedGiftUrl;
          renderGrid();
          requestAnimationFrame(renderAllGlassTiles);
        });

        cell.addEventListener('dblclick', () => {
          state.cells[i] = null;
          renderGrid();
          requestAnimationFrame(renderAllGlassTiles);
        });

        cell.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          editLabelAt(i);
        });

        const label = document.createElement('div');
        label.className = 'cellLabel';
        const txt = (state.labels[i] || '').trim();
        if(!txt){
          label.classList.add('is-empty');
          label.textContent = '‚Äî';
        } else {
          label.textContent = txt;
        }
        label.addEventListener('dblclick', () => editLabelAt(i));

        tile.appendChild(cell);
        tile.appendChild(label);
        grid.appendChild(tile);
      }
    }

    // ---------- Background
    async function setBackgroundFromUrl(url){
      state.bgUrl = url;

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        state.bgImg = img;
        state.bgNaturalW = img.naturalWidth;
        state.bgNaturalH = img.naturalHeight;

        bg.style.backgroundImage = `url("${url}")`;
        requestAnimationFrame(() => {
          applySizing();
          renderAllGlassTiles();
        });
      };
      img.onerror = () => {
        // si erreur, on affiche quand m√™me mais sans bgImg -> fallback glass
        state.bgImg = null;
        state.bgNaturalW = 0;
        state.bgNaturalH = 0;

        bg.style.backgroundImage = `url("${url}")`;
        requestAnimationFrame(() => {
          applySizing();
          renderAllGlassTiles();
        });
      };
      img.src = url;
    }

    bgInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      setBackgroundFromUrl(url);
    });

    clearBgBtn.addEventListener('click', () => {
      bg.style.backgroundImage = '';
      bgInput.value = '';
      state.bgUrl = null;
      state.bgImg = null;
      state.bgNaturalW = 0;
      state.bgNaturalH = 0;
      renderAllGlassTiles();
    });

    // ---------- Select
    giftSelect.addEventListener('change', () => {
      const v = giftSelect.value;
      if(v === ''){
        setSelectedGift(null);
        return;
      }
      const idx = Number(v);
      setSelectedGift(GIFTS[idx]);
    });

    deselectBtn.addEventListener('click', () => {
      giftSelect.value = '';
      setSelectedGift(null);
    });

    visibleGiftMenu.addEventListener('change', () => {
      document.body.classList.toggle('high-contrast-select', visibleGiftMenu.checked);
    });

    // ---------- Controls
    layout.addEventListener('change', (e) => setLayout(e.target.value));

    blurRange.addEventListener('input', () => {
      state.blur = Number(blurRange.value);
      setCSSVars();
      requestAnimationFrame(renderAllGlassTiles); // ‚úÖ regen glace
    });

    roundRange.addEventListener('input', () => {
      state.round = Number(roundRange.value);
      setCSSVars();
    });

    resetGridBtn.addEventListener('click', () => {
      state.cells = new Array(state.cols * state.rows).fill(null);
      state.labels = new Array(state.cols * state.rows).fill('');
      renderGrid();
      requestAnimationFrame(renderAllGlassTiles);
    });

    window.addEventListener('resize', () => {
      applySizing();
      requestAnimationFrame(renderAllGlassTiles);
    });

    // ---------- Export PNG (stable)
    async function waitForImages(root){
      const imgs = Array.from(root.querySelectorAll('img'));
      await Promise.all(imgs.map(img => {
        if(img.complete && img.naturalWidth > 0) return Promise.resolve();
        return new Promise(res => {
          img.addEventListener('load', res, { once:true });
          img.addEventListener('error', res, { once:true });
        });
      }));
    }

    function nextFrame(){
      return new Promise(res => requestAnimationFrame(() => res()));
    }

    exportBtn.addEventListener('click', async () => {
      try{
        exportBtn.disabled = true;
        exportBtn.textContent = "‚è≥ Export en cours...";

        // cache les aides
        document.body.classList.add('exporting');

        // ‚úÖ assure que la glace est bien √† jour AVANT capture
        await nextFrame();
        await renderAllGlassTiles();
        await nextFrame();
        await waitForImages(stage);

        const canvas = await html2canvas(stage, {
          backgroundColor: null,
          useCORS: true,
          scale: 2
        });

        const dataUrl = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = `overlay-akatsuki-${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();

      } catch(err){
        alert("Export impossible (v√©rifie que GitHub Pages sert bien les images).");
        console.error(err);
      } finally {
        document.body.classList.remove('exporting');
        exportBtn.disabled = false;
        exportBtn.textContent = "Exporter en PNG";
      }
    });

    // ---------- Init
    renderGiftSelect();

    state.blur = Number(blurRange.value);
    state.round = Number(roundRange.value);

    setCSSVars();
    setLayout(layout.value);

    renderGiftPreview();
    renderGrid();
    applySizing();
    requestAnimationFrame(renderAllGlassTiles);
  </script>
</body>
</html>
