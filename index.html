<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cr√©ateur d'overlay By Akatsuki Orga.</title>

  <!-- Export PNG -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg: #07060a;

      /* Akatsuki palette */
      --red: rgba(255, 60, 90, 1);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);

      /* Transparent menu */
      --menu: rgba(0,0,0,.18);
      --menu2: rgba(0,0,0,.10);

      --strokeRed: rgba(255, 60, 90, .35);

      --shadow: 0 18px 40px rgba(0,0,0,.45);
      --inner: inset 0 1px 0 rgba(255,255,255,.16), inset 0 -18px 40px rgba(0,0,0,.35);
      --r: 22px;

      /* grid vars */
      --cols: 5;
      --blur: 16px;
      --gap: 26px;

      /* default sizing for most layouts */
      --cellMin: 110px;
      --cellMax: 1fr;

      /* special: 3x2 auto-fit */
      --cellSize: 160px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      min-height:100vh;

      background:
        radial-gradient(900px 500px at 70% 15%, rgba(255,60,90,.18), transparent 60%),
        radial-gradient(900px 500px at 20% 75%, rgba(255,255,255,.06), transparent 60%),
        var(--bg);
    }

    .app{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
      padding: 18px;
      max-width: 1400px;
      margin: 0 auto;
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
    }

    /* MENU TRANSPARENT (glass) */
    .card{
      background: linear-gradient(180deg, var(--menu), var(--menu2));
      border: 1px solid var(--strokeRed);
      border-radius: 24px;
      box-shadow: var(--shadow);
      overflow:hidden;

      backdrop-filter: blur(14px) saturate(1.15);
      -webkit-backdrop-filter: blur(14px) saturate(1.15);
    }

    .sidebar{
      padding: 16px;
      position: sticky;
      top: 16px;
      height: fit-content;
    }

    .title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .title h1{
      font-size: 15px;
      line-height: 1.25;
      margin:0;
      letter-spacing:.2px;
    }
    .badge{
      font-size: 12px;
      color: rgba(255,255,255,.82);
      background: rgba(255,60,90,.12);
      border: 1px solid rgba(255,60,90,.35);
      padding: 6px 10px;
      border-radius: 999px;
      box-shadow: 0 0 0 3px rgba(255,60,90,.08);
      white-space:nowrap;
    }

    .section{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,.10);
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 800;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;

      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .btn:hover{
      background: rgba(0,0,0,.28);
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(180deg, rgba(255,60,90,.20), rgba(255,60,90,.10));
      border-color: rgba(255,60,90,.38);
      box-shadow: 0 0 0 3px rgba(255,60,90,.10);
    }
    .btn.primary:hover{ box-shadow: 0 0 0 3px rgba(255,60,90,.16); }

    .btn.danger{
      background: rgba(255,60,90,.12);
      border-color: rgba(255,60,90,.30);
    }

    input[type="file"]{
      width: 100%;
      padding: 10px;
      background: rgba(0,0,0,.18);
      border: 1px dashed rgba(255,255,255,.20);
      border-radius: 14px;
      color: rgba(255,255,255,.70);
    }
    input[type="range"]{ width: 100%; }

    select{
      width: 100%;
      padding: 10px 12px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,60,90,.28);
      border-radius: 14px;
      color: var(--text);
      outline:none;
      box-shadow: 0 0 0 3px rgba(255,60,90,.08);
    }

    .hint{
      font-size: 12px;
      color: rgba(255,255,255,.72);
      line-height: 1.35;
      margin-top: 8px;
    }

    .giftPreview{
      margin-top: 10px;
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    .giftPreview .thumb{
      width: 54px;
      height: 54px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .giftPreview img{
      width: 70%;
      height: 70%;
      object-fit: contain;
      filter: drop-shadow(0 12px 14px rgba(0,0,0,.45));
    }
    .giftPreview .meta{ display:flex; flex-direction:column; gap: 2px; }
    .giftPreview .meta .name{ font-weight: 900; font-size: 13px; }
    .giftPreview .meta .sub{ font-size: 12px; color: rgba(255,255,255,.70); }

    .main{
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 14px;
      min-height: calc(100vh - 36px);
    }

    .stage-wrap{ display:flex; flex-direction:column; gap: 10px; }
    .stage-toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }

    .footer-note{
      font-size: 12px;
      color: rgba(255,255,255,.75);
      opacity:.98;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New";
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,60,90,.30);
      background: rgba(255,60,90,.10);
      color: rgba(255,255,255,.88);
    }

    .stage{
      position:relative;
      border-radius: 26px;
      border: 1px solid rgba(255,60,90,.24);
      overflow:hidden;
      min-height: 560px;
      box-shadow: var(--shadow);
      background: rgba(0,0,0,.25);
    }

    .bg{
      position:absolute; inset:0;
      background-size: cover;
      background-position:center;
      filter: saturate(1.1) contrast(1.02);
      transform: scale(1.02);
    }

    .vignette{
      position:absolute; inset:0;
      background: radial-gradient(1200px 700px at 50% 35%, transparent 40%, rgba(0,0,0,.40) 100%);
      pointer-events:none;
    }

    .grid{
      position:absolute; inset: 40px;
      display:grid;
      gap: var(--gap);
      align-content:center;
      justify-content:center;
      grid-template-columns: repeat(var(--cols), minmax(var(--cellMin), var(--cellMax)));
    }
    @media (max-width: 980px){
      .grid{ inset: 18px; }
    }

    /* ‚úÖ layout 3x2: taille auto-fit (via --cellSize) */
    .grid.is-3x2{
      grid-template-columns: repeat(3, var(--cellSize));
    }

    .cell{
      aspect-ratio: 1 / 1;
      border-radius: var(--r);
      position:relative;
      overflow:hidden;
      cursor:pointer;

      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 30px rgba(0,0,0,.42), var(--inner);

      /* IMPORTANT: on ne d√©pend plus de backdrop-filter (export stable) */
      background: rgba(255,255,255,.10);
    }

    /* ‚úÖ Faux glass blur capturable par html2canvas */
    .cell .glass-bg{
      position:absolute;
      inset: -18px; /* marge pour √©viter les bords du blur */
      background-repeat: no-repeat;
      transform: scale(1.08);
      filter: blur(var(--blur)) saturate(1.15);
      opacity: .85;
    }

    /* texture ‚Äúverre‚Äù par-dessus */
    .cell .glass-tint{
      position:absolute;
      inset:0;
      border-radius: var(--r);
      background: linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
      pointer-events:none;
    }

    /* reflet en coin */
    .cell .glass-shine{
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(220px 220px at 15% 10%, rgba(255,255,255,.28), transparent 55%),
        linear-gradient(135deg, rgba(255,255,255,.18), transparent 40%);
      opacity: .55;
      pointer-events:none;
    }

    /* highlight bord */
    .cell .glass-edge{
      position:absolute; inset:0;
      border-radius: var(--r);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.22);
      pointer-events:none;
    }

    .cell:hover{
      border-color: rgba(255,60,90,.35);
      box-shadow: 0 14px 30px rgba(0,0,0,.42), var(--inner), 0 0 0 3px rgba(255,60,90,.10);
    }

    .cell .giftInCell{
      position:absolute; inset: 16%;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .cell .giftInCell img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 16px 18px rgba(0,0,0,.50));
    }

    .cell .empty{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      color: rgba(255,255,255,.58);
      pointer-events:none;
      text-align:center;
      padding: 10px;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <div class="card sidebar">
      <div class="title">
        <h1>Cr√©ateur d'overlay By Akatsuki Orga.</h1>
        <div class="badge">‚òÅÔ∏èü©∏ Akatsuki</div>
      </div>

      <div class="section">
        <label>üñºÔ∏è 1) Image de fond</label>
        <input id="bgInput" type="file" accept="image/*" />
        <div class="row" style="margin-top:10px;">
          <a class="btn primary" href="https://chatgpt.com" target="_blank" rel="noopener">
            ‚ú® Cr√©er mon fond sur chatgpt.com
          </a>
          <button class="btn" id="clearBg">Retirer le fond</button>
        </div>
        <div class="hint">‚òÅÔ∏èü©∏ Conseil : 1920√ó1080 (ou +) pour un rendu net.</div>
      </div>

      <div class="section">
        <label>üéÅ 2) Choisir un cadeau</label>
        <select id="giftSelect"></select>

        <div class="giftPreview">
          <div class="thumb" id="giftThumb"></div>
          <div class="meta">
            <div class="name" id="giftName">Aucun cadeau s√©lectionn√©</div>
            <div class="sub">Clique une case ‚Ä¢ <span class="kbd">Double-clic</span> = retirer</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="deselect">D√©s√©lectionner</button>
        </div>

        <div class="hint">
          ‚úÖ PNG en racine (m√™me dossier que <b>index.html</b>) : <span class="kbd">./rose.png</span> etc.
        </div>
      </div>

      <div class="section">
        <label>üßä 3) R√©glages des cases ‚Äúverre‚Äù</label>

        <div class="row" style="width:100%;">
          <div style="flex:1; min-width: 150px;">
            <label style="margin-bottom:6px;">Disposition</label>
            <select id="layout">
              <option value="3x2">3 colonnes √ó 2 lignes (6)</option>
              <option value="5x2">5 colonnes √ó 2 lignes (10)</option>
              <option value="5x3" selected>5 colonnes √ó 3 lignes (15)</option>
              <option value="6x3">6 colonnes √ó 3 lignes (18)</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label>üå´Ô∏è Flou : <span id="blurVal">16</span>px</label>
          <input id="blur" type="range" min="0" max="30" value="16" />
        </div>

        <div style="margin-top:12px;">
          <label>‚≠ï Arrondi : <span id="roundVal">22</span>px</label>
          <input id="round" type="range" min="8" max="40" value="22" />
        </div>

        <div class="hint">ü©∏ Choisis un cadeau ‚Üí clique une case.</div>
      </div>

      <div class="section">
        <label>üßπ 4) Actions</label>
        <div class="row">
          <button class="btn danger" id="resetGrid">Vider toutes les cases</button>
          <button class="btn primary" id="exportPng">Exporter en PNG</button>
        </div>
        <div class="hint">
          ‚úÖ Export fid√®le : m√™me rendu que l‚Äô√©cran (blur stable).
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <div class="stage-wrap">
        <div class="stage-toolbar">
          <div class="footer-note">
            ‚òÅÔ∏èü©∏ Clique un cadeau ‚Üí clique une case ‚Ä¢ <span class="kbd">Double-clic</span> pour supprimer
          </div>
        </div>

        <div class="stage" id="stage">
          <div class="bg" id="bg"></div>
          <div class="vignette"></div>
          <div class="grid" id="grid"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * ‚úÖ Tes fichiers en RACINE (m√™me niveau que index.html)
     */
    const GIFTS = [
  { name: "9 queues", file: "9 queues.png" },
  { name: "2026", file: "2026.png" },
  { name: "adore", file: "adore.png" },
  { name: "Aile de papillon", file: "Aile de papillon.png" },
  { name: "ailes f√©e", file: "ailesfee.png" },
  { name: "Air drop", file: "Air drop.png" },
  { name: "Ami Fruit√©s", file: "Ami Fruit√©s.png" },
  { name: "amour langue signe", file: "amourlanguesigne.png" },
  { name: "Animal Band", file: "Animal Band.png" },
  { name: "Arbre √† diamants", file: "Arbre √† diamants.png" },
  { name: "arc amour", file: "arcamour.png" },
  { name: "arc en ciel", file: "arcenciel.png" },
  { name: "asmr time", file: "asmrtime.png" },
  { name: "bagel", file: "bagel.png" },
  { name: "baking monkey", file: "baking monkey.png" },
  { name: "Baleine", file: "Baleine.png" },
  { name: "ballon amour", file: "ballonamour.png" },
  { name: "Bar √† citron", file: "Bar √† citron.png" },
  { name: "basketball", file: "basketball.png" },
  { name: "Batterie", file: "Batterie.png" },
  { name: "Bear Blind Box", file: "Bear Blind Box.Png" },
  { name: "Become Kitten", file: "Become Kitten.png" },
  { name: "Berry", file: "Berry.png" },
  { name: "Bisous Loutre", file: "Bisous Loutre.png" },
  { name: "bisous", file: "bisous.png" },
  { name: "bubblegum", file: "bubblegum.png" },
  { name: "calin de teddy", file: "calin de teddy.png" },
  { name: "Camion de glace", file: "Camion de glace.png" },
  { name: "capybara", file: "capybara.png" },
  { name: "Carrousel", file: "Carrousel.png" },
  { name: "carte de voeux", file: "carte de voeux.png" },
  { name: "casquette", file: "casquette.png" },
  { name: "Chaise Gaming", file: "Chaise Gaming.png" },
  { name: "chapeau moustache", file: "chapeaumoustache.png" },
  { name: "chaton", file: "chaton.png" },
  { name: "cheers", file: "cheers.png" },
  { name: "chenille dodo", file: "chenilledodo.png" },
  { name: "citronnade", file: "citronnade.png" },
  { name: "citrouille", file: "citrouille.png" },
  { name: "Clavier gamer", file: "Clavier gamer.png" },
  { name: "cochon amoureux", file: "cochonamoureux.Png" },

  { name: "Coeur bisous", file: "Coeur bisous.png" },
  { name: "Coeur Uni", file: "Coeur Uni.png" },
  { name: "coeur avec les mains", file: "coeuraveclesmains.png" },
  { name: "Coeur dans les mains", file: "Coeurdanslesmains.png" },
  { name: "coeur doigt", file: "coeurdoigt.png" },
  { name: "coeur du jour", file: "coeurdujour.png" },
  { name: "coeur en flammes", file: "coeureenflammes.png" },
  { name: "coeur nuage", file: "coeurnuage.png" },

  { name: "collier ami", file: "collierami.png" },
  { name: "Concert de Rosie", file: "Concert de Rosie.png" },
  { name: "confetti", file: "confetti.png" },
  { name: "Cool", file: "Cool.png" },
  { name: "Cooper", file: "Cooper.png" },
  { name: "coquillage", file: "coquillage.png" },
  { name: "corail", file: "corail.png" },
  { name: "corgi", file: "corgi.png" },
  { name: "Cote √† cote", file: "Coteacote.png" },
  { name: "Couple puissant", file: "Couple puissant.png" },
  { name: "couronnes de cristal", file: "couronnes de cristal.png" },
  { name: "Couronnes Dragon", file: "Couronnes Dragon.png" },
  { name: "couronnes TikTok", file: "couronnes TikTok.png" },
  { name: "crabe", file: "crabe.png" },
  { name: "Crini√®re lion", file: "Crini√®re lion.png" },
  { name: "cygne", file: "cygne.png" },
  { name: "Dancing Bear", file: "Dancing Bear.png" },
  { name: "D√©but de course", file: "D√©but de course.png" },
  { name: "diademe", file: "diademe.png" },
  { name: "Diamond gun", file: "Diamond gun.png" },
  { name: "dinocap", file: "dinocap.png" },
  { name: "Dj glasses", file: "Dj glasses.Png" },
  { name: "donuts", file: "donuts.png" },
  { name: "Drift", file: "Drift.png" },
  { name: "eclair", file: "eclair.png" },
  { name: "elie et l'√©l√©phant", file: "elie et l'√©l√©phant.webp" },
  { name: "Elise l'√©l√©phant", file: "Elise l'√©l√©phant.Png" },
  { name: "empreintedino", file: "empreintedino.png" },
  { name: "etoile √©tincelante", file: "etoileetincelante.png" },
  { name: "famille", file: "famille.png" },
  { name: "Feu d'artifice", file: "Feu d'artifice.png" },
  { name: "Fire up", file: "Fire up.png" },
  { name: "fistbump", file: "fistbump.png" },

  { name: "flamant rose", file: "flamant rose.Png" },
  { name: "flamme de dragon", file: "flamme de dragon.png" },
  { name: "fleurs", file: "fleurs.png" },
  { name: "Futur", file: "Futur.png" },
  { name: "Galaxie", file: "Galaxie.png" },
  { name: "Gaming Bear", file: "Gaming Bear.png" },
  { name: "gant de boxe", file: "gantdeboxe.png" },
  { name: "gant dor√©e", file: "gantdor√©e.png" },
  { name: "gateau anniv", file: "gateauanniv.png" },
  { name: "gateau part", file: "gateaupart.png" },
  { name: "gg", file: "gg.png" },
  { name: "Girafe", file: "Girafe.Png" },
  { name: "glace", file: "glace.png" },
  { name: "glow", file: "glow.png" },
  { name: "Grande Roses", file: "Grande Roses.png" },
  { name: "grue", file: "grue.png" },
  { name: "heartlytalyk", file: "heartlytalyk.png" },
  { name: "ice-cream", file: "ice-cream.png" },
  { name: "Jet volant", file: "Jet volant.png" },
  { name: "jetaime", file: "jetaime.png" },
  { name: "journepass", file: "journepass.png" },
  { name: "juicysmile", file: "juicysmile.png" },
  { name: "jusdecoco", file: "jusdecoco.png" },
  { name: "Leon le chaton", file: "Leon le chaton.png" },
  { name: "Loup d'arabie", file: "Loup D'arabie.png" },
  { name: "lovepainting", file: "lovepainting.png" },
  { name: "loveyou", file: "loveyou.png" },
  { name: "lunettes de soleil", file: "lunettesdesoleil.png" },
  { name: "magieducafe", file: "magieducafe.png" },
  { name: "mainrose", file: "mainrose.png" },
  { name: "mamamia", file: "mamamia.png" },
  { name: "Manettes", file: "Manettes.png" },
  { name: "Manifestation XXL", file: "Manifestation XXL.png" },
  { name: "Marked With love", file: "Marked With love.png" },
  { name: "marquedamour", file: "marquedamour.png" },
  { name: "masque pharaon", file: "masque pharaon.png" },
  { name: "masque", file: "masque.png" },
  { name: "megaphone", file: "megaphone.png" },
  { name: "Money Gun", file: "Money Gun.png" },
  { name: "Money Magnet", file: "Money Magnet.png" },
  { name: "Mongolfiere", file: "Mongolfiere.Png" },

  { name: "Moonlight Flower", file: "Moonlight Flower.png" },
  { name: "Moto", file: "Moto.png" },
  { name: "noeud papillon", file: "noeudpapillon.png" },
  { name: "Oie d√©tendu", file: "Oie d√©tendu.png" },
  { name: "oiseau", file: "oiseau.png" },
  { name: "Ours qui skie", file: "Ours qui skie.png" },
  { name: "ours rythmic", file: "ours rythmic.png" },
  { name: "ours de rose", file: "oursderose.png" },
  { name: "ourson", file: "ourson.png" },
  { name: "pandaclimb", file: "pandaclimb.png" },
  { name: "Papillon", file: "Papillon.png" },
  { name: "parfum", file: "parfum.png" },
  { name: "Party Bus", file: "Party Bus.png" },
  { name: "Patate qui flotte", file: "Patate qui flotte.png" },
  { name: "peche", file: "peche.png" },
  { name: "99ü™ô Petite couronne", file: "petitecouronne.png" },
  { name: "249ü™ô Pingouin qui surf", file: "pingouinsurf.png" },
  { name: "3000ü™ôPluie de m√©t√©ores", file: "Pluie de m√©t√©ore.png" },
  { name: "1ü™ô Pneu", file: "pneu.png" },
  { name: "500ü™ô Polaris", file: "Polaris.png" },
  { name: "149ü™ô Popcorn", file: "popcorn.png" },
  { name: "1ü™ô Populaire", file: "populaire.png" },
  { name: "199ü™ô Positivit√©", file: "positivit√©.png" },
  { name: "2ü™ô Pouce vers le haut", file: "pouceverslehaut.png" },
  { name: "299ü™ô Poulet espi√®gles", file: "Poulet espi√®gles.png" },
  { name: "199ü™ô Poulpe", file: "poulpe.png" },
  { name: "1500ü™ô Poursuit tes r√™ves", file: "Poursuit tes reves.png" },
  { name: "500ü™ô Prince", file: "Prince.png" },
  { name: "4888ü™ô Jet Priv√©", file: "Private Jet.png" },
  { name: "299ü™ô Bisous Chiot", file: "Puppy kiss.png" },
  { name: "1200ü™ô Refuge de l'amour", file: "Refude de l'amour.png" },
  { name: "399ü™ô Rocky Rockeur", file: "Rocky.png" },
  { name: "10ü™ô Rosa", file: "rosa.png" },
  { name: "399ü™ôRose √† jamais", file: "Rose √† jamais.png" },
  { name: "Rose pour toi", file: "Rose pour toi.png" },
  { name: "rose", file: "rose.png" },
  { name: "rose blanche", file: "roseblanche.png" },
  { name: "sage intelligent", file: "sage intelligent.png" },
  { name: "Sage Smash", file: "Sage Smash.png" },
  { name: "slay", file: "slay.png" },
  { name: "Sous contr√¥les", file: "Sous contr√¥les.Png" },

  { name: "Space Cat", file: "Space Cat.png" },
  { name: "Space dog", file: "Space dog.png" },
  { name: "steven", file: "steven.png" },
  { name: "sundaybowl", file: "sundaybowl.png" },
  { name: "supergg", file: "supergg.png" },
  { name: "super populaire", file: "superpopulaire.png" },
  { name: "taureau", file: "taureau.Png" },
  { name: "tcheck", file: "tcheck.png" },
  { name: "tiktok", file: "tiktok.png" },
  { name: "tofu", file: "tofu.png" },
  { name: "tomtomate", file: "tomtomate.png" },
  { name: "ton concert", file: "ton concert.png" },
  { name: "Train", file: "Train.png" },
  { name: "transfo patate", file: "transfopatate.png" },
  { name: "trompe d'√©l√©phant", file: "trompe d'√©l√©phant.png" },
  { name: "Troph√©e Basket", file: "Troph√©e Basket.png" },
  { name: "umake me so happy", file: "umakemesohappy.png" },
  { name: "Vaisseau de Level", file: "Vaisseau de Level.png" },
  { name: "Vaisseau spatial", file: "Vaisseau spacial.png" },
  { name: "Voyage avec toi", file: "Voyage avec toi.png" },
  { name: "winning wednesday", file: "winningwednesday.png" },
  { name: "XXL flower", file: "XXL flower.png" },
  { name: "you are my jam", file: "youaremyjam.png" },
  { name: "you are my roll", file: "youaremyroll.png" }
];

    const state = {
      selectedGiftUrl: null,
      selectedGiftName: null,
      cells: [],
      cols: 5,
      rows: 3,
      blur: 16,
      round: 22,
      gap: 26,

      // background (for accurate faux blur alignment)
      bgUrl: null,
      bgNaturalW: 0,
      bgNaturalH: 0
    };

    // Elements
    const stage = document.getElementById('stage');
    const bg = document.getElementById('bg');
    const grid = document.getElementById('grid');

    const bgInput = document.getElementById('bgInput');
    const clearBgBtn = document.getElementById('clearBg');

    const giftSelect = document.getElementById('giftSelect');
    const giftThumb = document.getElementById('giftThumb');
    const giftName = document.getElementById('giftName');
    const deselectBtn = document.getElementById('deselect');

    const layout = document.getElementById('layout');

    const blurRange = document.getElementById('blur');
    const blurVal = document.getElementById('blurVal');

    const roundRange = document.getElementById('round');
    const roundVal = document.getElementById('roundVal');

    const resetGridBtn = document.getElementById('resetGrid');
    const exportBtn = document.getElementById('exportPng');

    // --------- Utilities
    function setCSSVars(){
      document.documentElement.style.setProperty('--cols', state.cols);
      document.documentElement.style.setProperty('--blur', state.blur + 'px');
      document.documentElement.style.setProperty('--r', state.round + 'px');
      document.documentElement.style.setProperty('--gap', state.gap + 'px');

      blurVal.textContent = state.blur;
      roundVal.textContent = state.round;
    }

    function setSelectedGift(gift){
      if(!gift){
        state.selectedGiftUrl = null;
        state.selectedGiftName = null;
        renderGiftPreview();
        renderGrid();
        return;
      }
      state.selectedGiftUrl = `./${gift.file}`; // RACINE
      state.selectedGiftName = gift.name;
      renderGiftPreview();
      renderGrid();
    }

    function renderGiftSelect(){
      giftSelect.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '‚Äî Aucun (d√©s√©lectionn√©) ‚Äî';
      giftSelect.appendChild(opt0);

      GIFTS.forEach((g, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = `üéÅ ${g.name}`;
        giftSelect.appendChild(opt);
      });
    }

    function renderGiftPreview(){
      giftThumb.innerHTML = '';
      if(!state.selectedGiftUrl){
        giftName.textContent = "Aucun cadeau s√©lectionn√©";
        return;
      }
      giftName.textContent = state.selectedGiftName || "Cadeau";
      const img = document.createElement('img');
      img.src = state.selectedGiftUrl;
      img.alt = state.selectedGiftName || "cadeau";
      giftThumb.appendChild(img);
    }

    // --------- Layout sizing
    function apply3x2Sizing(){
      // calcule un cellSize qui ‚Äúrentre bien‚Äù sans prendre toute l‚Äôimage
      // on utilise l‚Äôinset du grid (40px *2)
      const inset = (window.innerWidth <= 980) ? 18 : 40;
      const stageW = stage.clientWidth;
      const stageH = stage.clientHeight;

      const availW = Math.max(200, stageW - inset * 2);
      const availH = Math.max(200, stageH - inset * 2);

      // on veut que la grille reste "compacte" => gap d√©pend de la taille
      // target cellSize bas√© sur la place dispo, mais on plafonne
      let cell = Math.floor(Math.min(availW / 3, availH / 2));
      cell = Math.min(cell, 210);  // pas √©norme
      cell = Math.max(cell, 120);  // pas minuscule

      const gap = Math.floor(cell * 0.16); // harmonieux

      document.documentElement.style.setProperty('--cellSize', cell + 'px');
      state.gap = gap;
      setCSSVars();
    }

    function setLayout(value){
      const [c, r] = value.split('x').map(Number);
      state.cols = c;
      state.rows = r;

      // grid class
      grid.classList.toggle('is-3x2', (c === 3 && r === 2));

      // gap default
      state.gap = 26;

      // reset cells
      state.cells = new Array(c * r).fill(null);
      setCSSVars();

      // apply special sizing for 3x2
      if(c === 3 && r === 2){
        apply3x2Sizing();
      }

      renderGrid();
      requestAnimationFrame(updateGlassAlignment);
    }

    // --------- Faux blur alignment
    function computeCoverParams(){
      // calcule le rendu "cover center" du background (pour aligner le flou)
      if(!state.bgUrl || !state.bgNaturalW || !state.bgNaturalH){
        return null;
      }
      const stageW = stage.clientWidth;
      const stageH = stage.clientHeight;

      const s = Math.max(stageW / state.bgNaturalW, stageH / state.bgNaturalH);
      const drawnW = state.bgNaturalW * s;
      const drawnH = state.bgNaturalH * s;

      const offsetX = (stageW - drawnW) / 2;
      const offsetY = (stageH - drawnH) / 2;

      return { drawnW, drawnH, offsetX, offsetY };
    }

    function updateGlassAlignment(){
      // met √† jour le background-position/size de chaque .glass-bg
      const params = computeCoverParams();
      const cells = grid.querySelectorAll('.cell');

      // si pas de background : on met un fallback neutre
      if(!params){
        cells.forEach(cell => {
          const gb = cell.querySelector('.glass-bg');
          if(!gb) return;
          gb.style.backgroundImage = '';
          gb.style.background = 'linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.04))';
        });
        return;
      }

      const stageRect = stage.getBoundingClientRect();

      cells.forEach(cell => {
        const gb = cell.querySelector('.glass-bg');
        if(!gb) return;

        const rect = cell.getBoundingClientRect();
        const left = rect.left - stageRect.left;
        const top  = rect.top  - stageRect.top;

        gb.style.background = 'none';
        gb.style.backgroundImage = `url("${state.bgUrl}")`;
        gb.style.backgroundSize = `${params.drawnW}px ${params.drawnH}px`;
        // position du bg dans la case (align√© comme le background global)
        gb.style.backgroundPosition = `${params.offsetX - left}px ${params.offsetY - top}px`;
      });
    }

    // --------- Grid render
    function renderGrid(){
      grid.innerHTML = '';
      const total = state.cols * state.rows;

      for(let i=0; i<total; i++){
        const cell = document.createElement('div');
        cell.className = 'cell';

        // glass layers (always present to ensure export matches)
        const glassBg = document.createElement('div');
        glassBg.className = 'glass-bg';

        const glassTint = document.createElement('div');
        glassTint.className = 'glass-tint';

        const glassShine = document.createElement('div');
        glassShine.className = 'glass-shine';

        const glassEdge = document.createElement('div');
        glassEdge.className = 'glass-edge';

        cell.appendChild(glassBg);
        cell.appendChild(glassTint);
        cell.appendChild(glassShine);
        cell.appendChild(glassEdge);

        const url = state.cells[i];

        if(url){
          const wrap = document.createElement('div');
          wrap.className = 'giftInCell';

          const img = document.createElement('img');
          img.src = url;
          img.alt = 'gift';

          wrap.appendChild(img);
          cell.appendChild(wrap);
        } else {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = state.selectedGiftUrl ? 'Clique pour placer ‚òÅÔ∏è' : 'Choisis un cadeau ü©∏';
          cell.appendChild(empty);
        }

        cell.addEventListener('click', () => {
          if(!state.selectedGiftUrl) return;
          state.cells[i] = state.selectedGiftUrl;
          renderGrid();
          requestAnimationFrame(updateGlassAlignment);
        });

        cell.addEventListener('dblclick', () => {
          state.cells[i] = null;
          renderGrid();
          requestAnimationFrame(updateGlassAlignment);
        });

        grid.appendChild(cell);
      }

      // align after DOM ready
      requestAnimationFrame(updateGlassAlignment);
    }

    // --------- Background upload
    async function setBackgroundFromUrl(url){
      state.bgUrl = url;

      // load natural size for correct cover calc
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        state.bgNaturalW = img.naturalWidth;
        state.bgNaturalH = img.naturalHeight;

        bg.style.backgroundImage = `url("${url}")`;
        requestAnimationFrame(updateGlassAlignment);
      };
      img.onerror = () => {
        // even if we can't read natural size, still set bg
        bg.style.backgroundImage = `url("${url}")`;
        state.bgNaturalW = 0;
        state.bgNaturalH = 0;
        requestAnimationFrame(updateGlassAlignment);
      };
      img.src = url;
    }

    bgInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      setBackgroundFromUrl(url);
    });

    clearBgBtn.addEventListener('click', () => {
      bg.style.backgroundImage = '';
      bgInput.value = '';
      state.bgUrl = null;
      state.bgNaturalW = 0;
      state.bgNaturalH = 0;
      requestAnimationFrame(updateGlassAlignment);
    });

    // --------- Gift selection
    giftSelect.addEventListener('change', () => {
      const v = giftSelect.value;
      if(v === ''){
        setSelectedGift(null);
        return;
      }
      const idx = Number(v);
      setSelectedGift(GIFTS[idx]);
    });

    deselectBtn.addEventListener('click', () => {
      giftSelect.value = '';
      setSelectedGift(null);
    });

    // --------- Controls
    layout.addEventListener('change', (e) => setLayout(e.target.value));

    blurRange.addEventListener('input', (e) => {
      state.blur = Number(e.target.value);
      setCSSVars();
      requestAnimationFrame(updateGlassAlignment);
    });

    roundRange.addEventListener('input', (e) => {
      state.round = Number(e.target.value);
      setCSSVars();
    });

    resetGridBtn.addEventListener('click', () => {
      state.cells = new Array(state.cols * state.rows).fill(null);
      renderGrid();
    });

    // resize: keep faux blur aligned + 3x2 sizing responsive
    window.addEventListener('resize', () => {
      if(state.cols === 3 && state.rows === 2){
        apply3x2Sizing();
      }
      requestAnimationFrame(updateGlassAlignment);
    });

    // --------- Export PNG (now stable)
    exportBtn.addEventListener('click', async () => {
      try{
        exportBtn.disabled = true;
        exportBtn.textContent = "‚è≥ Export en cours...";

        // ensure alignment is up-to-date
        updateGlassAlignment();

        const canvas = await html2canvas(stage, {
          backgroundColor: null,
          useCORS: true,
          scale: 2
        });

        const dataUrl = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = `overlay-akatsuki-${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch(err){
        alert("Export impossible (v√©rifie que GitHub Pages sert bien les images).");
        console.error(err);
      } finally {
        exportBtn.disabled = false;
        exportBtn.textContent = "Exporter en PNG";
      }
    });

    // --------- Init
    renderGiftSelect();
    setLayout(layout.value);

    state.blur = Number(blurRange.value);
    state.round = Number(roundRange.value);
    setCSSVars();

    renderGiftPreview();
    renderGrid();

    // Optionnel : si tu veux une image par d√©faut depuis la racine :
    // setBackgroundFromUrl("./tonfond.png");
  </script>
</body>
</html>

